$(document).ready(function(){var A="AhJFIXaWTfryahNRyQFR6gKLDqmxB34-FGH6VB5VYas4YJWgO1_bQT6WLWYWQD0g",k=L.map("mapDiv",{fullscreenControl:!1,minimapControl:!1,gestureHandling:!1,resizerControl:!1,pegmanControl:!1,locateControl:!1,loadingControl:!1,searchControl:!1,preferCanvas:!1,rotate:!0,rotateControl:{closeOnZeroBearing:!0}}).setView([23.125178,113.280637],12);let Z={options:{position:"topright",theme:"lime-theme",detached:!1,collapsed:!0,autohide:!1,downloadLink:!0,almostOver:!0,distanceMarkers:!0}},z={options:{collapsed:!0}},D=L.control.elevation(Z.options).addTo(k),B=L.control.layers(null,null,z.options);D.on("eledata_loaded",({layer:e,name:t})=>B.addTo(k)&&e.eachLayer(e=>"Point"!=e.feature.geometry.type&&B.addOverlay(e,e.feature&&e.feature.properties&&e.feature.properties.name||t)));var U=L.tileLayer.bing(A).addTo(k),Y=L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",{id:"mapbox/streets-v11",tileSize:512,zoomOffset:-1,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:23,maxNativeZoom:19}),G=(L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,maxNativeZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),L.tileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"&copy; Esri &mdash; Sources: Esri, DigitalGlobe, Earthstar Geographics, CNES/Airbus DS, GeoEye, USDA FSA, USGS, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community"})),J="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",J=L.tileLayer(J,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),X="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",X=L.tileLayer(X,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),W="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",W=L.tileLayer(W,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),V="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",V=L.tileLayer(V,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),H="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/ter_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=ter&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",H=L.tileLayer(H,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),Q=L.tileLayer("http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19}),K=L.tileLayer("https://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19}),ee=L.tileLayer("https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",{minzoom:5,maxzoom:23,maxNativeZoom:15,tileSize:256}),t=(L.control.layers({Bing:U,ArcGIS:G,"天地图-影像":J,"天地图-矢量":W,"天地图-地形":H,"OpenStreetMap黑色":Q,"OpenStreetMap正常":K,"mapbox Streets":Y},{"天地图-矢量注记":V,"天地图-影像注记":X,"广东省高程":ee},{position:"topleft"}).addTo(k),L.Measure={linearMeasurement:"Distance measurement",areaMeasurement:"Area measurement",start:"开始",meter:"m",kilometer:"km",squareMeter:"m²",squareKilometers:"km²"},L.control.measure({}).addTo(k),""),te="",o="",ae="",a=!1,i=!1,oe="",ie="",C=!1,_=[0,0],x=0,n=!1,T=!1,E=!1,j=!1,v=!1,h=!1,c=!1,s=!1,d=!1,f=[0,0],r={status:!1,id:0},M=0,ne=!1,S=[],O=0,N="#634FF1",l=[],p="",m=[],se=[],I="",re=!1,le=new Array,y={},F=new Object,ce=["#EC1D43","#EC811D","#ECBE1D","#B6EC1D","#1DA2EC","#781DEC","#CF1DEC","#222222"],u=(L.Control.Navigation=L.Control.extend({options:{position:"topleft"},initialize:function(e){L.Util.extend(this.options,e)},onAdd:function(e){this._container=L.DomUtil.create("div","leaflet-control-container");var t=L.DomUtil.create("img","leaflet-control-navigation");return t.id="leaflet-control-clegend",t.type="img",t.src="/static/supa-mapus/images/marker-icon.png",this._legendimg=t,this._container.appendChild(this._legendimg),L.DomEvent.addListener(this._legendimg,"click",this._onClickControl,this),this._container},_onClickControl:function(){alert("按钮被点击了！")}}),new URLSearchParams(window.location.search));u.has("file")&&(I=u.get("file"),$("#share-url").val(window.location.href)),window.setTimeout(async function(){var e,t;await je()&&u.has("file")?Re():((await je()&&!u.has("file")?($("#popup").find(".header-text").html("Create a map"),$("#popup").find(".subheader-text").html("Maps can be shared with friends to collaborate in real-time."),$("#google-signin").attr("id","create-map"),$(".create-map").html("Create a map"),{data:e,error:t}=await _supabase.from("rooms").select(),e.forEach(function(e,t){$("#room-list").prepend('<div class="room-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg"> <input value='+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.description+' disabled class="annotation-description"></div></div>')}),$("#popup")):($("#popup").removeClass("signin"),$("#sign"))).addClass("signin"),$("#overlay").addClass("signin"))},500);L.control.scale();L.control.scale({metric:!0,imperial:!1}).addTo(k);const de={token:"pk.eyJ1IjoidHlwZWJyb29rIiwiYSI6ImNqNHVyaTc5dDBuazczMm1jenl3cG8wb3IifQ.2UEZ-jiHgHvYYqVirXhgpw",tilesUrl:"https://api.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.pngraw?access_token=pk.eyJ1IjoidHlwZWJyb29rIiwiYSI6ImNqNHVyaTc5dDBuazczMm1jenl3cG8wb3IifQ.2UEZ-jiHgHvYYqVirXhgpw"};(new(L.Control.extend({onAdd(){const t=L.DomUtil.create("div");return t.style.width="100px",t.style.background="rgba(255,255,255,0.5)",t.style.textAlign="left",k.on("zoomstart zoom zoomend",e=>{t.innerHTML="Zoom level: "+k.getZoom()}),t}}))).addTo(k);var b=L.marker([0,0],{pane:"overlayPane",interactive:!1}).addTo(k);b.setOpacity(1),b.bindTooltip("",{permanent:!0,offset:[5,25],sticky:!0,className:"hints",direction:"right"}).addTo(k);function pe(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t=L.icon({iconUrl:"/static/supa-mapus/assets/liveLocation.svg",iconSize:[24,24],iconAnchor:[12,12]});(p=L.marker([e.coords.latitude,e.coords.longitude],{icon:t,pane:"overlayPane"})).addTo(k)})}function g(){d=s=c=j=E=v=h=T=n=!1,k.pm.disableDraw(),k.pm._globalRemovalModeEnabled&&k.pm.disableGlobalRemovalMode(),k.pm._globalDragModeEnabled&&k.pm.toggleGlobalDragMode(),k.pm.disableGlobalEditMode(),k.eachLayer(function(e){"markerPane"!=e.options.pane&&e.closeTooltip()})}function me(){g(),k.dragging.enable(),$(".tool-active").removeClass("tool-active"),$("#cursor-tool").addClass("tool-active")}function ue(){g(),n=!0,k.dragging.disable(),$(".tool-active").removeClass("tool-active"),$("#pen-tool").addClass("tool-active"),q()}function ge(){g(),T=!0,$(".tool-active").removeClass("tool-active"),$("#eraser-tool").addClass("tool-active"),q()}function ve(){g(),c=!0,$(".tool-active").removeClass("tool-active"),$("#marker-tool").addClass("tool-active"),k.pm.enableDraw("Marker",{tooltips:!1,snappable:!0,templineStyle:{color:N},hintlineStyle:{color:N,dashArray:[5,5]}}),q()}function he(){g(),$(".tool-active").removeClass("tool-active"),$("#area-tool").addClass("tool-active"),k.pm.setGlobalOptions({pinning:!0,snappable:!0}),k.pm.setPathOptions({color:N,fillColor:N,fillOpacity:.4}),k.pm.enableDraw("Polygon",{tooltips:!1,snappable:!0,templineStyle:{color:N},hintlineStyle:{color:N,dashArray:[5,5]}}),q()}function fe(){g(),$(".tool-active").removeClass("tool-active"),$("#path-tool").addClass("tool-active"),k.pm.setGlobalOptions({pinning:!0,snappable:!0}),k.pm.setPathOptions({color:N,fillColor:N,fillOpacity:.4}),k.pm.enableDraw("Line",{tooltips:!1,snappable:!0,templineStyle:{color:N},hintlineStyle:{color:N,dashArray:[5,5]},finishOn:"dblclick"}),q()}function ye(){g(),$(".tool-active").removeClass("tool-active"),$("#rectangle-tool").addClass("tool-active"),k.pm.setGlobalOptions({pinning:!0,snappable:!0}),k.pm.setPathOptions({color:N,fillColor:N,fillOpacity:.4}),k.pm.enableDraw("Rectangle",{tooltips:!1,snappable:!0,templineStyle:{color:N},hintlineStyle:{color:N,dashArray:[5,5]}}),q()}function be(){g(),$(".tool-active").removeClass("tool-active"),$("#circle-tool").addClass("tool-active"),k.pm.setGlobalOptions({pinning:!0,snappable:!0}),k.pm.setPathOptions({color:N,fillColor:N,fillOpacity:.4}),k.pm.enableDraw("Circle",{tooltips:!1,snappable:!0,templineStyle:{color:N},hintlineStyle:{color:N,dashArray:[5,5]}}),q()}function we(){g(),$(".tool-active").removeClass("tool-active"),$("#offset-tool").addClass("tool-active")}function Le(){$("#color-list").toggleClass("color-enabled")}function w(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return e.replace(/[&<>"'/]/gi,e=>t[e])}let R={data:null};document.getElementById("searchInput");const $e=document.getElementById("searchResult"),ke=document.getElementById("noData");function Ce(){$.ajax({type:"GET",async:!1,url:"/v1/wx/tianditusearch",data:{keyword:w($("#search-box input").val())},success:function(e){var t;e.pois?(R.data=e.pois,_e()):e.area&&(R.data=null,t=e.area.lonlat.split(",")[1],e=e.area.lonlat.split(",")[0],k.panTo(new L.LatLng(t,e)))},error:function(e,t,a){console.error("请求失败:",t,a)}})}function _e(){$e.innerHTML="",null===R.data||0===R.data.length?($e.style.display="none",ke.style.display="block"):($e.style.display="block",ke.style.display="none",R.data.forEach((a,e)=>{var t=document.createElement("div");t.className="my-search-result-item",t.textContent=a.name,t.onclick=()=>{return e=a,console.log(e.lonlat),console.log(e.lonlat.split(",")),t=e.lonlat.split(",")[1],e=e.lonlat.split(",")[0],k.panTo(new L.LatLng(t,e)),R.data=null,void _e();var e,t},$e.appendChild(t)}))}function xe(){r.status=!1,$("#outline").css({border:"none"}),$("#outline").removeClass("observing")}async function Te(t,a,o){var i=L.polyline([[t,a]],{color:N}),n=(await _supabase.from("objects").insert({room:I,color:N,initlat:t,initlng:a,user:o.id,type:"draw",session:x,completed:!0}).select("id"))["data"],{}=(O=n[0].id,await _supabase.from("coords").insert({objects_id:n[0].id,lat:t,lng:a}));S.push({id:O,user:o.id,line:i,session:x,local:!0,completed:!0,type:"draw"}),i.addTo(k),S.forEach(function(a){a.line.on("click",async function(t){T?layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("coords").delete().eq("objects_id",a.id))["error"],t=(await _supabase.from("objects").delete().eq("id",a.id))["error"];S=$.grep(S,function(e){return e.id!=a.id}),$(".annotation-item[data-id='"+a.id+"']").remove(),e||t?layer.msg("删除失败",{time:1e3}):(a.line.remove(),layer.msg("删除成功",{time:1e3}))}):E&&(e.target.pm.enable({}),e.target.on("pm:edit",e=>{}))}),a.line.on("mouseover",function(e){T&&a.line.setStyle({opacity:.3})}),a.line.on("mouseout",function(e){a.line.setStyle({opacity:1})})})}async function Ee(){C=!1;var e,t,a,o,i,n,s,r,l=S.filter(function(e){return e.id===O&&e.user===F.id})[0];l.trigger.unbindTooltip(),l.completed=!0,"area"==l.type?(l.trigger.bindTooltip("<h1>"+l.name+"</h1><h2>"+l.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+l.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+l.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:e,error:t}=await _supabase.from("objects").update({area:l.area,distance:l.distance,name:l.name,desc:l.desc,completed:!0}).eq("id",O).select()):"line"==l.type?(l.trigger.bindTooltip("<h1>"+l.name+"</h1><h2>"+l.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+l.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:a,error:o}=await _supabase.from("objects").update({distance:l.distance,name:l.name,desc:l.desc,completed:!0}).eq("id",O).select()):"marker"==l.type&&(l.trigger.bindTooltip("<h1>"+l.name+"</h1><h2>"+l.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+l.lat.toFixed(5)+", "+l.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),{data:i,error:n}=await _supabase.from("objects").update({name:l.name,desc:l.desc,completed:!0}).eq("id",O).select()),"circle"==l.type&&(l.trigger.bindTooltip("<h1>"+l.name+"</h1><h2>"+l.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+l.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+l.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:s,error:r}=await _supabase.from("objects").update({area:l.area,distance:l.distance,name:l.name,desc:l.desc,completed:!0}).eq("id",O).select()),P(l),$(".annotation-item[data-id='"+l.id+"']").find(".annotation-name input").addClass("annotation-focus"),window.setTimeout(function(){l.trigger.openTooltip()},200)}async function je(){var{user:e}=(await _supabase.auth.getUser())["data"];return null!=(F=e)&&F}function P(e){var t;0==$(".annotation-item[data-id='"+e.id+"']").length?"line"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M14.5 8.5L8.5 14.5" stroke="white" stroke-width="1.5" stroke-linecap="square"/><path d="M15.8108 8.53378C16.7176 8.53378 17.4527 7.79868 17.4527 6.89189C17.4527 5.9851 16.7176 5.25 15.8108 5.25C14.904 5.25 14.1689 5.9851 14.1689 6.89189C14.1689 7.79868 14.904 8.53378 15.8108 8.53378Z" stroke="white" stroke-width="1.5"/><circle cx="6.89189" cy="15.8108" r="1.64189" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"><img id="hidden-layer" class="hide-layer" src="/static/supa-mapus/assets/show.svg" data-id = "'+e.id+'"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/distance-icon.svg">'+e.distance+" km</div></div></div></div>")):"area"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M15.3652 8.5V13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M8.5 15.3649H13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M14.5303 9.03033C14.8232 8.73744 14.8232 8.26256 14.5303 7.96967C14.2374 7.67678 13.7626 7.67678 13.4697 7.96967L14.5303 9.03033ZM7.96967 13.4697C7.67678 13.7626 7.67678 14.2374 7.96967 14.5303C8.26256 14.8232 8.73744 14.8232 9.03033 14.5303L7.96967 13.4697ZM13.4697 7.96967L7.96967 13.4697L9.03033 14.5303L14.5303 9.03033L13.4697 7.96967Z" fill="white"/><circle cx="15.365" cy="6.85135" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="15.365" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="6.85135" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"><img id="hidden-layer" class="hide-layer" src="/static/supa-mapus/assets/show.svg" data-id = "'+e.id+'"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div></div></div></div>")):"marker"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M16.0252 11.2709C16.0252 14.8438 11.3002 17.9063 11.3002 17.9063C11.3002 17.9063 6.5752 14.8438 6.5752 11.2709C6.5752 10.0525 7.07301 8.8841 7.95912 8.0226C8.84522 7.16111 10.047 6.67712 11.3002 6.67712C12.5533 6.67712 13.7552 7.16111 14.6413 8.0226C15.5274 8.8841 16.0252 10.0525 16.0252 11.2709Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.2996 12.8021C12.1695 12.8021 12.8746 12.1166 12.8746 11.2709C12.8746 10.4252 12.1695 9.73962 11.2996 9.73962C10.4298 9.73962 9.72461 10.4252 9.72461 11.2709C9.72461 12.1166 10.4298 12.8021 11.2996 12.8021Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div></div></div></div>")):"text"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M16.0252 11.2709C16.0252 14.8438 11.3002 17.9063 11.3002 17.9063C11.3002 17.9063 6.5752 14.8438 6.5752 11.2709C6.5752 10.0525 7.07301 8.8841 7.95912 8.0226C8.84522 7.16111 10.047 6.67712 11.3002 6.67712C12.5533 6.67712 13.7552 7.16111 14.6413 8.0226C15.5274 8.8841 16.0252 10.0525 16.0252 11.2709Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.2996 12.8021C12.1695 12.8021 12.8746 12.1166 12.8746 11.2709C12.8746 10.4252 12.1695 9.73962 11.2996 9.73962C10.4298 9.73962 9.72461 10.4252 9.72461 11.2709C9.72461 12.1166 10.4298 12.8021 11.2996 12.8021Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div></div></div></div>")):"circle"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M15.3652 8.5V13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M8.5 15.3649H13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M14.5303 9.03033C14.8232 8.73744 14.8232 8.26256 14.5303 7.96967C14.2374 7.67678 13.7626 7.67678 13.4697 7.96967L14.5303 9.03033ZM7.96967 13.4697C7.67678 13.7626 7.67678 14.2374 7.96967 14.5303C8.26256 14.8232 8.73744 14.8232 9.03033 14.5303L7.96967 13.4697ZM13.4697 7.96967L7.96967 13.4697L9.03033 14.5303L14.5303 9.03033L13.4697 7.96967Z" fill="white"/><circle cx="15.365" cy="6.85135" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="15.365" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="6.85135" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"><img id="hidden-layer" class=" hide-layer" src="/static/supa-mapus/assets/show.svg" data-id = "'+e.id+'"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div></div></div></div>")):"rectangle"==e.type&&(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M15.3652 8.5V13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M8.5 15.3649H13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M14.5303 9.03033C14.8232 8.73744 14.8232 8.26256 14.5303 7.96967C14.2374 7.67678 13.7626 7.67678 13.4697 7.96967L14.5303 9.03033ZM7.96967 13.4697C7.67678 13.7626 7.67678 14.2374 7.96967 14.5303C8.26256 14.8232 8.73744 14.8232 9.03033 14.5303L7.96967 13.4697ZM13.4697 7.96967L7.96967 13.4697L9.03033 14.5303L14.5303 9.03033L13.4697 7.96967Z" fill="white"/><circle cx="15.365" cy="6.85135" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="15.365" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="6.85135" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"><img id="hidden-layer" class=" hide-layer" src="/static/supa-mapus/assets/show.svg" data-id = "'+e.id+'"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div></div></div></div>")):(t=$(".annotation-item[data-id='"+e.id+"']"),"line"==e.type?(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/distance-icon.svg">'+e.distance+" km</div>")):"area"==e.type?(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div>")):"marker"==e.type||"text"==e.type?(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div>")):"circle"!=e.type&&"rectangle"!=e.type||(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div>")))}async function Me(){a=!1,$("#map-name").prop("disabled",!0),$("#map-name").removeClass("map-editing");var e,t=w($("#map-name").val());0==t.length?$("#map-name").val(te):e=(await _supabase.from("rooms").update({name:t}).eq("id",I))["error"]}async function Se(){i=!1,$("#map-description").prop("disabled",!0),$("#map-description").removeClass("map-editing");var e,t=w($("#map-description").val());0==t.length?$("#map-description").val(ae):e=(await _supabase.from("rooms").update({description:t}).eq("id",I))["error"]}function q(){$(".leaflet-overlay-pane").css({visibility:"visible","pointer-events":"all"}),$(".leaflet-tooltip-pane").css({visibility:"visible","pointer-events":"all"}),$("#hide-annotations").removeClass("hidden-annotations"),$("#hide-annotations").html("Hide all")}function Oe(){$("#overlay").hasClass("share-show")&&$(".share-show").removeClass("share-show")}function Ne(e){var t=[];return e.eachLayer(e=>{(e instanceof L.Marker||e instanceof L.Polyline||e instanceof L.Polygon||e instanceof L.Circle||e instanceof L.Rectangle||e instanceof L.CircleMarker)&&t.push(e)}),t=(t=t.filter(e=>!!e.pm)).filter(e=>!e._pmTempLayer)}async function Ie(e,t){var a;t!=F.id&&(e.active?l.find(e=>e.id===t)?(l.find(e=>e.id===t).cursor.setLatLng([e.lat,e.lng]),1==r.status&&t==r.id&&(k.setZoom(e.zoom),k.panTo(new L.LatLng(e.view[0],e.view[1])))):(a=L.divIcon({html:'<svg width="18" height="18" style="z-index:9999!important" viewBox="0 0 18 18" fill="none" style="background:none;" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.51169 15.8783L1.08855 3.64956C0.511984 2.05552 2.05554 0.511969 3.64957 1.08853L15.8783 5.51168C17.5843 6.12877 17.6534 8.51606 15.9858 9.23072L11.2573 11.2573L9.23074 15.9858C8.51607 17.6534 6.12878 17.5843 5.51169 15.8783Z" fill="'+e.color+'"/></svg>',iconSize:[22,22],iconAnchor:[0,0],shadowAnchor:[4,62],popupAnchor:[-3,-76],className:"cursoricon"}),(a=L.marker([e.lat,e.lng],{icon:a,pane:"markerPane"})).bindTooltip(e.name,{permanent:!0,offset:[14,32],className:"cursor-label color"+e.color.replace("#",""),direction:"right"}),a.addTo(k),l.push({id:t,cursor:a,color:e.color,name:e.name}),null==(a=e.imgsrc)?(a=e.name,$("#right-nav").prepend('<div id="profile" style="background:'+e.color+'!important" class="avatars" data-id="'+t+'">'+a+"</div>")):$("#right-nav").prepend('<div id="profile" style="background:'+e.color+'!important" class="avatars" data-id="'+t+'"><img src="'+a+'"></div>')):!e.active&&l.find(e=>e.id===t)&&(1==r.status&&t==r.id&&xe(),$(".avatars[data-id="+t+"]").remove(),l.find(e=>e.id===t).cursor.remove(),l=$.grep(l,function(e){return e.id!=t})))}async function Fe(r,l){var c,t,e,a,o,d;"draw"==r.type||"line"==r.type||"area"==r.type||"circle"==r.type||"rectangle"==r.type?0==S.filter(function(e){return e.id===l&&e.user===r.user}).length?(!r.completed||"line"!=r.type&&"area"!=r.type?c=L.polyline([[r.initlat,r.initlng]],{color:r.color}):(c=L.polyline(r.path,{color:r.color})).addTo(k),"area"==r.type?S.push({id:l,local:!1,user:r.user,color:r.color,line:c,name:r.name,desc:r.desc,distance:r.distance,area:r.area,path:r.path,completed:r.completed,type:r.type,trigger:"",session:r.session}):"line"==r.type?S.push({id:l,local:!1,user:r.user,color:r.color,line:c,name:r.name,desc:r.desc,distance:r.distance,path:r.path,completed:r.completed,type:r.type,trigger:"",session:r.session}):"circle"!=r.type&&"rectangle"!=r.type||S.push({id:l,local:!1,user:r.user,color:r.color,line:c,name:r.name,desc:r.desc,distance:r.distance,area:r.area,path:r.path,completed:r.completed,type:r.type,trigger:"",session:r.session}),c.on("click",async function(e){if(r.completed&&"draw"==r.type&&T)layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("coords").delete().eq("objects_id",d.id))["error"],t=(await _supabase.from("objects").delete().eq("id",l))["error"];S=$.grep(S,function(e){return e.id!=l}),e||t?layer.msg("删除失败",{time:1e3}):(c.remove(),layer.msg("删除成功",{time:1e3}))});else if(E)e.target.pm.enable({}),e.target.on("pm:edit",e=>{});else if(j)e.target.on("pm:dragend",e=>{});else if(h){for(var t=[],a=0;a<e.target._latlngs.length;a++){var o=[];o.push(e.target._latlngs[a].lng),o.push(e.target._latlngs[a].lat),t.push(o)}var i=turf.lineString(t),n={units:"kilometers"},s=turf.length(i,n);turf.lineChunk(i,s/100,n),turf.bbox(i);(async function(e){var a=[];for(const o of e.geometry.coordinates){var t={},t=(t.lat=o[1],t.lng=o[0],await Topography.getTopography(t,de));a.push(parseFloat(t.elevation.toFixed(2)))}turf.coordEach(e,function(e,t){e[2]=a[t]});e=turf.featureCollection([e],{name:"demo.geojson",type:"FeatureCollection"});D.load(JSON.stringify(e))})(i)}}),c.on("mouseover",function(e){T&&"draw"==r.type&&c.setStyle({opacity:.3})}),c.on("mouseout",function(e){"draw"==r.type&&c.setStyle({opacity:1})})):(t=[],Object.values(r.coords).forEach(function(e){t.push([e.lat,e.lng])}),S.filter(function(e){return e.id===l&&e.user===r.user})[0].line.setLatLngs(t)):"marker"==r.type?0==S.filter(function(e){return e.id===l&&e.user===r.user}).length?(e="none"==r.m_type?L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+r.color+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}):L.icon({iconUrl:"/static/supa-mapus/assets/"+r.m_type+"-marker.svg",iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),(a=L.marker([r.lat,r.lng],{icon:e,interactive:!0,direction:"top",pane:"overlayPane"})).bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+r.lat.toFixed(5)+", "+r.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",className:"create-shape-flow tooltip-off",interactive:!1,bubblingMouseEvents:!1,offset:L.point({x:0,y:-35})}),a.addTo(k),a.openTooltip(),S.push({id:l,user:r.user,marker:a,color:r.color,name:r.name,desc:r.desc,session:r.session,local:!1,lat:r.lat,lng:r.lng,completed:!0,type:"marker"}),a.on("click",async function(e){T||j?j?e.target.on("pm:dragend",async e=>{var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",d.id).select()}):T&&layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("objects").delete().eq("id",l))["error"];S=$.grep(S,function(e){return e.id!=l}),$(".annotation-item[data-id='"+l+"']").remove(),e?layer.msg("删除失败",{time:1e3}):(a.remove(),layer.msg("删除成功",{time:1e3}))}):($(a.getTooltip()._container).removeClass("tooltip-off"),a.openTooltip())}),a.on("tooltipclose",function(){$(".annotation-item[data-id="+l+"]").find(".annotation-name input").removeClass("annotation-focus")}),a.closeTooltip(),P(S.find(e=>e.id==l))):P(S.filter(function(e){return e.id===l&&e.user===r.user})):"text"==r.type&&(0==S.filter(function(e){return e.id===l&&e.user===r.user}).length?((o=L.marker([r.lat,r.lng],{textMarker:!0,text:r.desc}).addTo(k)).pm.getElement().style.color=r.color,S.push({id:l,local:!1,user:r.user,color:r.color,name:"Text",desc:r.desc,lat:r.lat,lng:r.lng,completed:r.completed,type:r.type,trigger:o,session:r.session}),o.on("click",async function(e){j?e.target.on("pm:dragend",async e=>{var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",d.id).select()}):T?layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除文本"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("objects").delete().eq("id",l))["error"];S=$.grep(S,function(e){return e.id!=l}),$(".annotation-item[data-id='"+l+"']").remove(),e?layer.msg("删除失败",{time:1e3}):(o.remove(),layer.msg("删除成功",{time:1e3}))}):E&&(e.target.pm.enable(),e.target.on("pm:textchange",async e=>{text=e.layer.pm.getText();var{}=await _supabase.from("objects").update({desc:text}).eq("id",d.id).select()}))}),P(S.find(e=>e.id==l))):P(S.filter(function(e){return e.id===l&&e.user===r.user}))),r.completed&&0<S.filter(function(e){return e.id===l&&e.user===r.user}).length&&((d=S.filter(function(e){return e.id===l&&e.user===r.user})[0]).name=r.name,d.desc=r.desc,"area"==r.type||"rectangle"==r.type?(d.area=r.area,d.distance=r.distance,d.path=r.path):"line"==r.type?d.distance=r.distance:"circle"==r.type&&(d.area=r.area,d.distance=r.distance),async function(t,a){var n,e,o;"draw"!=t.type&&"marker"!=t.type&&"text"!=t.type&&((n=S.filter(function(e){return e.id===a&&e.user===t.user})[0]).completed=!0,e=L.marker(n.line.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"}),""!=n.trigger&&(e=n.trigger).unbindTooltip(),"line"==n.type?e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,closeOnClick:!1,autoclose:!1,bubblingMouseEvents:!0,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}):"area"==n.type?(e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+n.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}),n.line.remove(),o=L.polygon(n.path,{color:n.color}).addTo(k),n.line=o):"circle"==n.type?(e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+n.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}),n.line.remove(),o=(1e3*n.distance/(2*Math.PI)).toFixed(2),o=L.circle([n.line._latlngs[0].lat,n.line._latlngs[0].lng],{radius:o,color:n.color}).addTo(k),n.line=o):"rectangle"==n.type&&(e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+n.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}),n.line.remove(),o=L.polygon(n.path,{color:n.color}).addTo(k),n.line=o),e.setOpacity(0),e.addTo(k),(n.trigger=e).getTooltip().update(),n.line.on("click",async function(e){var a,t,o,i;"circle"!=n.type?E?(e.target.pm.enable({}),e.target.on("pm:edit",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));else if("Rectangle"==e.shape)for(var i in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][i]));var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:t}).eq("id",n.id).select()})):j?e.target.on("pm:dragend",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));else if("Rectangle"==e.shape)for(var i in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][i]));var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:t}).eq("id",n.id).select()}):T?layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("coords").delete().eq("objects_id",n.id))["error"],t=(await _supabase.from("objects").delete().eq("id",n.id))["error"];S=$.grep(S,function(e){return e.id!=n.id}),$(".annotation-item[data-id='"+n.id+"']").remove(),e||t?layer.msg("删除失败",{time:1e3}):(n.trigger.remove(),n.line.remove(),layer.msg("删除成功",{time:1e3}))}):v?(e.target.pm.enableRotate(),e.target.on("pm:rotateend",async t=>{var a=[];if(t.newLatLngs[0][0])for(let e=0;e<t.newLatLngs[0].length;e++)a[e]=[],a[e][0]=t.newLatLngs[0][e].lat,a[e][1]=t.newLatLngs[0][e].lng;else for(let e=0;e<t.newLatLngs.length;e++)a[e]=[],a[e][0]=t.newLatLngs[e].lat,a[e][1]=t.newLatLngs[e].lng;var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:a}).eq("id",n.id).select()})):h||($("#offset-tool").hasClass("tool-active")&&"line"==n.type?(a=[[]],i=e.target._latlngs,t=n.name,o=n.color,i.forEach((e,t)=>{a[t]=[e.lat,e.lng]}),(i=L.marker(e.target.pm._layer.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label>偏移距离(单位：m)</label><input id="offset-distance" name="offset-distance" value="50"/><br><div id="buttons"><button class="offset-save-reload-button">Save</button><button class="offset-save-button" data-color="'+o+'" data-name="'+t+'" data-line="'+JSON.stringify(a)+'">Offset</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),i.setOpacity(0),i.addTo(k),i.openTooltip()):(n.trigger.setLatLng(_),n.trigger.openTooltip(),$(n.trigger.getTooltip()._container).removeClass("tooltip-off"))):"circle"==n.type&&(E?(e.target.pm.enable({allowSelfIntersection:!1}),e.target.on("pm:edit",async e=>{n.distance=(e.target._mRadius/1e3*2*Math.PI).toFixed(2),n.area=(Math.pow((e.target._mRadius/1e3).toFixed(2),2)*Math.PI).toFixed(2);var{}=await _supabase.from("objects").update({initlat:e.target._latlng.lat,initlng:e.target._latlng.lng,area:n.area,distance:n.distance}).eq("id",n.id).select()})):j?e.target.on("pm:dragend",async e=>{n.distance=(e.target._mRadius/1e3*2*Math.PI).toFixed(2),n.area=(Math.pow((e.target._mRadius/1e3).toFixed(2),2)*Math.PI).toFixed(2);var{}=await _supabase.from("objects").update({initlat:e.target._latlng.lat,initlng:e.target._latlng.lng,area:n.area,distance:n.distance}).eq("id",n.id).select()}):T?layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("coords").delete().eq("objects_id",n.id))["error"],t=(await _supabase.from("objects").delete().eq("id",n.id))["error"];S=$.grep(S,function(e){return e.id!=n.id}),$(".annotation-item[data-id='"+n.id+"']").remove(),e||t?layer.msg("删除失败",{time:1e3}):(n.trigger.remove(),n.line.remove(),layer.msg("删除成功",{time:1e3}))}):(n.trigger.setLatLng(_),n.trigger.openTooltip(),$(n.trigger.getTooltip()._container).removeClass("tooltip-off")))}),n.line.on("tooltipclose",function(){$(".annotation-item[data-id="+n.id+"]").find(".annotation-name input").removeClass("annotation-focus")}),P(n))}(r,l))}async function Re(){var e=(await _supabase.from("rooms").select().eq("id",I))["data"],e=(t=e[0].name,o=e[0].description,$("#map-name").val(t),$("#map-description").val(o),$("#share-nav span").html("Share "+t),await _supabase.from("users").select().eq("room",I))["data"];0!=e.length&&e.forEach(function(e,t){Ie(l,e.id)});const a=(await _supabase.from("objects").select(`
            *,
            coords (
              lat,lng
            )
          `).eq("room",I))["data"];0!=a.length&&Object.values(a).forEach(function(e,t){Fe(e,a[t].id)}),_supabase.channel("public:rooms").on("postgres_changes",{event:"*",schema:"public",table:"rooms"},e=>{e.new.id==I&&(t=e.new.name,o=e.new.description,$("#map-name").val(t),$("#map-description").val(o))}).subscribe(),_supabase.channel("public:users").on("postgres_changes",{event:"INSERT",schema:"public",table:"users"},e=>{e.new.room==I&&Ie(e.new,e.new.id)}).subscribe(),_supabase.channel("public:users").on("postgres_changes",{event:"UPDATE",schema:"public",table:"users"},e=>{e.new.room==I&&Ie(e.new,e.new.id)}).subscribe(),_supabase.channel("public:objects").on("postgres_changes",{event:"*",schema:"public",table:"objects"},async e=>{if(null!=e.new){const o=(await _supabase.from("objects").select(`
                *,
                coords (
                  lat,lng
                )
              `).eq("room",I))["data"];S.forEach(async function(t){var a;t.completed&&(a=[],o.forEach(function(e,t){a.push(e.id)}),-1==$.inArray(t.id,a))&&(("draw"==t.type?t.line:(("marker"==t.type?t.marker:(t.trigger.remove(),t.local?t.layer:t.line)).remove(),$(".annotation-item[data-id='"+t.id+"']"))).remove(),S=$.grep(S,function(e){return e.id!=t.id}))}),0!=Object.keys(o).length&&o.forEach(function(e,t){e.user!=F.id&&(Fe(e,o[t].id),async function(t,a){var o;"draw"!=t.type&&"line"!=t.type&&"area"!=t.type||0<S.filter(function(e){return e.id===a&&e.user===t.user}).length&&(o=[],Object.values(t.coords).forEach(function(e){o.push([e.lat,e.lng])}),S.filter(function(e){return e.id===a&&e.user===t.user})[0].line.setLatLngs(o))}(e,o[t].id))})}}).subscribe()}function Pe(){$("#overlay").hasClass("sign-show")&&$(".sign-show").removeClass("sign-show")}k.on("pm:drawstart",async({workingLayer:e})=>{b.openTooltip(),b.setTooltipContent("Click to place first vertex"),e.on("pm:vertexadded",async a=>{var e,t,o;"Polygon"==a.shape?(b.setTooltipContent("Click on first vertex to finish"),f=a.layer._latlngs[a.layer._latlngs.length-1],1==a.layer._latlngs.length?({data:t,error:e}=await _supabase.from("objects").insert({room:I,color:N,initlat:a.layer._latlngs[0].lat,initlng:a.layer._latlngs[0].lng,user:F.id,type:"area",session:x,name:"Area",desc:"",distance:0,area:0,completed:!1,path:[]}).select("id"),(O=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:f.lat,lng:f.lng}))["error"],S.push({id:O,local:!0,color:N,user:F.id,name:"Area",desc:"",trigger:"",distance:0,area:0,layer:"",type:"area",session:x,completed:!1})):(await _supabase.from("coords").insert({objects_id:O,lat:f.lat,lng:f.lng}))["error"]):"Line"==a.shape&&(s=!0,M=0,f=a.layer._latlngs[a.layer._latlngs.length-1],1==a.layer._latlngs.length?({data:t,error:o}=await _supabase.from("objects").insert({room:I,color:N,initlat:a.layer._latlngs[0].lat,initlng:a.layer._latlngs[0].lng,user:F.id,type:"line",session:x,name:"Line",desc:"",distance:0,completed:!1,path:[]}).select("id"),(O=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:f.lat,lng:f.lng}))["error"],S.push({id:O,local:!0,color:N,user:F.id,name:"Line",desc:"",trigger:"",distance:0,layer:"",type:"line",session:x,completed:!1})):(a.layer._latlngs.forEach(function(e,t){0!=t&&(M+=a.layer._latlngs[t-1].distanceTo(e))}),b.setTooltipContent(M/1e3+"km | Double click to finish"),(await _supabase.from("coords").insert({objects_id:O,lat:f.lat,lng:f.lng}))["error"]))}),e.on("pm:centerplaced",async e=>{var t,a,o;"Circle"==e.shape&&({data:t,error:a}=await _supabase.from("objects").insert({room:I,color:N,initlat:e.latlng.lat,initlng:e.latlng.lng,user:F.id,type:"circle",session:x,name:"Circle",desc:"",distance:0,area:0,completed:!1,path:[]}).select("id"),o=(O=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:e.latlng.lat,lng:e.latlng.lng}))["error"],S.push({id:O,local:!0,color:N,user:F.id,name:"Circle",desc:"",trigger:"",distance:0,area:0,layer:"",type:"circle",session:x,completed:!1}))})}),k.on("pm:create",async a=>{if("Rectangle"===a.shape&&1==re){var o=w($("#tilezoom").val()),e=(dowladmap=!1,(geojsonLayer=a.layer).addTo(k),a.layer.getBounds()._northEast),t=a.layer.getBounds()._southWest,i=_$().LatLongToPixelXY(e.lat,e.lng,o),n=_$().LatLongToPixelXY(t.lat,t.lng,o);new Promise(function(e,t){e(async function(e,t,a){if(console.log("图片数量约："+(Math.round((t.X-e.X)/256)+1)*(Math.round((e.Y-t.Y)/256)+1)+"张。"),30<(Math.round((t.X-e.X)/256)+1)*(Math.round((e.Y-t.Y)/256)+1))console.log("图片数量超过30张，请重新选择范围或降低级别！");else for(var o=0,i=e.X;i<=t.X;i+=256){le[o]=new Array;for(var n=0,s=t.Y;s<=e.Y;s+=256){tilexy=_$().PixelXYToTileXY(i,s),quadkey=_$().toQuadKey(tilexy.X,tilexy.Y,a);var r=y._url.replace("{subdomain}",y.subdomains[parseInt(4*Math.random())]);await async function(a,o){var i=3*Math.random();return new Promise(function(e,t){setTimeout(function(){console.log("请求中..."),console.log(a,o,new Date),fetch(a).then(e=>e.blob()).then(e=>{var t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=o,t.click()}),e("resolve return")},1e3*i)})}(r=r.replace("{quadkey}",quadkey),i+"-"+s+".jpeg"),le[o][n]=i+"-"+s+".jpeg",n++}o++}}(n,i,o))}).finally(function(){var e=document.createElement("a"),t=new Blob([JSON.stringify(le)],{type:"application/json"});e.href=URL.createObjectURL(t),e.download="urlList",e.click()})}else if("Text"==a.shape)a.layer.on("pm:textblur",async e=>{text=""==e.layer.pm.getText()?"未命名":e.layer.pm.getText();var t=(await _supabase.from("objects").insert({room:I,color:N,lat:e.layer._latlng.lat,lng:e.layer._latlng.lng,user:F.id,type:"text",session:x,name:"Text",desc:text,distance:0,area:0,completed:!0,path:[]}).select("id"))["data"],a=(O=t[0].id,S.push({id:O,local:!0,color:N,user:F.id,name:"Text",desc:text,lat:e.layer._latlng.lat,lng:e.layer._latlng.lng,trigger:e.layer,distance:0,area:0,layer:"",type:"text",session:x,completed:!0}),C=!0,S.filter(function(e){return e.id===O&&e.user===F.id})[0]);a.layer=e.layer,e.layer.pm.getElement().style.color=N,P(a),$(".annotation-item[data-id='"+a.id+"']").find(".annotation-name input").addClass("annotation-focus"),e.layer.on("click",async t=>{!(T||E||j)||E||(j?t.target.on("pm:dragend",async e=>{var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",a.id).select()}):T&&layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除文本"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("objects").delete().eq("id",O))["error"];S=$.grep(S,function(e){return e.id!=O}),$(".annotation-item[data-id='"+O+"']").remove(),e?layer.msg("删除失败",{time:1e3}):(t.target.remove(),layer.msg("删除成功",{time:1e3}))}))})});else if("Circle"==a.shape){C=!0;(m=S.filter(function(e){return e.id===O&&e.user===F.id})[0]).distance=(a.layer._mRadius/1e3*2*Math.PI).toFixed(2),m.area=(Math.pow((a.layer._mRadius/1e3).toFixed(2),2)*Math.PI).toFixed(2);var{}=await _supabase.from("objects").update({area:m.area}).eq("id",O).select();(u=L.marker(a.layer.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="'+m.name+'" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),u.setOpacity(0),u.addTo(k),u.openTooltip(),$("#shape-name").focus(),$("#shape-name").select(),m.trigger=u,m.layer=a.layer,a.layer.on("click",async function(a){T||E||j?E?(a.target.pm.enable({allowSelfIntersection:!1}),a.target.on("pm:edit",async e=>{m.distance=(e.target._mRadius/1e3*2*Math.PI).toFixed(2),m.area=(Math.pow((e.target._mRadius/1e3).toFixed(2),2)*Math.PI).toFixed(2);var{}=await _supabase.from("objects").update({initlat:e.target._latlng.lat,initlng:e.target._latlng.lng,area:m.area,distance:m.distance}).eq("id",m.id).select()})):j?a.target.on("pm:dragend",async e=>{m.distance=(e.target._mRadius/1e3*2*Math.PI).toFixed(2),m.area=(Math.pow((e.target._mRadius/1e3).toFixed(2),2)*Math.PI).toFixed(2);var{}=await _supabase.from("objects").update({initlat:e.target._latlng.lat,initlng:e.target._latlng.lng,area:m.area,distance:m.distance}).eq("id",m.id).select()}):T&&layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("coords").delete().eq("objects_id",m.id))["error"],t=(await _supabase.from("objects").delete().eq("id",m.id))["error"];S=$.grep(S,function(e){return e.id!=m.id}),$(".annotation-item[data-id='"+m.id+"']").remove(),e||t?layer.msg("删除失败",{time:1e3}):(m.trigger.remove(),a.target.remove(),layer.msg("删除成功",{time:1e3}))}):(u.setLatLng(_),u.openTooltip())})}else if("Line"==a.shape||"Polygon"==a.shape){var s,r,l,c;C=!0,(m=S.filter(function(e){return e.id===O&&e.user===F.id})[0]).distance=parseFloat(turf.length(a.layer.toGeoJSON()).toFixed(2)),m.layer=a.layer,"area"==m.type?(m.area=parseFloat((1e-6*turf.area(a.layer.toGeoJSON())).toFixed(2)),g=[],{data:s,error:r}=(Object.values(a.layer.getLatLngs()[0]).forEach(function(e){g.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:g,area:m.area}).eq("id",O).select())):"line"==m.type&&(g=[],{data:l,error:c}=(Object.values(a.layer.getLatLngs()).forEach(function(e){g.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:g}).eq("id",O).select())),(u=L.marker(a.layer.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="'+m.name+'" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),u.setOpacity(0),u.addTo(k),u.openTooltip(),$("#shape-name").focus(),$("#shape-name").select(),m.trigger=u,a.layer.on("click",async function(a){var o,e,t,i;T||E||v||j||$("#offset-tool").hasClass("tool-active")&&"line"==m.type?E?(a.target.pm.enable({allowSelfIntersection:!1}),a.target.on("pm:edit",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:m.area,distance:m.distance,path:t}).eq("id",m.id).select()})):j?a.target.on("pm:dragend",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:m.area,distance:m.distance,path:t}).eq("id",m.id).select()}):T?layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("coords").delete().eq("objects_id",m.id))["error"],t=(await _supabase.from("objects").delete().eq("id",m.id))["error"];S=$.grep(S,function(e){return e.id!=m.id}),$(".annotation-item[data-id='"+m.id+"']").remove(),e||t?layer.msg("删除失败",{time:1e3}):(m.trigger.remove(),a.target.remove(),layer.msg("删除成功",{time:1e3}))}):v?(a.target.pm.enableRotate(),a.target.on("pm:rotateend",async t=>{var a=[];if(t.newLatLngs[0][0])for(let e=0;e<t.newLatLngs[0].length;e++)a[e]=[],a[e][0]=t.newLatLngs[0][e].lat,a[e][1]=t.newLatLngs[0][e].lng;else for(let e=0;e<t.newLatLngs.length;e++)a[e]=[],a[e][0]=t.newLatLngs[e].lat,a[e][1]=t.newLatLngs[e].lng;var{}=await _supabase.from("objects").update({area:m.area,distance:m.distance,path:a}).eq("id",m.id).select()})):h||$("#offset-tool").hasClass("tool-active")&&"line"==m.type&&(o=[[]],i=a.target._latlngs,e=m.name,t=m.color,i.forEach((e,t)=>{o[t]=[e.lat,e.lng]}),(i=L.marker(a.target.pm._layer.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label>偏移距离(单位：m)</label><input id="offset-distance" name="offset-distance" value="50"/><br><div id="buttons"><button class="offset-save-reload-button">Save</button><button class="offset-save-button" data-color="'+t+'" data-name="'+e+'" data-line="'+JSON.stringify(o)+'">Offset</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),i.setOpacity(0),i.addTo(k),i.openTooltip()):(i.setLatLng(_),i.openTooltip())}),u.on("tooltipclose",function(e){C&&Ee(),$(".annotation-item[data-id="+m.id+"]").find(".annotation-name input").removeClass("annotation-focus")})}else if("Rectangle"==a.shape){var d=(await _supabase.from("objects").insert({room:I,color:N,initlat:a.layer._latlngs[0][0].lat,initlng:a.layer._latlngs[0][0].lng,user:F.id,type:"rectangle",session:x,name:"Rectangle",desc:"",distance:0,completed:!1,path:[]}).select("id"))["data"];O=d[0].id;for(var p=0;p<=3;p++)var{}=await _supabase.from("coords").insert({objects_id:d[0].id,lat:a.layer._latlngs[0][p].lat,lng:a.layer._latlngs[0][p].lng});S.push({id:O,local:!0,color:N,user:F.id,name:"Rectangle",desc:"",trigger:"",distance:0,layer:"",type:"rectangle",session:x,completed:!1}),C=!0;(m=S.filter(function(e){return e.id===O&&e.user===F.id})[0]).distance=parseFloat(turf.length(a.layer.toGeoJSON()).toFixed(2)),m.layer=a.layer,m.area=parseFloat((1e-6*turf.area(a.layer.toGeoJSON())).toFixed(2));var m,u,g=[],{}=(Object.values(a.layer.getLatLngs()[0]).forEach(function(e){g.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:g,area:m.area}).eq("id",O).select());(u=L.marker(a.layer.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="'+m.name+'" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),u.setOpacity(0),u.addTo(k),u.openTooltip(),$("#shape-name").focus(),$("#shape-name").select(),m.trigger=u,a.layer.on("click",async function(a){T||E||v||j||$("#offset-tool").hasClass("tool-active")&&"line"==m.type?E?(a.target.pm.enable({allowSelfIntersection:!1}),a.target.on("pm:edit",async e=>{var t,a=[];for(t in e.target.getLatLngs()[0])a.push(Object.values(e.target.getLatLngs()[0][t]));var{}=await _supabase.from("objects").update({area:m.area,distance:m.distance,path:a}).eq("id",m.id).select()})):j?a.target.on("pm:dragend",async e=>{var t,a=[];for(t in e.target.getLatLngs()[0])a.push(Object.values(e.target.getLatLngs()[0][t]));var{}=await _supabase.from("objects").update({area:m.area,distance:m.distance,path:a}).eq("id",m.id).select()}):T?layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("coords").delete().eq("objects_id",m.id))["error"],t=(await _supabase.from("objects").delete().eq("id",m.id))["error"];S=$.grep(S,function(e){return e.id!=m.id}),$(".annotation-item[data-id='"+m.id+"']").remove(),e||t?layer.msg("删除失败",{time:1e3}):(m.trigger.remove(),a.target.remove(),layer.msg("删除成功",{time:1e3}))}):v&&(a.target.pm.enableRotate(),a.target.on("pm:rotateend",async t=>{var a=[];for(let e=0;e<t.newLatLngs[0].length;e++)a[e]=[],a[e][0]=t.newLatLngs[0][e].lat,a[e][1]=t.newLatLngs[0][e].lng;var{}=await _supabase.from("objects").update({area:m.area,distance:m.distance,path:a}).eq("id",m.id).select()})):(u.setLatLng(_),u.openTooltip())}),u.on("tooltipclose",function(e){C&&Ee(),$(".annotation-item[data-id="+m.id+"]").find(".annotation-name input").removeClass("annotation-focus")})}else{a.layer._latlngs.forEach(function(e,t){0!=t&&(M+=a.layer._latlngs[t-1].distanceTo(e))}),b.setTooltipContent(M/1e3+"km | Double click to finish");var{}=await _supabase.from("coords").insert({objects_id:O,lat:f.lat,lng:f.lng})}}),k.on("pm:drawend",e=>{s=!1,b.closeTooltip()}),k.addEventListener("mousedown",async e=>{ne=!0;var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;_=[t,e],n&&Te(t,e,F)}),k.addEventListener("click",async e=>{var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;_=[t,e],async function(a,o,e){if(c&&!d){me();var t=L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+N+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]});(s=L.marker([a,o],{icon:t,direction:"top",interactive:!0,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Marker" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:0,y:-35})}),s.addTo(k),s.openTooltip();const{data:r,error:l}=await _supabase.from("objects").insert({room:I,color:N,lat:a,lng:o,user:e.id,type:"marker",m_type:"none",session:x,name:"Marker",desc:""}).select("id");var i=O=r[0].id,n=(S.push({id:O,user:e.id,color:N,name:"Marker",m_type:"none",desc:"",lat:a,lng:o,marker:s,trigger:s,session:x,completed:!0,type:"marker"}),s.on("tooltipclose",function(e){C?Ee():$(".annotation-item[data-id="+i+"]").find(".annotation-name input").removeClass("annotation-focus")}),{});n.id=i,s.on("click",async function(e){n.layer=e.target,T||j?j?e.target.on("pm:dragend",async e=>{var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",n.id).select()}):T&&layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e=(await _supabase.from("objects").delete().eq("id",n.id))["error"];S=$.grep(S,function(e){return e.id!=i}),l||e?layer.msg("删除失败",{time:1e3}):(n.layer.remove(),layer.msg("删除成功",{time:1e3}))}):s.openTooltip()})}else{var s;c&&d&&(me(),t=L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+N+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),s=L.marker([a,o],{icon:t,direction:"top",interactive:!0,pane:"overlayPane"}),layer.open({title:"导航",content:'<label for="shape-name">必须在手机浏览器中打开本项目才能导航！！目的地经纬度</label><p style="width:100%;height:5px"> 经度：'+o+"; 纬度："+a+'</p><label for="shape-desc">选择导航APP</label>',btn:["百度导航APP","高德导航APP","web端导航"],yes:function(e,t){goNavigation(a,o)},btn2:function(e,t){},btn3:function(e,t){},cancel:function(){}}),d=c=!1,s.addTo(k))}}(t,e,F),n&&Te(t,e,F)}),k.addEventListener("mouseup",e=>{ne=!1}),k.addEventListener("mousemove",async e=>{var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;_=[t,e],ne&&n&&(S.filter(function(e){return e.id===O&&e.user===F.id})[0].line.addLatLng([t,e]),(await _supabase.from("coords").insert({objects_id:O,lat:t,lng:e}))["error"]),s&&b.setTooltipContent(((M+f.distanceTo([t,e]))/1e3).toFixed(2)+"km | Double click to finish")}),k.addEventListener("zoom",async e=>{var{}=await _supabase.from("users").update({view:[k.getBounds().getCenter().lat,k.getBounds().getCenter().lng],zoom:k.getZoom()}).eq("uid",F.id).select();xe()}),k.addEventListener("movestart",e=>{0}),k.addEventListener("moveend",e=>{0}),$(document).keyup(function(e){$(e.target).is("input")||$(e.target).is("textarea")||("Escape"===e.key?g():"Enter"===e.key?a?Me():i&&Se():86==e.which?me():80==e.which?ue():69==e.which?ge():77==e.which?ve():76==e.which?fe():65==e.which?he():79==e.which?we():82==e.which?ye():67==e.which&&be())});var U=L.Util.template("https://dev.virtualearth.net/REST/v1/Imagery/Metadata/{imagerySet}?key={bingMapsKey}&include=ImageryProviders&uriScheme=https&c={culture}",{bingMapsKey:A,imagerySet:"Aerial",culture:"en-US"}),qe=5e3,Ae="callback";function Ze(t){try{delete window[t]}catch(e){window[t]=void 0}}function ze(e){e=document.getElementById(e);document.getElementsByTagName("head")[0].removeChild(e)}function Pe(){$("#overlay").hasClass("sign-show")&&$(".sign-show").removeClass("sign-show")}_fetch=function(i){var n=void 0===arguments[1]?{}:arguments[1],s=null!=n.timeout?n.timeout:qe,r=null!=n.jsonpCallback?n.jsonpCallback:Ae,l=void 0;return new Promise(function(t,e){var a=n.jsonpCallbackFunction||"jsonp_"+Date.now()+"_"+Math.ceil(1e5*Math.random()),o=(window[a]=function(e){t({ok:!0,json:function(){return Promise.resolve(e)}}),l&&clearTimeout(l),ze(r+"_"+a),Ze(a)},i+=-1===i.indexOf("?")?"?":"&",document.createElement("script"));o.setAttribute("src",i+r+"="+a),o.id=r+"_"+a,document.getElementsByTagName("head")[0].appendChild(o),l=setTimeout(function(){e(new Error("JSONP request to "+i+" timed out")),Ze(a),ze(r+"_"+a)},s)})}(U,{jsonpCallback:"jsonp"}).then(function(e){return e.json()}).then(function(e){if(200!==e.statusCode)throw new Error("Bing Imagery Metadata error: \n"+JSON.stringify(e,null,"  "));e=e.resourceSets[0].resources[0];return y._url=e.imageUrl,y._imageryProviders=e.imageryProviders||[],y.subdomains=e.imageUrlSubdomains,y}).catch(console.error),$(document).on("click",function(e){$("#more-menu").hasClass("menu-show")&&"more-vertical"!=$(e.target).attr("id")&&"more-vertical"!=$(e.target).parent().attr("id")&&$("#more-menu").removeClass("menu-show")}),$(document).on("click","#pen-tool",ue),$(document).on("click","#cursor-tool",me),$(document).on("click","#eraser-tool",ge),$(document).on("click","#rotate-tool",function(){g(),v=!0,$(".tool-active").removeClass("tool-active"),$("#rotate-tool").addClass("tool-active"),q()}),$(document).on("click","#profile-tool",function(){g(),h=!0,$(".tool-active").removeClass("tool-active"),$("#profile-tool").addClass("tool-active"),q()}),$(document).on("click","#marker-tool",ve),$(document).on("click","#text-tool",function(){g(),$(".tool-active").removeClass("tool-active"),$("#text-tool").addClass("tool-active"),k.pm.enableDraw("Text",{})}),$(document).on("click","#area-tool",he),$(document).on("click","#offset-tool",we),$(document).on("click","#navi-tool",function(){g(),c=!0,$(".tool-active").removeClass("tool-active"),$("#marker-tool").addClass("tool-active"),k.pm.enableDraw("Marker",{tooltips:!1,snappable:!0,templineStyle:{color:N},hintlineStyle:{color:N,dashArray:[5,5]}}),q(),d=!0}),$(document).on("click","#rectangle-tool",ye),$(document).on("click","#circle-tool",be),$(document).on("click","#path-tool",fe),$(document).on("click",".color",function(e){e.stopPropagation(),N=$(this).attr("data-color"),$("#inner-color").css({background:N}),Le()}),$(document).on("click","#inner-color",Le),$(document).on("mouseover",".tool",function(){"cursor-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Move (V)</div>'):"pen-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Pencil (P)</div>'):"eraser-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Eraser (E)</div>'):"marker-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Marker (M)</div>'):"text-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Text (T)</div>'):"area-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Area (A)</div>'):"path-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Line (L)</div>'):"edit-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Edit (ED)</div>'):"drag-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Drag (D)</div>'):"profile-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Profile (P)</div>'):"rectangle-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Rectangle (R)</div>'):"circle-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Circle (C)</div>'):"offset-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Offset (O)</div>'):"rotate-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Rotate (RO)</div>'):"navi-tool"==$(this).attr("id")&&$(this).append('<div id="tooltip">Navi (N)</div>')}),$(document).on("mouseout",".tool",function(){$(this).find("#tooltip").remove()}),$(document).on("click",".save-button",async function(e){C=!1;var t,a,o,i,n,s,r,l,c,d,p=S.filter(function(e){return e.id===O&&e.user===F.id})[0];p.name=w($("#shape-name").val()),p.desc=w($("#shape-desc").val()),p.completed=!0,p.trigger.unbindTooltip(),"area"==p.type?(p.trigger.bindTooltip("<h1>"+p.name+"</h1><h2>"+p.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+p.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+p.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:t,error:a}=await _supabase.from("objects").update({area:p.area,distance:p.distance,name:p.name,desc:p.desc,completed:!0}).eq("id",O).select()):"line"==p.type?(p.trigger.bindTooltip("<h1>"+p.name+"</h1><h2>"+p.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+p.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:o,error:i}=await _supabase.from("objects").update({distance:p.distance,name:p.name,desc:p.desc,completed:!0}).eq("id",O).select()):"marker"==p.type?(p.trigger.bindTooltip("<h1>"+p.name+"</h1><h2>"+p.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+p.lat.toFixed(5)+", "+p.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),{data:n,error:s}=await _supabase.from("objects").update({name:p.name,desc:p.desc,completed:!0}).eq("id",O).select()):"circle"==p.type?(p.trigger.bindTooltip("<h1>"+p.name+"</h1><h2>"+p.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+p.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+p.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:r,error:l}=await _supabase.from("objects").update({area:p.area,distance:p.distance,name:p.name,desc:p.desc,completed:!0}).eq("id",O).select()):"rectangle"==p.type&&(p.trigger.bindTooltip("<h1>"+p.name+"</h1><h2>"+p.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+p.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+p.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:c,error:d}=await _supabase.from("objects").update({area:p.area,distance:p.distance,name:p.name,desc:p.desc,completed:!0}).eq("id",O).select()),P(p),$(".annotation-item[data-id='"+p.id+"']").find(".annotation-name input").addClass("annotation-focus"),window.setTimeout(function(){p.trigger.openTooltip()},200)}),$(document).on("click",".offset-save-button",async function(e){var t=w($("#offset-distance").val()),a=JSON.parse(e.target.dataset.line),o=e.target.dataset.name,e=e.target.dataset.color,a=turf.lineString(a),i=turf.lineOffset(a,t,{units:"meters"}),a=parseFloat(turf.length(i,{units:"kilometers"}).toFixed(2)),e=(L.polyline(i.geometry.coordinates,{color:e}).addTo(k),await _supabase.from("objects").insert({room:I,color:e,initlat:i.geometry.coordinates[0][0],initlng:i.geometry.coordinates[0][1],user:F.id,type:"line",session:x,name:o+t,desc:"",distance:a,completed:!0,path:i.geometry.coordinates}).select("id"))["data"];O=e[0].id,S.push({id:O,local:!0,color:N,user:F.id,name:"Line",desc:"",trigger:"",distance:0,layer:"",type:"line",session:x,completed:!1});for(let e=0;e<i.geometry.coordinates.length;e++)var{}=await _supabase.from("coords").insert({objects_id:O,lat:i.geometry.coordinates[e][0],lng:i.geometry.coordinates[e][1]})}),$(document).on("click",".offset-save-reload-button",async function(){setTimeout(()=>{window.location.reload()},500)}),$(document).on("click","#hidden-tool",function(){"/static/supa-mapus/assets/tool.svg"==$("#hidden-tool").children().attr("src")?($("#hidden-tool").children().attr("src","/static/supa-mapus/assets/tool-hidden.svg"),$("#drawing-controls").css("display","none"),$("#search-box").css("display","none")):($("#hidden-tool").children().attr("src","/static/supa-mapus/assets/tool.svg"),$("#drawing-controls").css("display","block"),$("#search-box").css("display","block"))}),$(document).on("click",".avatars",async function(){var t=$(this).attr("data-id");t!=F.id&&(r.id==t?xe():(r.status=!0,r.id=t,$("#outline").css({border:"6px solid "+l.find(e=>e.id===t).color}),$("#observing-name").html("Observing "+l.find(e=>e.id===t).name),$("#observing-name").css({background:l.find(e=>e.id===t).color}),$("#outline").addClass("observing")))}),$(document).on("click",".annotation-arrow",function(e){e.preventDefault(),e.stopPropagation(),$(this).hasClass("arrow-open")?($(this).removeClass("arrow-open"),$(this).parent().parent().find(".annotation-details").addClass("annotation-closed")):($(this).addClass("arrow-open"),$(this).parent().parent().find(".annotation-details").removeClass("annotation-closed"))}),$(document).on("click",".annotation-item",function(){if(!$(this).find(".annotation-name input").hasClass("annotation-focus")){const t=$(this).attr("data-id");oe=t;var e=$.grep(S,function(e){return e.id==t})[0];$(".annotation-focus").removeClass("annotation-focus"),$(".annotation-description-focus").removeClass("annotation-description-focus"),k.eachLayer(function(e){"markerPane"!=e.options.pane&&e.closeTooltip()}),$(this).find(".annotation-name input").addClass("annotation-focus"),$(this).find(".annotation-details input").addClass("annotation-description-focus"),"line"==e.type||"area"==e.type||"circle"==e.type||"rectangle"==e.type?(k.panTo(e.trigger.getLatLng()),$(e.trigger.getTooltip()._container).removeClass("tooltip-off"),e.trigger.openTooltip()):"marker"==e.type?(k.panTo(e.marker.getLatLng()),$(e.marker.getTooltip()._container).removeClass("tooltip-off"),e.marker.openTooltip()):"text"==e.type&&k.panTo(e.trigger.getLatLng())}}),$(document).on("click",".room-item",function(){var e=$(this).attr("data-id");window.location="/mapus?file="+e}),$(document).on("mouseup",".annotation-focus",function(){$(".annotation-focus").select(),$(".annotation-focus").addClass("map-editing"),$(".annotation-focus").prop("disabled",!1)}),$(document).on("focusout",".annotation-focus",async function(){$(".annotation-focus").prop("disabled",!0),$(".annotation-focus").removeClass("map-editing");var e=w($(".annotation-focus").val());0==e.length?$(".annotation-focus").val(ie):(await _supabase.from("objects").update({name:e}).eq("id",parseInt(oe)))["error"]}),$(document).on("mouseup",".annotation-description-focus",function(){$(".annotation-description-focus").select(),$(".annotation-description-focus").addClass("map-editing"),$(".annotation-description-focus").prop("disabled",!1)}),$(document).on("focusout",".annotation-description-focus",async function(){$(".annotation-description-focus").prop("disabled",!0),$(".annotation-description-focus").removeClass("map-editing");var e=w($(".annotation-description-focus").val());0==e.length?$(".annotation-description-focus").val(ie):(await _supabase.from("objects").update({desc:e}).eq("id",parseInt(oe)))["error"]}),$(document).on("click",".delete-layer",async function(e){var{}=await _supabase.from("objects").select().eq("room","213");e.preventDefault(),e.stopPropagation();const a=$(this).parent().parent().attr("data-id"),o=$.grep(S,function(e){return e.id==a})[0];layer.confirm("确定要删除？",{btn:["取消","确定"],icon:3,title:"删除图形"},function(){layer.msg("取消删除",{time:1e3})},async function(){var e,t;"text"==o.type?(e=(await _supabase.from("objects").delete().eq("id",o.id))["error"],S=$.grep(S,function(e){return e.id!=o.id}),e?layer.msg("删除失败",{time:1e3}):($(".annotation-item[data-id='"+a+"']").remove(),o.layer?o.layer.remove():o.trigger&&o.trigger.remove(),layer.msg("删除成功",{time:1e3}))):"marker"==o.type?(e=(await _supabase.from("objects").delete().eq("id",o.id))["error"],S=$.grep(S,function(e){return e.id!=o.id}),e?layer.msg("删除失败",{time:1e3}):($(".annotation-item[data-id='"+a+"']").remove(),o.marker.remove(),layer.msg("删除成功",{time:1e3}))):(e=(await _supabase.from("coords").delete().eq("objects_id",o.id))["error"],t=(await _supabase.from("objects").delete().eq("id",o.id))["error"],S=$.grep(S,function(e){return e.id!=o.id}),e||t?layer.msg("删除失败",{time:1e3}):($(".annotation-item[data-id='"+a+"']").remove(),o.trigger.remove(),o.layer?o.layer.remove():o.line&&o.line.remove(),layer.msg("删除成功",{time:1e3})))})}),$(document).on("mousedown","#map-name",async function(e){3!=e.which||a||(te=t,a=!0,$("#map-name").prop("disabled",!1),$("#map-name").addClass("map-editing"))}),$(document).on("mouseup","#map-name",function(){$("#map-name").select(),$("#map-name").addClass("map-editing"),$("#map-name").prop("disabled",!1)}),$(document).on("focusout","#map-name",Me),$(document).on("mousedown","#map-description",async function(){i||(ae=o,i=!0,$("#map-description").prop("disabled",!1),$("#map-description").addClass("map-editing"))}),$(document).on("mouseup","#map-description",function(){$("#map-description").select(),$("#map-description").addClass("map-editing")}),$(document).on("focusout","#map-description",Se),$(document).on("click","#hide-annotations",function(){$("#hide-annotations").hasClass("hidden-annotations")?q():($(".leaflet-overlay-pane").css({visibility:"hidden","pointer-events":"none"}),$(".leaflet-tooltip-pane").css({visibility:"hidden","pointer-events":"none"}),$("#hide-annotations").addClass("hidden-annotations"),$("#hide-annotations").html("Show all"))}),$(document).on("click","#hidden-layer",function(a){var o,i,n;a.target.classList.contains("hidden-layer")?((i=a).target.classList.remove("hidden-layer"),i.target.src="/static/supa-mapus/assets/show.svg",n={opacity:1,fillOpacity:.2},$.each(S,(e,t)=>{S[e].id==i.target.dataset.id&&(S[e].layer||S[e].line).setStyle(n)})):(a.target.classList.add("hidden-layer"),a.target.src="/static/supa-mapus/assets/hide.svg",o={opacity:0,fillOpacity:0},$.each(S,(e,t)=>{S[e].id==a.target.dataset.id&&(S[e].layer||S[e].line).setStyle(o)})),$(S).each((e,t)=>{0==!S[e].direction&&P(S[e])})}),$(document).on("click","#location-control",function e(){xe(),navigator.geolocation&&(""!=p?navigator.geolocation.getCurrentPosition(function(e){p.setLatLng([e.coords.latitude,e.coords.longitude]),k.flyTo(p.getLatLng(),18)}):(pe(),e()))}),$(document).on("click",".find-nearby",async function(){var o=$(this).attr("data-type"),i=$(this).attr("data-color"),e=k.getBounds().getNorthWest().lng+","+k.getBounds().getNorthWest().lat+","+k.getBounds().getSouthEast().lng+","+k.getBounds().getSouthEast().lat;$.get("https://nominatim.openstreetmap.org/search?viewbox="+e+"&format=geocodejson&limit=20&bounded=1&amenity="+o+"&exclude_place_ids="+JSON.stringify(se),function(e){var a=L.icon({iconUrl:"/static/supa-mapus/assets/"+o+"-marker.svg",iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]});e.features.forEach(function(e){var t=L.marker([e.geometry.coordinates[1],e.geometry.coordinates[0]],{icon:a,pane:"overlayPane",interactive:!0}).addTo(k);t.bindTooltip("<h1>"+e.properties.geocoding.name+'</h1><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.geometry.coordinates[1].toFixed(5)+", "+e.geometry.coordinates[0].toFixed(5)+'</h3></div><br><div id="buttons2"><button class="cancel-button-place" data-id='+e.properties.geocoding.place_id+'>Remove</button><button class="save-button-place" data-id='+e.properties.geocoding.place_id+'>Save</button></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),m.push({id:"",place_id:e.properties.geocoding.place_id,user:F.id,name:e.properties.geocoding.name,desc:"",lat:e.geometry.coordinates[1],lng:e.geometry.coordinates[0],trigger:t,completed:!0,marker:t,m_type:o,type:"marker",session:x,color:i}),se.push(e.properties.geocoding.place_id)})})}),$(document).on("click",".save-button-place",async function(){var e=m.find(e=>e.place_id==$(this).attr("data-id")),t=(await _supabase.from("objects").insert({color:e.color,place_id:e.place_id,lat:e.lat,lng:e.lng,user:F.id,type:"marker",m_type:e.m_type,session:x,name:e.name,desc:""}).select("id"))["data"];O=t[0].id,e.id=O,S.push(e),e.marker.bindTooltip("<h1>"+e.name+'</h1><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+'</h3></div><br><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})})}),$(document).on("click",".cancel-button-place",function(){var t=m.find(e=>e.place_id==$(this).attr("data-id"));t.marker.remove(),m=$.grep(m,function(e){return e.place_id!=t.id}),se=$.grep(se,function(e){return e!=t.id})}),$(document).on("click","#more-vertical",function(){$("#more-menu").hasClass("menu-show")?$("#more-menu").removeClass("menu-show"):$("#more-menu").addClass("menu-show")}),$(document).on("click","#geojson",function(){var e=Ne(k),o={type:"FeatureCollection",features:[]},e=(e.forEach(function(e){var t,a=JSON.parse(JSON.stringify(e.toGeoJSON()));a.properties||(a.properties={}),a.properties=JSON.parse(JSON.stringify(e.options)),e.options.radius&&(t=parseFloat(e.options.radius),a.properties.radius=t%1!=0?t.toFixed(6):t.toFixed(0)),e instanceof L.Rectangle?a.properties.type="rectangle":e instanceof L.Circle?a.properties.type="circle":e instanceof L.CircleMarker?a.properties.type="circlemarker":e instanceof L.Polygon?a.properties.type="polygon":e instanceof L.Polyline?a.properties.type="polyline":e instanceof L.Marker&&(a.properties.type="marker"),o.features.push(a)}),document.createElement("a")),t=new Blob([JSON.stringify(o)],{type:"application/json"});e.href=URL.createObjectURL(t),e.download="geojson",e.click()}),$(document).on("click","#search-box img",Ce),$(document).on("click","#google-signin-2",async function(){var e=w($("#email").val()),t=w($("#password").val());const a=(await _supabase.auth.signInWithPassword({email:e,password:t}))["error"];null==a&&Pe();e=(await _supabase.auth.getUser()).data.user;if(F=e,u.has("file")){$(".signin").removeClass("signin");var o,i,t=ce[Math.floor(Math.random()*ce.length)],e=(await _supabase.from("users").select().eq("uid",F.id))["data"];0==e.length?{data:o,error:i}=await _supabase.from("users").insert({room:I,uid:F.id,lat:0,lng:0,active:!0,color:t,name:F.email,view:[k.getBounds().getCenter().lat,k.getBounds().getCenter().lng],zoom:k.getZoom()}).select("id"):(await _supabase.from("users").update({lat:0,lng:0,active:!0,color:t,name:F.email,view:[k.getBounds().getCenter().lat,k.getBounds().getCenter().lng],zoom:k.getZoom()}).eq("uid",F.id))["error"],window.setTimeout(async function(){var e=(await _supabase.from("users").select().eq("uid",F.id))["data"];x=e.session},100),Re()}else{const{data:n,error:a}=await _supabase.from("rooms").select();n.forEach(function(e,t){$("#room-list").prepend('<div class="room-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg"> <input value='+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.description+' disabled class="annotation-description"></div></div>')}),$("#sign").removeClass("signin"),$("#popup").find(".header-text").html("Create a map"),$("#popup").find(".subheader-text").html("Maps can be shared with friends to collaborate in real-time."),$("#google-signin").attr("id","create-map"),$(".create-map").html("Create a map"),$("#popup").addClass("signin")}}),$(document).on("click","#create-map",async function(){var e=(e=(await _supabase.from("rooms").insert({name:"New map",description:"Map description"}).select("id"))["data"])[0].id;window.location.replace(window.location.href+"?file="+e)}),$(document).on("click","#logout",async function(){var{}=await _supabase.auth.signOut().then(function(){$("#popup").addClass("signin"),$("#overlay").addClass("signin")})}),$(document).on("click","#share-button",function(){$("#share").addClass("share-show"),$("#overlay").addClass("share-show")}),$(document).on("click","#overlay",Oe),$(document).on("click","#close-share",Oe),$(document).on("click","#share-copy",function(){$("#share-url").focus(),$("#share-url").select(),document.execCommand("copy")}),$(document).on("click","#zoom-in",function(){k.zoomIn()}),$(document).on("click","#zoom-out",function(){k.zoomOut()}),$(document).on("click","#sign-button",function(){$("#sign").addClass("sign-show"),$("#overlay").addClass("sign-show")}),$(document).on("click","#clear-button",async function(){var{data:e,error:t}=await _supabase.from("rooms").select(),a=(console.log("保留的room数据：",e,t),[]),{data:t,error:e}=(e.forEach((e,t)=>{a[t]=e.id}),await _supabase.from("objects").select().not("room","in","("+a.join(",")+")"));console.log("待删除objects数据：",t,e),t.forEach(async function(e,t){var{}=await _supabase.from("coords").delete().eq("objects_id",e.id),{}=await _supabase.from("objects").delete().eq("id",e.id)})}),$(document).on("click","#clear-coords-button",async function(){var e=(await _supabase.from("objects").select())["data"],a=[],{data:e,error:t}=(e.forEach((e,t)=>{a[t]=e.id}),await _supabase.from("coords").select().not("objects_id","in","("+a.join(",")+")"));console.log("待删除的coords数据：",e,t),e.forEach(async function(e,t){var{}=await _supabase.from("coords").delete().eq("objects_id",e.objects_id)})}),$(document).on("click","#close-sign",Pe),$(document).on("click","#importgeojson",function(){$('<input type="file" value="选择文件"></input>').click().on("change",e=>{e=e.target.files[0];let t=new FileReader;t.onload=()=>{var e=t.result;!async function(w){var a={radius:8,fillColor:"#ff7800",color:N,weight:1,opacity:1,fillOpacity:.8};L.geoJSON(w.features,{pointToLayer:function(e,t){return L.circleMarker(t,a)}}).addTo(k),w.features.forEach(async function(o,e){var t,a,i,n,s,r,l,c,d,p,m,u,g,v,h,f,y=o.geometry.coordinates[0],b=o.geometry.coordinates[o.geometry.coordinates.length-1];"LineString"!=o.geometry.type||y[0]==b[0]&&y[1]==b[1]?"LineString"==o.geometry.type&&y[0]==b[0]&&y[1]==b[1]?(p=[],m="polygon",u="area",M=0,g=o.geometry.coordinates.length,o.geometry.coordinates.forEach(function(e,t){var a;0!=t&&(t=L.latLng(o.geometry.coordinates[t-1][1],o.geometry.coordinates[t-1][0]),a=L.latLng(e[1],e[0]),M+=t.distanceTo(a)),p.push([e[1],e[0]])}),a=turf.polygon([o.geometry.coordinates]),i=turf.area(a),n=parseFloat((1e-6*i).toFixed(2)),{data:y,error:t}=(o.properties.description&&(m=o.properties.description),w.name&&(u=w.name),w.name&&o.properties.Layer&&(u=w.name+"-"+o.properties.Layer),w.name&&o.properties.Name&&(u=w.name+"-"+o.properties.Name),await _supabase.from("objects").insert({room:I,color:N,initlat:o.geometry.coordinates[0][1],initlng:o.geometry.coordinates[0][0],user:F.id,type:"area",session:x,name:u,desc:m,distance:parseFloat((M/1e3).toFixed(3)),area:n,completed:!0,path:p}).select("id")),(O=y[0].id,await _supabase.from("coords").insert({objects_id:y[0].id,lat:o.geometry.coordinates[g-1][1],lng:o.geometry.coordinates[g-1][0]}))["error"],S.push({id:O,local:!0,color:N,user:F.id,name:u,desc:m,trigger:"",distance:parseFloat((M/1e3).toFixed(3)),area:n,layer:"",type:"area",session:x,completed:!0}),C=!0,h=S.filter(function(e){return e.id===O&&e.user===F.id})[0],(f=L.marker(k.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Line" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),$("#shape-name").focus(),$("#shape-name").select(),h.trigger=f):"Polygon"==o.geometry.type?(p=[],m="polygon",u="area",M=0,g=o.geometry.coordinates[0].length,o.geometry.coordinates[0].forEach(function(e,t){var a;0!=t&&(t=L.latLng(o.geometry.coordinates[0][t-1][1],o.geometry.coordinates[0][t-1][0]),a=L.latLng(e[1],e[0]),M+=t.distanceTo(a)),p.push([e[1],e[0]])}),a=turf.polygon(o.geometry.coordinates),i=turf.area(a),n=parseFloat((1e-6*i).toFixed(2)),{data:b,error:s}=(o.properties.description&&(m=o.properties.description),w.name&&(u=w.name),w.name&&o.properties.Layer&&(u=w.name+"-"+o.properties.Layer),w.name&&o.properties.Name&&(u=w.name+"-"+o.properties.Name),await _supabase.from("objects").insert({room:I,color:N,initlat:o.geometry.coordinates[0][0][1],initlng:o.geometry.coordinates[0][0][0],user:F.id,type:"area",session:x,name:u,desc:m,distance:parseFloat((M/1e3).toFixed(3)),area:n,completed:!0,path:p}).select("id")),(O=b[0].id,await _supabase.from("coords").insert({objects_id:b[0].id,lat:o.geometry.coordinates[0][g-1][1],lng:o.geometry.coordinates[0][g-1][0]}))["error"],S.push({id:O,local:!0,color:N,user:F.id,name:u,desc:m,trigger:"",distance:parseFloat((M/1e3).toFixed(3)),area:n,layer:"",type:"area",session:x,completed:!0}),C=!0,h=S.filter(function(e){return e.id===O&&e.user===F.id})[0],(f=L.marker(k.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Line" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),$("#shape-name").focus(),$("#shape-name").select(),h.trigger=f):"Point"==o.geometry.type&&(o.properties.Text||o.properties.text?(m="",{data:r,error:l}=(o.properties.Text?m=o.properties.Text:o.properties.text&&(m=o.properties.text),o.properties.description&&(m=o.properties.description),w.name&&(m=w.name),w.name&&o.properties.Layer&&(m=w.name+"-"+o.properties.Layer),w.name&&o.properties.Text&&(m=w.name+"-"+o.properties.Text),w.name&&o.properties.text&&(m=w.name+"-"+o.properties.text),L.marker([o.geometry.coordinates[1],o.geometry.coordinates[0]],{textMarker:!0,text:m}).addTo(k),await _supabase.from("objects").insert({room:I,color:N,lat:o.geometry.coordinates[1],lng:o.geometry.coordinates[0],user:F.id,type:"text",m_type:"none",session:x,name:"Text",desc:m,completed:!0}).select("id"))):0<o.geometry.coordinates[1]&&(m="point",u="marker",{data:c,error:d}=(o.properties.description&&(m=o.properties.description),w.name&&(u=w.name),w.name&&o.properties.Layer&&(u=w.name+"-"+o.properties.Layer),w.name&&o.properties.Name&&(u=w.name+"-"+o.properties.Name),await _supabase.from("objects").insert({room:I,color:N,lat:o.geometry.coordinates[1],lng:o.geometry.coordinates[0],user:F.id,type:"marker",m_type:"none",session:x,name:u,desc:m,completed:!0}).select("id")))):(p=[],m="linestring",u="line",M=0,g=o.geometry.coordinates.length,{data:y,error:v}=(o.geometry.coordinates.forEach(function(e,t){var a;0!=t&&(t=L.latLng(o.geometry.coordinates[t-1][1],o.geometry.coordinates[t-1][0]),a=L.latLng(e[1],e[0]),M+=t.distanceTo(a)),p.push([e[1],e[0]])}),o.properties.description&&(m=o.properties.description),w.name&&(u=w.name),w.name&&o.properties.Layer&&(u=w.name+"-"+o.properties.Layer),w.name&&o.properties.Name&&(u=w.name+"-"+o.properties.Name),await _supabase.from("objects").insert({room:I,color:N,initlat:o.geometry.coordinates[0][1],initlng:o.geometry.coordinates[0][0],user:F.id,type:"line",session:x,name:u,desc:m,distance:parseFloat((M/1e3).toFixed(3)),completed:!0,path:p}).select("id")),(O=y[0].id,await _supabase.from("coords").insert({objects_id:y[0].id,lat:o.geometry.coordinates[g-1][1],lng:o.geometry.coordinates[g-1][0]}))["error"],S.push({id:O,local:!0,color:N,user:F.id,name:u,desc:m,trigger:"",distance:parseFloat((M/1e3).toFixed(3)),layer:"",type:"line",session:x,completed:!0}),C=!0,h=S.filter(function(e){return e.id===O&&e.user===F.id})[0],(f=L.marker(k.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Line" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),$("#shape-name").focus(),$("#shape-name").select(),h.trigger=f,T||E||j||(f.setLatLng(_),f.openTooltip()),f.on("tooltipclose",function(e){C&&Ee(),$(".annotation-item[data-id="+O+"]").find(".annotation-name input").removeClass("annotation-focus")}))})}(JSON.parse(e))},t.readAsText(e,"UTF-8")})}),$(document).on("click","#xmltogeojson",function(){$('<input type="file" value="选择文件"></input>').click().on("change",e=>{var e=e.target.files[0],t=e.name,l=t.substring(0,t.lastIndexOf("."));let c=new FileReader;c.onload=()=>{var e=c.result.split(/\r\n|\n/);let t="";e.map(e=>{e.length&&!e.startsWith(";")&&(-1!==e.indexOf("<Placemark")&&(t+="{"),t+=e,-1!==e.indexOf("</Placemark"))&&(t+="}")});var a=t.split("}"),o={type:"FeatureCollection",name:"",features:[]};t.split("<Folder")[2]&&t.split("<Folder")[2].split("<name")[1].split("</name")[0]&&(o.name=t.split("<Folder")[2].split("<name>")[1].split("</name")[0]);for(let e=0;e<a.length;e++)if(a[e].split("<Placemark")[1]){var i,n=a[e].split("<coordinates>")[1].split("</coordinates>")[0].split(/ |,/);if(a[e].split("<LineString>")[1]){var s=[];for(let e=0;e<n.length;e+=1)""!=n[e]&&""!=n[e+1]&&""!=n[e+2]&&s.push([Number(n[e]),Number(n[e+1]),Number(n[e+2])]);o.features.push({type:"Feature",properties:{Name:a[e].split("<Placemark")[1].split("<name>")[1].split("</name>")[0]},geometry:{type:"LineString",coordinates:s}})}else if(a[e].split("<Polygon>")[1]){s=[[]];for(let e=0;e<n.length;e+=1)""!=n[e]&&""!=n[e+1]&&""!=n[e+2]&&s[0].push([Number(n[e]),Number(n[e+1]),Number(n[e+2])]);o.features.push({type:"Feature",properties:{Name:a[e].split("<Placemark")[1].split("<name>")[1].split("</name>")[0]},geometry:{type:"Polygon",coordinates:s}})}else if(a[e].split("<Rectangle>")[1]){s=[[]];for(let e=0;e<n.length;e+=1)""!=n[e]&&""!=n[e+1]&&""!=n[e+2]&&s[0].push([Number(n[e]),Number(n[e+1]),Number(n[e+2])]);o.features.push({type:"Feature",properties:{Name:a[e].split("<Placemark")[1].split("<name>")[1].split("</name>")[0]},geometry:{type:"Rectangle",coordinates:s}})}else a[e].split("<Point>")[1]&&(i=a[e].split("<coordinates>")[1].split("</coordinates>")[0].split(","),o.features.push({type:"Feature",properties:{Name:a[e].split("<Placemark")[1].split("<name>")[1].split("</name>")[0]},geometry:{type:"Point",coordinates:[Number(i[0]),Number(i[1])]}}))}var e=document.createElement("a"),r=new Blob([JSON.stringify(o)],{type:"application/json"});e.href=URL.createObjectURL(r),e.download=l,e.click()},c.readAsText(e,"UTF-8")})}),$(document).on("click","#downloadmap",function(){re=!0,$("#chooseTileZoom").addClass("chooseTileZoom-show"),$("#overlay").addClass("chooseTileZoom-show")}),$(document).on("click","#close-choosetilezoom",function(){$("#overlay").hasClass("chooseTileZoom-show")&&$(".chooseTileZoom-show").removeClass("chooseTileZoom-show"),k.pm.disableDraw()}),$(document).on("click","#draw-rectangle",function(){$("#chooseTileZoom").removeClass("chooseTileZoom-show"),$("#overlay").removeClass("chooseTileZoom-show"),k.pm.enableDraw("Rectangle",{finishOn:"dblclick",allowSelfIntersection:!1,tooltips:!1})}),$(document).on("click","#edit-tool",function(){g(),E=!0,$(".tool-active").removeClass("tool-active"),$("#edit-tool").addClass("tool-active"),q()}),$(document).on("click","#drag-tool",function(){g(),j=!0,$(".tool-active").removeClass("tool-active"),$("#drag-tool").addClass("tool-active"),k.pm._globalDragModeEnabled||k.pm.toggleGlobalDragMode(),q()}),$(document).on("keydown","#search-input",function(e){"Enter"===e.key&&Ce()}),pe()});