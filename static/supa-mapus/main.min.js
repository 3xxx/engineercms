$(document).ready(function(){var q="AhJFIXaWTfryahNRyQFR6gKLDqmxB34-FGH6VB5VYas4YJWgO1_bQT6WLWYWQD0g",v=L.map("mapDiv",{fullscreenControl:!1,minimapControl:!1,gestureHandling:!1,resizerControl:!1,pegmanControl:!1,locateControl:!1,loadingControl:!1,searchControl:!1,preferCanvas:!1,rotate:!0,rotateControl:{closeOnZeroBearing:!0}}).setView([23.125178,113.280637],12);let Z={options:{position:"topright",theme:"lime-theme",detached:!1,collapsed:!0,autohide:!1,legend:!0,downloadLink:!0,almostOver:!0,distanceMarkers:!0}},z={options:{collapsed:!0}},D=L.control.elevation(Z.options).addTo(v),B=L.control.layers(null,null,z.options);D.on("eledata_loaded",({layer:e,name:t})=>B.addTo(v)&&e.eachLayer(e=>"Point"!=e.feature.geometry.type&&B.addOverlay(e,e.feature&&e.feature.properties&&e.feature.properties.name||t)));var Y=L.tileLayer.bing(q).addTo(v),U=L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",{id:"mapbox/streets-v11",tileSize:512,zoomOffset:-1,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:23,maxNativeZoom:19}),G=(L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,maxNativeZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),L.tileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"&copy; Esri &mdash; Sources: Esri, DigitalGlobe, Earthstar Geographics, CNES/Airbus DS, GeoEye, USDA FSA, USGS, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community"})),X="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",X=L.tileLayer(X,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),W="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",W=L.tileLayer(W,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),J="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",J=L.tileLayer(J,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),V="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/cva_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",V=L.tileLayer(V,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),H="http://t"+Math.round(7*Math.random())+".tianditu.gov.cn/ter_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=ter&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=49fb5337e67fda377699448c7b670eef",H=L.tileLayer(H,{attribution:"stamen",maxZoom:23,maxNativeZoom:18}),Q=L.tileLayer("http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19}),K=L.tileLayer("https://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19}),ee=L.tileLayer("https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",{minzoom:5,maxzoom:23,maxNativeZoom:15,tileSize:256}),t=(L.control.layers({Bing:Y,ArcGIS:G,"天地图-影像":X,"天地图-矢量":J,"天地图-地形":H,"OpenStreetMap黑色":Q,"OpenStreetMap正常":K,"mapbox Streets":U},{"天地图-矢量注记":V,"天地图-影像注记":W,"广东省高程":ee},{position:"topleft"}).addTo(v),L.Measure={linearMeasurement:"Distance measurement",areaMeasurement:"Area measurement",start:"开始",meter:"m",kilometer:"km",squareMeter:"m²",squareKilometers:"km²"},L.control.measure({}).addTo(v),""),te="",o="",ae="",a=!1,n=!1,i="",oe="",h=!1,f=[0,0],b=0,s=!1,y=!1,w=!1,k=!1,u=!1,ne=!1,r=!1,l=[0,0],c={status:!1,id:0},C=0,ie=!1,T=[],x=0,_="#634FF1",d=[],p="",m=[],g=[],E="",se=!1,re=new Array,M={},j=new Object,le=["#EC1D43","#EC811D","#ECBE1D","#B6EC1D","#1DA2EC","#781DEC","#CF1DEC","#222222"],S=new URLSearchParams(window.location.search);S.has("file")&&(E=S.get("file"),$("#share-url").val(window.location.href)),window.setTimeout(async function(){var e,t;await we()&&S.has("file")?xe():((await we()&&!S.has("file")?($("#popup").find(".header-text").html("Create a map"),$("#popup").find(".subheader-text").html("Maps can be shared with friends to collaborate in real-time."),$("#google-signin").attr("id","create-map"),$(".create-map").html("Create a map"),{data:e,error:t}=await _supabase.from("rooms").select(),e.forEach(function(e,t){$("#room-list").prepend('<div class="room-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg"> <input value='+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.description+' disabled class="annotation-description"></div></div>')}),$("#popup")):($("#popup").removeClass("signin"),$("#sign"))).addClass("signin"),$("#overlay").addClass("signin"))},500);L.control.scale();L.control.scale({metric:!0,imperial:!1}).addTo(v);const ce={token:"pk.eyJ1IjoidHlwZWJyb29rIiwiYSI6ImNqNHVyaTc5dDBuazczMm1jenl3cG8wb3IifQ.2UEZ-jiHgHvYYqVirXhgpw",tilesUrl:"https://api.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.pngraw?access_token=pk.eyJ1IjoidHlwZWJyb29rIiwiYSI6ImNqNHVyaTc5dDBuazczMm1jenl3cG8wb3IifQ.2UEZ-jiHgHvYYqVirXhgpw"};(new(L.Control.extend({onAdd(){const t=L.DomUtil.create("div");return t.style.width="100px",t.style.background="rgba(255,255,255,0.5)",t.style.textAlign="left",v.on("zoomstart zoom zoomend",e=>{t.innerHTML="Zoom level: "+v.getZoom()}),t}}))).addTo(v);v.pm.addControls();var O=L.marker([0,0],{pane:"overlayPane",interactive:!1}).addTo(v);O.setOpacity(0),O.bindTooltip("",{permanent:!0,offset:[5,25],sticky:!0,className:"hints",direction:"right"}).addTo(v);function de(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t=L.icon({iconUrl:"/static/supa-mapus/assets/liveLocation.svg",iconSize:[24,24],iconAnchor:[12,12]});(p=L.marker([e.coords.latitude,e.coords.longitude],{icon:t,pane:"overlayPane"})).addTo(v)})}function I(){r=ne=k=w=u=y=s=!1,v.pm.disableDraw(),v.pm._globalRemovalModeEnabled&&v.pm.disableGlobalRemovalMode(),v.pm._globalDragModeEnabled&&v.pm.toggleGlobalDragMode(),v.eachLayer(function(e){"markerPane"!=e.options.pane&&e.closeTooltip()})}function pe(){I(),v.dragging.enable(),$(".tool-active").removeClass("tool-active"),$("#cursor-tool").addClass("tool-active")}function me(){I(),s=!0,v.dragging.disable(),$(".tool-active").removeClass("tool-active"),$("#pen-tool").addClass("tool-active"),P()}function ue(){I(),y=!0,$(".tool-active").removeClass("tool-active"),$("#eraser-tool").addClass("tool-active"),v.pm.enableGlobalRemovalMode(),P()}function ge(){I(),ne=!0,$(".tool-active").removeClass("tool-active"),$("#marker-tool").addClass("tool-active"),v.pm.enableDraw("Marker",{tooltips:!1,snappable:!0,templineStyle:{color:_},hintlineStyle:{color:_,dashArray:[5,5]}}),P()}function ve(){I(),$(".tool-active").removeClass("tool-active"),$("#area-tool").addClass("tool-active"),v.pm.setGlobalOptions({pinning:!0,snappable:!0}),v.pm.setPathOptions({color:_,fillColor:_,fillOpacity:.4}),v.pm.enableDraw("Polygon",{tooltips:!1,snappable:!0,templineStyle:{color:_},hintlineStyle:{color:_,dashArray:[5,5]}}),P()}function he(){I(),$(".tool-active").removeClass("tool-active"),$("#path-tool").addClass("tool-active"),v.pm.setGlobalOptions({pinning:!0,snappable:!0}),v.pm.setPathOptions({color:_,fillColor:_,fillOpacity:.4}),v.pm.enableDraw("Line",{tooltips:!1,snappable:!0,templineStyle:{color:_},hintlineStyle:{color:_,dashArray:[5,5]},finishOn:"dblclick"}),P()}function fe(){$("#color-list").toggleClass("color-enabled")}function N(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return e.replace(/[&<>"'/]/gi,e=>t[e])}function be(){$.ajax({type:"GET",async:!1,url:"/v1/wx/tianditusearch",data:{keyword:N($("#search-box input").val())},success:function(e){v.panTo(new L.LatLng(e.lat,e.lon))}})}function A(){c.status=!1,$("#outline").css({border:"none"}),$("#outline").removeClass("observing")}async function ye(t,a,o){var n=L.polyline([[t,a]],{color:_}),i=(await _supabase.from("objects").insert({room:E,color:_,initlat:t,initlng:a,user:o.id,type:"draw",session:b,completed:!0}).select("id"))["data"],{}=(x=i[0].id,await _supabase.from("coords").insert({objects_id:i[0].id,lat:t,lng:a}));T.push({id:x,user:o.id,line:n,session:b,local:!0,completed:!0,type:"draw"}),n.addTo(v),T.forEach(function(n){n.line.on("click",async function(t){var a,o;y?(n.line.remove(),a=(await _supabase.from("coords").delete().eq("objects_id",n.id))["error"],o=(await _supabase.from("objects").delete().eq("id",n.id))["error"],T=$.grep(T,function(e){return e.id!=n.id}),$(".annotation-item[data-id='"+n.id+"']").remove()):w&&(e.target.pm.enable({}),e.target.on("pm:edit",e=>{console.log(e.target._latlngs),console.log(e.target.getLatLngs()),console.log(n.id)}))}),n.line.on("mouseover",function(e){y&&n.line.setStyle({opacity:.3})}),n.line.on("mouseout",function(e){n.line.setStyle({opacity:1})})})}async function R(){h=!1;var e,t,a,o,n,i,s=T.filter(function(e){return e.id===x&&e.user===j.id})[0];s.trigger.unbindTooltip(),s.completed=!0,"area"==s.type?(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+s.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+s.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:e,error:t}=await _supabase.from("objects").update({area:s.area,distance:s.distance,name:s.name,desc:s.desc,completed:!0}).eq("id",x).select()):"line"==s.type?(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+s.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:a,error:o}=await _supabase.from("objects").update({distance:s.distance,name:s.name,desc:s.desc,completed:!0}).eq("id",x).select()):"marker"==s.type&&(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+s.lat.toFixed(5)+", "+s.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),{data:n,error:i}=await _supabase.from("objects").update({name:s.name,desc:s.desc,completed:!0}).eq("id",x).select()),F(s),$(".annotation-item[data-id='"+s.id+"']").find(".annotation-name input").addClass("annotation-focus"),window.setTimeout(function(){s.trigger.openTooltip()},200)}async function we(){var{user:e}=(await _supabase.auth.getUser())["data"];return null!=(j=e)&&j}function F(e){var t;0==$(".annotation-item[data-id='"+e.id+"']").length?"line"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M14.5 8.5L8.5 14.5" stroke="white" stroke-width="1.5" stroke-linecap="square"/><path d="M15.8108 8.53378C16.7176 8.53378 17.4527 7.79868 17.4527 6.89189C17.4527 5.9851 16.7176 5.25 15.8108 5.25C14.904 5.25 14.1689 5.9851 14.1689 6.89189C14.1689 7.79868 14.904 8.53378 15.8108 8.53378Z" stroke="white" stroke-width="1.5"/><circle cx="6.89189" cy="15.8108" r="1.64189" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/distance-icon.svg">'+e.distance+" km</div></div></div></div>")):"area"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M15.3652 8.5V13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M8.5 15.3649H13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M14.5303 9.03033C14.8232 8.73744 14.8232 8.26256 14.5303 7.96967C14.2374 7.67678 13.7626 7.67678 13.4697 7.96967L14.5303 9.03033ZM7.96967 13.4697C7.67678 13.7626 7.67678 14.2374 7.96967 14.5303C8.26256 14.8232 8.73744 14.8232 9.03033 14.5303L7.96967 13.4697ZM13.4697 7.96967L7.96967 13.4697L9.03033 14.5303L14.5303 9.03033L13.4697 7.96967Z" fill="white"/><circle cx="15.365" cy="6.85135" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="15.365" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="6.85135" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div></div></div></div>")):"marker"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M16.0252 11.2709C16.0252 14.8438 11.3002 17.9063 11.3002 17.9063C11.3002 17.9063 6.5752 14.8438 6.5752 11.2709C6.5752 10.0525 7.07301 8.8841 7.95912 8.0226C8.84522 7.16111 10.047 6.67712 11.3002 6.67712C12.5533 6.67712 13.7552 7.16111 14.6413 8.0226C15.5274 8.8841 16.0252 10.0525 16.0252 11.2709Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.2996 12.8021C12.1695 12.8021 12.8746 12.1166 12.8746 11.2709C12.8746 10.4252 12.1695 9.73962 11.2996 9.73962C10.4298 9.73962 9.72461 10.4252 9.72461 11.2709C9.72461 12.1166 10.4298 12.8021 11.2996 12.8021Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div></div></div></div>")):"text"==e.type&&(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M16.0252 11.2709C16.0252 14.8438 11.3002 17.9063 11.3002 17.9063C11.3002 17.9063 6.5752 14.8438 6.5752 11.2709C6.5752 10.0525 7.07301 8.8841 7.95912 8.0226C8.84522 7.16111 10.047 6.67712 11.3002 6.67712C12.5533 6.67712 13.7552 7.16111 14.6413 8.0226C15.5274 8.8841 16.0252 10.0525 16.0252 11.2709Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.2996 12.8021C12.1695 12.8021 12.8746 12.1166 12.8746 11.2709C12.8746 10.4252 12.1695 9.73962 11.2996 9.73962C10.4298 9.73962 9.72461 10.4252 9.72461 11.2709C9.72461 12.1166 10.4298 12.8021 11.2996 12.8021Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div></div></div></div>")):(t=$(".annotation-item[data-id='"+e.id+"']"),"line"==e.type?(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/distance-icon.svg">'+e.distance+" km</div>")):"area"==e.type?(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div>")):"marker"!=e.type&&"text"!=e.type||(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div>")))}async function $e(){a=!1,$("#map-name").prop("disabled",!0),$("#map-name").removeClass("map-editing");var e,t=N($("#map-name").val());0==t.length?$("#map-name").val(te):e=(await _supabase.from("rooms").update({name:t}).eq("id",E))["error"]}async function Le(){n=!1,$("#map-description").prop("disabled",!0),$("#map-description").removeClass("map-editing");var e,t=N($("#map-description").val());0==t.length?$("#map-description").val(ae):e=(await _supabase.from("rooms").update({description:t}).eq("id",E))["error"]}function P(){$(".leaflet-overlay-pane").css({visibility:"visible","pointer-events":"all"}),$(".leaflet-tooltip-pane").css({visibility:"visible","pointer-events":"all"}),$("#hide-annotations").removeClass("hidden-annotations"),$("#hide-annotations").html("Hide all")}function ke(){$("#overlay").hasClass("share-show")&&$(".share-show").removeClass("share-show")}async function Ce(e,t){var a;t!=j.id&&(e.active?d.find(e=>e.id===t)?(d.find(e=>e.id===t).cursor.setLatLng([e.lat,e.lng]),1==c.status&&t==c.id&&(v.setZoom(e.zoom),v.panTo(new L.LatLng(e.view[0],e.view[1])))):(a=L.divIcon({html:'<svg width="18" height="18" style="z-index:9999!important" viewBox="0 0 18 18" fill="none" style="background:none;" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.51169 15.8783L1.08855 3.64956C0.511984 2.05552 2.05554 0.511969 3.64957 1.08853L15.8783 5.51168C17.5843 6.12877 17.6534 8.51606 15.9858 9.23072L11.2573 11.2573L9.23074 15.9858C8.51607 17.6534 6.12878 17.5843 5.51169 15.8783Z" fill="'+e.color+'"/></svg>',iconSize:[22,22],iconAnchor:[0,0],shadowAnchor:[4,62],popupAnchor:[-3,-76],className:"cursoricon"}),(a=L.marker([e.lat,e.lng],{icon:a,pane:"markerPane"})).bindTooltip(e.name,{permanent:!0,offset:[14,32],className:"cursor-label color"+e.color.replace("#",""),direction:"right"}),a.addTo(v),d.push({id:t,cursor:a,color:e.color,name:e.name}),null==(a=e.imgsrc)?(a=e.name,$("#right-nav").prepend('<div id="profile" style="background:'+e.color+'!important" class="avatars" data-id="'+t+'">'+a+"</div>")):$("#right-nav").prepend('<div id="profile" style="background:'+e.color+'!important" class="avatars" data-id="'+t+'"><img src="'+a+'"></div>')):!e.active&&d.find(e=>e.id===t)&&(1==c.status&&t==c.id&&A(),$(".avatars[data-id="+t+"]").remove(),d.find(e=>e.id===t).cursor.remove(),d=$.grep(d,function(e){return e.id!=t})))}async function Te(r,l){var c,t,e,a,o,d;"draw"==r.type||"line"==r.type||"area"==r.type?0==T.filter(function(e){return e.id===l&&e.user===r.user}).length?(!r.completed||"line"!=r.type&&"area"!=r.type?c=L.polyline([[r.initlat,r.initlng]],{color:r.color}):(c=L.polyline(r.path,{color:r.color})).addTo(v),"area"==r.type?T.push({id:l,local:!1,user:r.user,color:r.color,line:c,name:r.name,desc:r.desc,distance:r.distance,area:r.area,path:r.path,completed:r.completed,type:r.type,trigger:"",session:r.session}):T.push({id:l,local:!1,user:r.user,color:r.color,line:c,name:r.name,desc:r.desc,distance:r.distance,path:r.path,completed:r.completed,type:r.type,trigger:"",session:r.session}),c.on("click",async function(e){if(r.completed&&"draw"==r.type&&y){c.remove();var{}=await _supabase.from("coords").delete().eq("objects_id",d.id),{}=await _supabase.from("objects").delete().eq("id",l);T=$.grep(T,function(e){return e.id!=l})}else if(w)e.target.pm.enable({}),e.target.on("pm:edit",e=>{});else if(k)e.target.on("pm:dragend",e=>{});else if(u){for(var t=[],a=0;a<e.target._latlngs.length;a++){var o=[];o.push(e.target._latlngs[a].lng),o.push(e.target._latlngs[a].lat),t.push(o)}var n=turf.lineString(t),i={units:"kilometers"},s=turf.length(n,i);turf.lineChunk(n,s/100,i),turf.bbox(n);(async function(e){var a=[];for(const o of e.geometry.coordinates){var t={},t=(t.lat=o[1],t.lng=o[0],await Topography.getTopography(t,ce));a.push(parseFloat(t.elevation.toFixed(2)))}turf.coordEach(e,function(e,t){e[2]=a[t]});e=turf.featureCollection([e],{name:"demo.geojson",type:"FeatureCollection"});D.load(JSON.stringify(e))})(n)}}),c.on("mouseover",function(e){y&&"draw"==r.type&&c.setStyle({opacity:.3})}),c.on("mouseout",function(e){"draw"==r.type&&c.setStyle({opacity:1})})):(t=[],Object.values(r.coords).forEach(function(e){t.push([e.lat,e.lng])}),T.filter(function(e){return e.id===l&&e.user===r.user})[0].line.setLatLngs(t)):"marker"==r.type?0==T.filter(function(e){return e.id===l&&e.user===r.user}).length?(e="none"==r.m_type?L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+r.color+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}):L.icon({iconUrl:"/static/supa-mapus/assets/"+r.m_type+"-marker.svg",iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),(a=L.marker([r.lat,r.lng],{icon:e,interactive:!0,direction:"top",pane:"overlayPane"})).bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+r.lat.toFixed(5)+", "+r.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",className:"create-shape-flow tooltip-off",interactive:!1,bubblingMouseEvents:!1,offset:L.point({x:0,y:-35})}),a.addTo(v),a.openTooltip(),T.push({id:l,user:r.user,marker:a,color:r.color,name:r.name,desc:r.desc,session:r.session,local:!1,lat:r.lat,lng:r.lng,completed:!0,type:"marker"}),a.on("click",async function(e){var t;y||k?k?e.target.on("pm:dragend",async e=>{var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",d.id).select()}):y&&(a.remove(),t=(await _supabase.from("objects").delete().eq("id",l))["error"],T=$.grep(T,function(e){return e.id!=l}),$(".annotation-item[data-id='"+l+"']").remove()):($(a.getTooltip()._container).removeClass("tooltip-off"),a.openTooltip())}),a.on("tooltipclose",function(){$(".annotation-item[data-id="+l+"]").find(".annotation-name input").removeClass("annotation-focus")}),a.closeTooltip(),F(T.find(e=>e.id==l))):F(T.filter(function(e){return e.id===l&&e.user===r.user})):"text"==r.type&&(0==T.filter(function(e){return e.id===l&&e.user===r.user}).length?((o=L.marker([r.lat,r.lng],{textMarker:!0,text:r.desc}).addTo(v)).pm.getElement().style.color=r.color,T.push({id:l,local:!1,user:r.user,color:r.color,name:r.name,desc:r.desc,lat:r.lat,lng:r.lng,completed:r.completed,type:r.type,trigger:"",session:r.session}),o.on("click",async function(e){var t;k?e.target.on("pm:dragend",async e=>{var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",d.id).select()}):y?(o.remove(),t=(await _supabase.from("objects").delete().eq("id",l))["error"],T=$.grep(T,function(e){return e.id!=l}),$(".annotation-item[data-id='"+l+"']").remove()):w&&(o.pm.enable({}),o.on("pm:textblur",async e=>{text=o.pm.getText();var{}=await _supabase.from("objects").update({desc:text}).eq("id",d.id).select()}))}),F(T.find(e=>e.id==l))):F(T.filter(function(e){return e.id===l&&e.user===r.user}))),r.completed&&0<T.filter(function(e){return e.id===l&&e.user===r.user}).length&&((d=T.filter(function(e){return e.id===l&&e.user===r.user})[0]).name=r.name,d.desc=r.desc,"area"==r.type?(d.area=r.area,d.distance=r.distance,d.path=r.path):d.distance=r.distance,async function(t,a){var n,e,o;"draw"!=t.type&&"marker"!=t.type&&"text"!=t.type&&((n=T.filter(function(e){return e.id===a&&e.user===t.user})[0]).completed=!0,e=L.marker(n.line.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"}),""!=n.trigger&&(e=n.trigger).unbindTooltip(),"line"==n.type?e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,closeOnClick:!1,autoclose:!1,bubblingMouseEvents:!0,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}):"area"==n.type&&(e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+n.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}),n.line.remove(),o=L.polygon(n.path,{color:n.color}).addTo(v),n.line=o),e.setOpacity(0),e.addTo(v),(n.trigger=e).getTooltip().update(),n.line.on("click",async function(e){var t,a;w?(e.target.pm.enable({}),e.target.on("pm:edit",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:t}).eq("id",n.id).select()})):k?e.target.on("pm:dragend",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:t}).eq("id",n.id).select()}):y?(n.trigger.remove(),n.line.remove(),t=(await _supabase.from("coords").delete().eq("objects_id",n.id))["error"],a=(await _supabase.from("objects").delete().eq("id",n.id))["error"],T=$.grep(T,function(e){return e.id!=n.id}),$(".annotation-item[data-id='"+n.id+"']").remove()):u||(n.trigger.setLatLng(f),n.trigger.openTooltip(),$(n.trigger.getTooltip()._container).removeClass("tooltip-off"))}),n.line.on("tooltipclose",function(){$(".annotation-item[data-id="+n.id+"]").find(".annotation-name input").removeClass("annotation-focus")}),F(n))}(r,l))}async function xe(){var e=(await _supabase.from("rooms").select().eq("id",E))["data"],e=(t=e[0].name,o=e[0].description,$("#map-name").val(t),$("#map-description").val(o),$("#share-nav span").html("Share "+t),await _supabase.from("users").select().eq("room",E))["data"];0!=e.length&&e.forEach(function(e,t){Ce(d,e.id)});const a=(await _supabase.from("objects").select(`
            *,
            coords (
              lat,lng
            )
          `).eq("room",E))["data"];0!=a.length&&Object.values(a).forEach(function(e,t){Te(e,a[t].id)}),_supabase.channel("public:rooms").on("postgres_changes",{event:"*",schema:"public",table:"rooms"},e=>{e.new.id==E&&(t=e.new.name,o=e.new.description,$("#map-name").val(t),$("#map-description").val(o))}).subscribe(),_supabase.channel("public:users").on("postgres_changes",{event:"INSERT",schema:"public",table:"users"},e=>{e.new.room==E&&Ce(e.new,e.new.id)}).subscribe(),_supabase.channel("public:users").on("postgres_changes",{event:"UPDATE",schema:"public",table:"users"},e=>{e.new.room==E&&Ce(e.new,e.new.id)}).subscribe(),_supabase.channel("public:objects").on("postgres_changes",{event:"*",schema:"public",table:"objects"},async e=>{if(null!=e.new){const o=(await _supabase.from("objects").select(`
                *,
                coords (
                  lat,lng
                )
              `).eq("room",E))["data"];T.forEach(async function(t){var a;t.completed&&(a=[],o.forEach(function(e,t){a.push(e.id)}),-1==$.inArray(t.id,a))&&(("draw"==t.type?t.line:(("marker"==t.type?t.marker:(t.trigger.remove(),t.local?t.layer:t.line)).remove(),$(".annotation-item[data-id='"+t.id+"']"))).remove(),T=$.grep(T,function(e){return e.id!=t.id}))}),0!=Object.keys(o).length&&o.forEach(function(e,t){e.user!=j.id&&(Te(e,o[t].id),async function(t,a){var o;"draw"!=t.type&&"line"!=t.type&&"area"!=t.type||0<T.filter(function(e){return e.id===a&&e.user===t.user}).length&&(o=[],Object.values(t.coords).forEach(function(e){o.push([e.lat,e.lng])}),T.filter(function(e){return e.id===a&&e.user===t.user})[0].line.setLatLngs(o))}(e,o[t].id))})}}).subscribe()}function _e(){$("#overlay").hasClass("sign-show")&&$(".sign-show").removeClass("sign-show")}O.closeTooltip(),v.on("pm:drawstart",async({workingLayer:e})=>{O.openTooltip(),O.setTooltipContent("Click to place first vertex"),e.on("pm:vertexadded",async a=>{var e,t,o;"Polygon"==a.shape?(O.setTooltipContent("Click on first vertex to finish"),l=a.layer._latlngs[a.layer._latlngs.length-1],1==a.layer._latlngs.length?({data:t,error:e}=await _supabase.from("objects").insert({room:E,color:_,initlat:a.layer._latlngs[0].lat,initlng:a.layer._latlngs[0].lng,user:j.id,type:"area",session:b,name:"Area",desc:"",distance:0,area:0,completed:!1,path:[]}).select("id"),(x=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:l.lat,lng:l.lng}))["error"],T.push({id:x,local:!0,color:_,user:j.id,name:"Area",desc:"",trigger:"",distance:0,area:0,layer:"",type:"area",session:b,completed:!1})):(await _supabase.from("coords").insert({objects_id:x,lat:l.lat,lng:l.lng}))["error"]):"Line"==a.shape&&(r=!0,C=0,l=a.layer._latlngs[a.layer._latlngs.length-1],1==a.layer._latlngs.length?({data:t,error:o}=await _supabase.from("objects").insert({room:E,color:_,initlat:a.layer._latlngs[0].lat,initlng:a.layer._latlngs[0].lng,user:j.id,type:"line",session:b,name:"Line",desc:"",distance:0,completed:!1,path:[]}).select("id"),(x=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:l.lat,lng:l.lng}))["error"],T.push({id:x,local:!0,color:_,user:j.id,name:"Line",desc:"",trigger:"",distance:0,layer:"",type:"line",session:b,completed:!1})):(a.layer._latlngs.forEach(function(e,t){0!=t&&(C+=a.layer._latlngs[t-1].distanceTo(e))}),O.setTooltipContent(C/1e3+"km | Double click to finish"),(await _supabase.from("coords").insert({objects_id:x,lat:l.lat,lng:l.lng}))["error"]))})}),v.on("pm:create",async e=>{var a,t,o,n,i,s,r,l,c,d,p,m;"Rectangle"===e.shape&&1==se?(a=N($("#tilezoom").val()),dowladmap=!1,(geojsonLayer=e.layer).addTo(v),t=e.layer.getBounds()._northEast,o=e.layer.getBounds()._southWest,n=_$().LatLongToPixelXY(t.lat,t.lng,a),i=_$().LatLongToPixelXY(o.lat,o.lng,a),new Promise(function(e,t){e(async function(e,t,a){if(console.log("图片数量约："+(Math.round((t.X-e.X)/256)+1)*(Math.round((e.Y-t.Y)/256)+1)+"张。"),30<(Math.round((t.X-e.X)/256)+1)*(Math.round((e.Y-t.Y)/256)+1))console.log("图片数量超过30张，请重新选择范围或降低级别！");else for(var o=0,n=e.X;n<=t.X;n+=256){re[o]=new Array;for(var i=0,s=t.Y;s<=e.Y;s+=256){tilexy=_$().PixelXYToTileXY(n,s),quadkey=_$().toQuadKey(tilexy.X,tilexy.Y,a);var r=M._url.replace("{subdomain}",M.subdomains[parseInt(4*Math.random())]);await async function(a,o){var n=3*Math.random();return new Promise(function(e,t){setTimeout(function(){console.log("请求中..."),console.log(a,o,new Date),fetch(a).then(e=>e.blob()).then(e=>{var t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=o,t.click()}),e("resolve return")},1e3*n)})}(r=r.replace("{quadkey}",quadkey),n+"-"+s+".jpeg"),re[o][i]=n+"-"+s+".jpeg",i++}o++}}(i,n,a))}).finally(function(){var e=document.createElement("a"),t=new Blob([JSON.stringify(re)],{type:"application/json"});e.href=URL.createObjectURL(t),e.download="urlList",e.click()})):"Text"==e.shape?(h=!0,s=T.filter(function(e){return e.id===x&&e.user===j.id})[0],e.layer.pm.getElement().style.color=_,e.layer.on("pm:textblur",async e=>{console.log(e),text=e.layer.pm.getText();var t=(await _supabase.from("objects").insert({room:E,color:_,lat:e.layer._latlng.lat,lng:e.layer._latlng.lng,user:j.id,type:"text",session:b,name:"Text",desc:text,distance:0,area:0,completed:!0,path:[]}).select("id"))["data"];x=t[0].id,T.push({id:x,local:!0,color:_,user:j.id,name:"Text",desc:text,lat:e.layer._latlng.lat,lng:e.layer._latlng.lng,trigger:"",distance:0,area:0,layer:"",type:"text",session:b,completed:!0})})):(h=!0,(s=T.filter(function(e){return e.id===x&&e.user===j.id})[0]).distance=parseFloat(turf.length(e.layer.toGeoJSON()).toFixed(2)),s.layer=e.layer,"area"==s.type?(s.area=parseFloat((1e-6*turf.area(e.layer.toGeoJSON())).toFixed(2)),c=[],{data:r,error:l}=(Object.values(e.layer.getLatLngs()[0]).forEach(function(e){c.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:c,area:s.area}).eq("id",x).select())):"line"==s.type&&(c=[],{data:d,error:p}=(Object.values(e.layer.getLatLngs()).forEach(function(e){c.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:c}).eq("id",x).select())),(m=L.marker(e.layer.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="'+s.name+'" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),m.setOpacity(0),m.addTo(v),m.openTooltip(),$("#shape-name").focus(),$("#shape-name").select(),s.trigger=m,e.layer.on("click",async function(e){var t,a;y||w||k?w?(e.target.pm.enable({allowSelfIntersection:!1}),e.target.on("pm:edit",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:s.area,distance:s.distance,path:t}).eq("id",s.id).select()})):k?e.target.on("pm:dragend",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:s.area,distance:s.distance,path:t}).eq("id",s.id).select()}):y?(s.trigger.remove(),e.layer.remove(),t=(await _supabase.from("coords").delete().eq("objects_id",s.id))["error"],a=(await _supabase.from("objects").delete().eq("id",s.id))["error"],T=$.grep(T,function(e){return e.id!=s.id}),$(".annotation-item[data-id='"+s.id+"']").remove()):u&&console.log(e):(m.setLatLng(f),m.openTooltip())}),m.on("tooltipclose",function(e){h&&R(),$(".annotation-item[data-id="+s.id+"]").find(".annotation-name input").removeClass("annotation-focus")}))}),v.on("pm:drawend",e=>{r=!1,O.closeTooltip()}),v.addEventListener("mousedown",async e=>{ie=!0;var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;f=[t,e],s&&ye(t,e,j)}),v.addEventListener("click",async e=>{var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;f=[t,e],async function(e,t,a){var o,n,i,s;ne&&(pe(),n=L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+_+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),{data:n,error:i}=((o=L.marker([e,t],{icon:n,direction:"top",interactive:!0,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Marker" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:0,y:-35})}),o.addTo(v),o.openTooltip(),await _supabase.from("objects").insert({room:E,color:_,lat:e,lng:t,user:a.id,type:"marker",m_type:"none",session:b,name:"Marker",desc:""}).select("id")),s=x=n[0].id,T.push({id:x,user:a.id,color:_,name:"Marker",m_type:"none",desc:"",lat:e,lng:t,marker:o,trigger:o,session:b,completed:!0,type:"marker"}),o.on("tooltipclose",function(e){h?R():$(".annotation-item[data-id="+s+"]").find(".annotation-name input").removeClass("annotation-focus")}),o.on("click",async function(e){var t;y||k?k?e.target.on("pm:dragend",async e=>{var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",inst.id).select()}):y&&(o.remove(),t=(await _supabase.from("objects").delete().eq("id",inst.id))["error"],T=$.grep(T,function(e){return e.id!=s})):o.openTooltip()}))}(t,e,j),s&&ye(t,e,j)}),v.addEventListener("mouseup",e=>{ie=!1}),v.addEventListener("mousemove",async e=>{var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;f=[t,e],ie&&s&&(T.filter(function(e){return e.id===x&&e.user===j.id})[0].line.addLatLng([t,e]),(await _supabase.from("coords").insert({objects_id:x,lat:t,lng:e}))["error"]),r&&O.setTooltipContent(((C+l.distanceTo([t,e]))/1e3).toFixed(2)+"km | Double click to finish")}),v.addEventListener("zoom",async e=>{var{}=await _supabase.from("users").update({view:[v.getBounds().getCenter().lat,v.getBounds().getCenter().lng],zoom:v.getZoom()}).eq("uid",j.id).select();A()}),v.addEventListener("movestart",e=>{0}),v.addEventListener("moveend",e=>{0}),$(document).keyup(function(e){$(e.target).is("input")||$(e.target).is("textarea")||("Escape"===e.key?I():"Enter"===e.key?a?$e():n&&Le():86==e.which?pe():80==e.which?me():69==e.which?ue():77==e.which?ge():76==e.which?he():65==e.which&&ve())});var Y=L.Util.template("https://dev.virtualearth.net/REST/v1/Imagery/Metadata/{imagerySet}?key={bingMapsKey}&include=ImageryProviders&uriScheme=https&c={culture}",{bingMapsKey:q,imagerySet:"Aerial",culture:"en-US"}),Ee=5e3,Me="callback";function je(t){try{delete window[t]}catch(e){window[t]=void 0}}function Se(e){e=document.getElementById(e);document.getElementsByTagName("head")[0].removeChild(e)}function _e(){$("#overlay").hasClass("sign-show")&&$(".sign-show").removeClass("sign-show")}_fetch=function(n){var i=void 0===arguments[1]?{}:arguments[1],s=null!=i.timeout?i.timeout:Ee,r=null!=i.jsonpCallback?i.jsonpCallback:Me,l=void 0;return new Promise(function(t,e){var a=i.jsonpCallbackFunction||"jsonp_"+Date.now()+"_"+Math.ceil(1e5*Math.random()),o=(window[a]=function(e){t({ok:!0,json:function(){return Promise.resolve(e)}}),l&&clearTimeout(l),Se(r+"_"+a),je(a)},n+=-1===n.indexOf("?")?"?":"&",document.createElement("script"));o.setAttribute("src",n+r+"="+a),o.id=r+"_"+a,document.getElementsByTagName("head")[0].appendChild(o),l=setTimeout(function(){e(new Error("JSONP request to "+n+" timed out")),je(a),Se(r+"_"+a)},s)})}(Y,{jsonpCallback:"jsonp"}).then(function(e){return e.json()}).then(function(e){if(200!==e.statusCode)throw new Error("Bing Imagery Metadata error: \n"+JSON.stringify(e,null,"  "));e=e.resourceSets[0].resources[0];return M._url=e.imageUrl,M._imageryProviders=e.imageryProviders||[],M.subdomains=e.imageUrlSubdomains,M}).catch(console.error),$(document).on("click",function(e){$("#more-menu").hasClass("menu-show")&&"more-vertical"!=$(e.target).attr("id")&&"more-vertical"!=$(e.target).parent().attr("id")&&$("#more-menu").removeClass("menu-show")}),$(document).on("click","#pen-tool",me),$(document).on("click","#cursor-tool",pe),$(document).on("click","#eraser-tool",ue),$(document).on("click","#profile-tool",function(){I(),u=!0,$(".tool-active").removeClass("tool-active"),$("#profile-tool").addClass("tool-active"),v.pm.enableGlobalRemovalMode(),P()}),$(document).on("click","#marker-tool",ge),$(document).on("click","#text-tool",function(){I(),$(".tool-active").removeClass("tool-active"),$("#text-tool").addClass("tool-active"),v.pm.enableDraw("Text",{})}),$(document).on("click","#area-tool",ve),$(document).on("click","#path-tool",he),$(document).on("click",".color",function(e){e.stopPropagation(),_=$(this).attr("data-color"),$("#inner-color").css({background:_}),fe()}),$(document).on("click","#inner-color",fe),$(document).on("mouseover",".tool",function(){"cursor-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Move (V)</div>'):"pen-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Pencil (P)</div>'):"eraser-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Eraser (E)</div>'):"marker-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Marker (M)</div>'):"text-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Text (T)</div>'):"area-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Area (A)</div>'):"path-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Line (L)</div>'):"edit-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Edit (ED)</div>'):"drag-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Drag (D)</div>'):"profile-tool"==$(this).attr("id")&&$(this).append('<div id="tooltip">Profile (P)</div>')}),$(document).on("mouseout",".tool",function(){$(this).find("#tooltip").remove()}),$(document).on("click",".save-button",async function(e){h=!1;var t,a,o,n,i,s,r=T.filter(function(e){return e.id===x&&e.user===j.id})[0];r.name=N($("#shape-name").val()),r.desc=N($("#shape-desc").val()),r.completed=!0,r.trigger.unbindTooltip(),"area"==r.type?(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+r.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+r.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:t,error:a}=await _supabase.from("objects").update({area:r.area,distance:r.distance,name:r.name,desc:r.desc,completed:!0}).eq("id",x).select()):"line"==r.type?(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+r.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:o,error:n}=await _supabase.from("objects").update({distance:r.distance,name:r.name,desc:r.desc,completed:!0}).eq("id",x).select()):"marker"==r.type&&(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+r.lat.toFixed(5)+", "+r.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),{data:i,error:s}=await _supabase.from("objects").update({name:r.name,desc:r.desc,completed:!0}).eq("id",x).select()),F(r),$(".annotation-item[data-id='"+r.id+"']").find(".annotation-name input").addClass("annotation-focus"),window.setTimeout(function(){r.trigger.openTooltip()},200)}),$(document).on("click",".cancel-button",R),$(document).on("click",".avatars",async function(){var t=$(this).attr("data-id");t!=j.id&&(c.id==t?A():(c.status=!0,c.id=t,$("#outline").css({border:"6px solid "+d.find(e=>e.id===t).color}),$("#observing-name").html("Observing "+d.find(e=>e.id===t).name),$("#observing-name").css({background:d.find(e=>e.id===t).color}),$("#outline").addClass("observing")))}),$(document).on("click",".annotation-arrow",function(e){e.preventDefault(),e.stopPropagation(),$(this).hasClass("arrow-open")?($(this).removeClass("arrow-open"),$(this).parent().parent().find(".annotation-details").addClass("annotation-closed")):($(this).addClass("arrow-open"),$(this).parent().parent().find(".annotation-details").removeClass("annotation-closed"))}),$(document).on("click",".annotation-item",function(){if(P(),!$(this).find(".annotation-name input").hasClass("annotation-focus")){const t=$(this).attr("data-id");i=t;var e=$.grep(T,function(e){return e.id==t})[0];$(".annotation-focus").removeClass("annotation-focus"),$(".annotation-description-focus").removeClass("annotation-description-focus"),v.eachLayer(function(e){"markerPane"!=e.options.pane&&e.closeTooltip()}),$(this).find(".annotation-name input").addClass("annotation-focus"),$(this).find(".annotation-details input").addClass("annotation-description-focus"),"line"==e.type||"area"==e.type?(v.panTo(e.trigger.getLatLng()),$(e.trigger.getTooltip()._container).removeClass("tooltip-off"),e.trigger.openTooltip()):"marker"==e.type&&(v.panTo(e.marker.getLatLng()),$(e.marker.getTooltip()._container).removeClass("tooltip-off"),e.marker.openTooltip())}}),$(document).on("click",".room-item",function(){var e=$(this).attr("data-id");window.location="/mapus?file="+e}),$(document).on("mouseup",".annotation-focus",function(){$(".annotation-focus").select(),$(".annotation-focus").addClass("map-editing"),$(".annotation-focus").prop("disabled",!1)}),$(document).on("focusout",".annotation-focus",async function(){$(".annotation-focus").prop("disabled",!0),$(".annotation-focus").removeClass("map-editing");var e=N($(".annotation-focus").val());0==e.length?$(".annotation-focus").val(oe):(await _supabase.from("objects").update({name:e}).eq("id",parseInt(i)))["error"]}),$(document).on("mouseup",".annotation-description-focus",function(){$(".annotation-description-focus").select(),$(".annotation-description-focus").addClass("map-editing"),$(".annotation-description-focus").prop("disabled",!1)}),$(document).on("focusout",".annotation-description-focus",async function(){$(".annotation-description-focus").prop("disabled",!0),$(".annotation-description-focus").removeClass("map-editing");var e=N($(".annotation-description-focus").val());0==e.length?$(".annotation-description-focus").val(oe):(await _supabase.from("objects").update({desc:e}).eq("id",parseInt(i)))["error"]}),$(document).on("click",".delete-layer",async function(e){e.preventDefault(),e.stopPropagation();const t=$(this).parent().parent().attr("data-id"),a=$.grep(T,function(e){return e.id==t})[0];$(".annotation-item[data-id='"+t+"']").remove(),T="marker"!=a.type?(a.trigger.remove(),a.line.remove(),(await _supabase.from("coords").delete().eq("objects_id",a.id))["error"],(await _supabase.from("objects").delete().eq("id",a.id))["error"],$.grep(T,function(e){return e.id!=a.id})):(a.marker.remove(),(await _supabase.from("objects").delete().eq("id",a.id))["error"],$.grep(T,function(e){return e.id!=a.id}))}),$(document).on("mousedown","#map-name",async function(e){3!=e.which||a||(te=t,a=!0,$("#map-name").prop("disabled",!1),$("#map-name").addClass("map-editing"))}),$(document).on("mouseup","#map-name",function(){$("#map-name").select(),$("#map-name").addClass("map-editing"),$("#map-name").prop("disabled",!1)}),$(document).on("focusout","#map-name",$e),$(document).on("mousedown","#map-description",async function(){n||(ae=o,n=!0,$("#map-description").prop("disabled",!1),$("#map-description").addClass("map-editing"))}),$(document).on("mouseup","#map-description",function(){$("#map-description").select(),$("#map-description").addClass("map-editing")}),$(document).on("focusout","#map-description",Le),$(document).on("click","#hide-annotations",function(){$("#hide-annotations").hasClass("hidden-annotations")?P():($(".leaflet-overlay-pane").css({visibility:"hidden","pointer-events":"none"}),$(".leaflet-tooltip-pane").css({visibility:"hidden","pointer-events":"none"}),$("#hide-annotations").addClass("hidden-annotations"),$("#hide-annotations").html("Show all"))}),$(document).on("click","#location-control",function e(){A(),navigator.geolocation&&(""!=p?navigator.geolocation.getCurrentPosition(function(e){p.setLatLng([e.coords.latitude,e.coords.longitude]),v.flyTo(p.getLatLng(),18)}):(de(),e()))}),$(document).on("click",".find-nearby",async function(){var o=$(this).attr("data-type"),n=$(this).attr("data-color"),e=v.getBounds().getNorthWest().lng+","+v.getBounds().getNorthWest().lat+","+v.getBounds().getSouthEast().lng+","+v.getBounds().getSouthEast().lat;$.get("https://nominatim.openstreetmap.org/search?viewbox="+e+"&format=geocodejson&limit=20&bounded=1&amenity="+o+"&exclude_place_ids="+JSON.stringify(g),function(e){var a=L.icon({iconUrl:"/static/supa-mapus/assets/"+o+"-marker.svg",iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]});e.features.forEach(function(e){var t=L.marker([e.geometry.coordinates[1],e.geometry.coordinates[0]],{icon:a,pane:"overlayPane",interactive:!0}).addTo(v);t.bindTooltip("<h1>"+e.properties.geocoding.name+'</h1><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.geometry.coordinates[1].toFixed(5)+", "+e.geometry.coordinates[0].toFixed(5)+'</h3></div><br><div id="buttons2"><button class="cancel-button-place" data-id='+e.properties.geocoding.place_id+'>Remove</button><button class="save-button-place" data-id='+e.properties.geocoding.place_id+'>Save</button></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),m.push({id:"",place_id:e.properties.geocoding.place_id,user:j.id,name:e.properties.geocoding.name,desc:"",lat:e.geometry.coordinates[1],lng:e.geometry.coordinates[0],trigger:t,completed:!0,marker:t,m_type:o,type:"marker",session:b,color:n}),g.push(e.properties.geocoding.place_id)})})}),$(document).on("click",".save-button-place",async function(){var e=m.find(e=>e.place_id==$(this).attr("data-id")),t=(await _supabase.from("objects").insert({color:e.color,place_id:e.place_id,lat:e.lat,lng:e.lng,user:j.id,type:"marker",m_type:e.m_type,session:b,name:e.name,desc:""}).select("id"))["data"];x=t[0].id,e.id=x,T.push(e),e.marker.bindTooltip("<h1>"+e.name+'</h1><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+'</h3></div><br><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})})}),$(document).on("click",".cancel-button-place",function(){var t=m.find(e=>e.place_id==$(this).attr("data-id"));t.marker.remove(),m=$.grep(m,function(e){return e.place_id!=t.id}),g=$.grep(g,function(e){return e!=t.id})}),$(document).on("click","#more-vertical",function(){$("#more-menu").hasClass("menu-show")?$("#more-menu").removeClass("menu-show"):$("#more-menu").addClass("menu-show")}),$(document).on("click","#geojson",function(){var t=new L.FeatureGroup,e=(v.addLayer(t),v.eachLayer(function(e){(e instanceof L.Marker||e instanceof L.Polyline||e instanceof L.Polygon)&&e.addTo(t)}),document.createElement("a")),a=new Blob([JSON.stringify(t.toGeoJSON())],{type:"application/json"});e.href=URL.createObjectURL(a),e.download="geojson",e.click()}),$(document).on("click","#search-box img",be),$(document).on("click","#google-signin-2",async function(){var e=N($("#email").val()),t=N($("#password").val());const a=(await _supabase.auth.signInWithPassword({email:e,password:t}))["error"];null==a&&_e();e=(await _supabase.auth.getUser()).data.user;if(j=e,S.has("file")){$(".signin").removeClass("signin");var o,n,t=le[Math.floor(Math.random()*le.length)],e=(await _supabase.from("users").select().eq("uid",j.id))["data"];0==e.length?{data:o,error:n}=await _supabase.from("users").insert({room:E,uid:j.id,lat:0,lng:0,active:!0,color:t,name:j.email,view:[v.getBounds().getCenter().lat,v.getBounds().getCenter().lng],zoom:v.getZoom()}).select("id"):(await _supabase.from("users").update({lat:0,lng:0,active:!0,color:t,name:j.email,view:[v.getBounds().getCenter().lat,v.getBounds().getCenter().lng],zoom:v.getZoom()}).eq("uid",j.id))["error"],window.setTimeout(async function(){var e=(await _supabase.from("users").select().eq("uid",j.id))["data"];b=e.session},100),xe()}else{const{data:i,error:a}=await _supabase.from("rooms").select();i.forEach(function(e,t){$("#room-list").prepend('<div class="room-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg"> <input value='+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.description+' disabled class="annotation-description"></div></div>')}),$("#sign").removeClass("signin"),$("#popup").find(".header-text").html("Create a map"),$("#popup").find(".subheader-text").html("Maps can be shared with friends to collaborate in real-time."),$("#google-signin").attr("id","create-map"),$(".create-map").html("Create a map"),$("#popup").addClass("signin")}}),$(document).on("click","#create-map",async function(){var e=(e=(await _supabase.from("rooms").insert({name:"New map",description:"Map description"}).select("id"))["data"])[0].id;window.location.replace(window.location.href+"?file="+e)}),$(document).on("click","#logout",async function(){var{}=await _supabase.auth.signOut().then(function(){$("#popup").addClass("signin"),$("#overlay").addClass("signin")})}),$(document).on("click","#share-button",function(){$("#share").addClass("share-show"),$("#overlay").addClass("share-show")}),$(document).on("click","#overlay",ke),$(document).on("click","#close-share",ke),$(document).on("click","#share-copy",function(){$("#share-url").focus(),$("#share-url").select(),document.execCommand("copy")}),$(document).on("click","#zoom-in",function(){v.zoomIn()}),$(document).on("click","#zoom-out",function(){v.zoomOut()}),$(document).on("click","#sign-button",function(){$("#sign").addClass("sign-show"),$("#overlay").addClass("sign-show")}),$(document).on("click","#close-sign",_e),$(document).on("click","#importgeojson",function(){$('<input type="file" value="选择文件"></input>').click().on("change",e=>{e=e.target.files[0];let t=new FileReader;t.onload=()=>{var e=t.result;!async function(g){var a={radius:8,fillColor:"#ff7800",color:_,weight:1,opacity:1,fillOpacity:.8};L.geoJSON(g.features,{pointToLayer:function(e,t){return L.circleMarker(t,a)}}).addTo(v),g.features.forEach(async function(o,e){var t,n,a,i,s,r,l,c,d,p,m,u;"LineString"==o.geometry.type?(n=[],d="linestring",p="line",C=0,a=o.geometry.coordinates.length,{data:l,error:t}=(o.geometry.coordinates.forEach(function(e,t){var a;0!=t&&(t=L.latLng(o.geometry.coordinates[t-1][1],o.geometry.coordinates[t-1][0]),a=L.latLng(e[1],e[0]),C+=t.distanceTo(a)),n.push([e[1],e[0]])}),o.properties.description&&(d=o.properties.description),g.name&&(p=g.name),g.name&&o.properties.Layer&&(p=g.name+"-"+o.properties.Layer),g.name&&o.properties.Name&&(p=g.name+"-"+o.properties.Name),await _supabase.from("objects").insert({room:E,color:_,initlat:o.geometry.coordinates[0][1],initlng:o.geometry.coordinates[0][0],user:j.id,type:"line",session:b,name:p,desc:d,distance:parseFloat((C/1e3).toFixed(3)),completed:!0,path:n}).select("id")),(x=l[0].id,await _supabase.from("coords").insert({objects_id:l[0].id,lat:o.geometry.coordinates[a-1][1],lng:o.geometry.coordinates[a-1][0]}))["error"],T.push({id:x,local:!0,color:_,user:j.id,name:p,desc:d,trigger:"",distance:parseFloat((C/1e3).toFixed(3)),layer:"",type:"line",session:b,completed:!0}),h=!0,l=T.filter(function(e){return e.id===x&&e.user===j.id})[0],(c=L.marker(v.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Line" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),$("#shape-name").focus(),$("#shape-name").select(),l.trigger=c,y||w||k||(c.setLatLng(f),c.openTooltip()),c.on("tooltipclose",function(e){h&&R(),$(".annotation-item[data-id="+x+"]").find(".annotation-name input").removeClass("annotation-focus")})):"Polygon"==o.geometry.type?(n=[],d="polygon",p="area",C=0,a=o.geometry.coordinates[0].length,o.geometry.coordinates[0].forEach(function(e,t){var a;0!=t&&(t=L.latLng(o.geometry.coordinates[0][t-1][1],o.geometry.coordinates[0][t-1][0]),a=L.latLng(e[1],e[0]),C+=t.distanceTo(a)),n.push([e[1],e[0]])}),i=turf.polygon(o.geometry.coordinates),i=turf.area(i),i=parseFloat((1e-6*i).toFixed(2)),{data:s,error:r}=(o.properties.description&&(d=o.properties.description),g.name&&(p=g.name),g.name&&o.properties.Layer&&(p=g.name+"-"+o.properties.Layer),g.name&&o.properties.Name&&(p=g.name+"-"+o.properties.Name),await _supabase.from("objects").insert({room:E,color:_,initlat:o.geometry.coordinates[0][0][1],initlng:o.geometry.coordinates[0][0][0],user:j.id,type:"area",session:b,name:p,desc:d,distance:parseFloat((C/1e3).toFixed(3)),area:i,completed:!0,path:n}).select("id")),(x=s[0].id,await _supabase.from("coords").insert({objects_id:s[0].id,lat:o.geometry.coordinates[0][a-1][1],lng:o.geometry.coordinates[0][a-1][0]}))["error"],T.push({id:x,local:!0,color:_,user:j.id,name:p,desc:d,trigger:"",distance:parseFloat((C/1e3).toFixed(3)),area:i,layer:"",type:"area",session:b,completed:!0}),h=!0,l=T.filter(function(e){return e.id===x&&e.user===j.id})[0],(c=L.marker(v.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Line" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),$("#shape-name").focus(),$("#shape-name").select(),l.trigger=c):"Point"==o.geometry.type&&(d="point",p="marker",{data:m,error:u}=(o.properties.description&&(d=o.properties.description),g.name&&(p=g.name),g.name&&o.properties.Layer&&(p=g.name+"-"+o.properties.Layer),g.name&&o.properties.Name&&(p=g.name+"-"+o.properties.Name),await _supabase.from("objects").insert({room:E,color:_,lat:o.geometry.coordinates[1],lng:o.geometry.coordinates[0],user:j.id,type:"marker",m_type:"none",session:b,name:p,desc:d,completed:!0}).select("id")))})}(JSON.parse(e))},t.readAsText(e,"UTF-8")})}),$(document).on("click","#xmltogeojson",function(){$('<input type="file" value="选择文件"></input>').click().on("change",e=>{var e=e.target.files[0],t=e.name,l=t.substring(0,t.lastIndexOf("."));let c=new FileReader;c.onload=()=>{var e=c.result.split(/\r\n|\n/);let t="";e.map(e=>{e.length&&!e.startsWith(";")&&(-1!==e.indexOf("<Placemark")&&(t+="{"),t+=e,-1!==e.indexOf("</Placemark"))&&(t+="}")});var a=t.split("}"),o={type:"FeatureCollection",name:"",features:[]};t.split("<Folder")[2]&&t.split("<Folder")[2].split("<name")[1].split("</name")[0]&&(o.name=t.split("<Folder")[2].split("<name>")[1].split("</name")[0]);for(let e=0;e<a.length;e++)if(a[e].split("<Placemark")[1]){var n,i=a[e].split("<coordinates>")[1].split("</coordinates>")[0].split(/ |,/);if(a[e].split("<LineString>")[1]){var s=[];for(let e=0;e<i.length;e+=1)""!=i[e]&&""!=i[e+1]&&""!=i[e+2]&&s.push([Number(i[e]),Number(i[e+1]),Number(i[e+2])]);o.features.push({type:"Feature",properties:{Name:a[e].split("<Placemark")[1].split("<name>")[1].split("</name>")[0]},geometry:{type:"LineString",coordinates:s}})}else if(a[e].split("<Polygon>")[1]){s=[[]];for(let e=0;e<i.length;e+=1)""!=i[e]&&""!=i[e+1]&&""!=i[e+2]&&s[0].push([Number(i[e]),Number(i[e+1]),Number(i[e+2])]);o.features.push({type:"Feature",properties:{Name:a[e].split("<Placemark")[1].split("<name>")[1].split("</name>")[0]},geometry:{type:"Polygon",coordinates:s}})}else a[e].split("<Point>")[1]&&(n=a[e].split("<coordinates>")[1].split("</coordinates>")[0].split(","),o.features.push({type:"Feature",properties:{Name:a[e].split("<Placemark")[1].split("<name>")[1].split("</name>")[0]},geometry:{type:"Point",coordinates:[Number(n[0]),Number(n[1])]}}))}var e=document.createElement("a"),r=new Blob([JSON.stringify(o)],{type:"application/json"});e.href=URL.createObjectURL(r),e.download=l,e.click()},c.readAsText(e,"UTF-8")})}),$(document).on("click","#downloadmap",function(){se=!0,$("#chooseTileZoom").addClass("chooseTileZoom-show"),$("#overlay").addClass("chooseTileZoom-show")}),$(document).on("click","#close-choosetilezoom",function(){$("#overlay").hasClass("chooseTileZoom-show")&&$(".chooseTileZoom-show").removeClass("chooseTileZoom-show"),v.pm.disableDraw()}),$(document).on("click","#draw-rectangle",function(){$("#chooseTileZoom").removeClass("chooseTileZoom-show"),$("#overlay").removeClass("chooseTileZoom-show"),v.pm.enableDraw("Rectangle",{finishOn:"dblclick",allowSelfIntersection:!1,tooltips:!1})}),$(document).on("click","#edit-tool",function(){I(),w=!0,$(".tool-active").removeClass("tool-active"),$("#edit-tool").addClass("tool-active"),P()}),$(document).on("click","#drag-tool",function(){I(),k=!0,$(".tool-active").removeClass("tool-active"),$("#drag-tool").addClass("tool-active"),v.pm._globalDragModeEnabled||v.pm.toggleGlobalDragMode(),P()}),$(document).on("keydown","#search-input",function(e){"Enter"===e.key&&be()}),de()});