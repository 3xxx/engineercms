$(document).ready(function(){var l=L.map("mapDiv",{crs:L.CRS.Baidu,maxZoom:18,doubleClickZoom:!1,renderer:L.canvas({tolerance:10})}).setView([23.125178,113.280637],12),t="",A="",o="",z="",a=!1,n=!1,c=!1,d=[0,0],r=0,i=!1,p=!1,u=!1,m=!1,Z=!1,s=!1,g=[0,0],v={status:!1,id:0},h=0,U=!1,f=[],y=0,b="#634FF1",w=[],k="",_=[],C=[],x="",T=new Object,R=["#EC1D43","#EC811D","#ECBE1D","#B6EC1D","#1DA2EC","#781DEC","#CF1DEC","#222222"],j=new URLSearchParams(window.location.search);j.has("file")&&(x=j.get("file"),$("#share-url").val(window.location.href)),window.setTimeout(async function(){await Y()&&j.has("file")?ie():(await Y()&&!j.has("file")&&($("#popup").find(".header-text").html("Create a map"),$("#popup").find(".subheader-text").html("Maps can be shared with friends to collaborate in real-time."),$("#google-signin").attr("id","create-map"),$("#create-map").html("Create a map")),$("#overlay").addClass("signin"),$("#popup").addClass("signin"))},500),l.pm.addControls();var E,M,q=L.marker([0,0],{pane:"overlayPane",interactive:!1}).addTo(l);q.setOpacity(0),q.bindTooltip("",{permanent:!0,offset:[5,25],sticky:!0,className:"hints",direction:"right"}).addTo(l);function G(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t=L.icon({iconUrl:"/static/supa-mapus/assets/liveLocation.svg",iconSize:[24,24],iconAnchor:[12,12]});(k=L.marker([e.coords.latitude,e.coords.longitude],{icon:t,pane:"overlayPane"})).addTo(l)})}function O(){s=Z=m=u=p=i=!1,l.pm.disableDraw(),l.pm.disableGlobalRemovalMode(),l.pm._globalDragModeEnabled&&l.pm.toggleGlobalDragMode(),l.pm.disableGlobalEditMode()}function D(){O(),l.dragging.enable(),$(".tool-active").removeClass("tool-active"),$("#cursor-tool").addClass("tool-active")}function I(){O(),i=!0,l.dragging.disable(),$(".tool-active").removeClass("tool-active"),$("#pen-tool").addClass("tool-active"),F()}function J(){O(),p=!0,$(".tool-active").removeClass("tool-active"),$("#eraser-tool").addClass("tool-active"),l.pm.enableGlobalRemovalMode(),F()}function W(){O(),Z=!0,$(".tool-active").removeClass("tool-active"),$("#marker-tool").addClass("tool-active"),F()}function V(){O(),$(".tool-active").removeClass("tool-active"),$("#area-tool").addClass("tool-active"),l.pm.setPathOptions({color:b,fillColor:b,fillOpacity:.4}),l.pm.enableDraw("Polygon",{tooltips:!1,templineStyle:{color:b},hintlineStyle:{color:b,dashArray:[5,5]}}),F()}function H(){O(),$(".tool-active").removeClass("tool-active"),$("#path-tool").addClass("tool-active"),l.pm.setGlobalOptions({pinning:!0,snappable:!0}),l.pm.setPathOptions({color:b,fillColor:b,fillOpacity:.4}),l.pm.enableDraw("Line",{tooltips:!1,templineStyle:{color:b},hintlineStyle:{color:b,dashArray:[5,5]},finishOn:"dblclick"}),F()}function K(){$("#color-list").toggleClass("color-enabled")}function P(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return e.replace(/[&<>"'/]/gi,e=>t[e])}function Q(){$.get("https://nominatim.openstreetmap.org/search?q="+P($("#search-box input").val())+"&format=json",function(e){l.panTo(new L.LatLng(e[0].lat,e[0].lon))})}function N(){v.status=!1,$("#outline").css({border:"none"}),$("#outline").removeClass("observing")}async function S(){c=!1;var e,t,a,o,n,i,s=f.filter(function(e){return e.id===y&&e.user===T.id})[0];s.trigger.unbindTooltip(),s.completed=!0,"area"==s.type?(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+s.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+s.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:e,error:t}=await _supabase.from("objects").update({area:s.area,distance:s.distance,name:s.name,desc:s.desc,completed:!0}).eq("id",y).select()):"line"==s.type?(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+s.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:a,error:o}=await _supabase.from("objects").update({distance:s.distance,name:s.name,desc:s.desc,completed:!0}).eq("id",y).select()):"marker"==s.type&&(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+s.lat.toFixed(5)+", "+s.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),{data:n,error:i}=await _supabase.from("objects").update({name:s.name,desc:s.desc,completed:!0}).eq("id",y).select()),B(s),$(".annotation-item[data-id='"+s.id+"']").find(".annotation-name span").addClass("annotation-focus"),window.setTimeout(function(){s.trigger.openTooltip()},200)}async function X(t,a,o){var n=L.polyline([[t,a]],{color:b}),i=(await _supabase.from("objects").insert({room:x,color:b,initlat:t,initlng:a,user:o.id,type:"draw",session:r,completed:!0}).select("id"))["data"],{}=(y=i[0].id,await _supabase.from("coords").insert({objects_id:i[0].id,lat:t,lng:a}));f.push({id:y,user:o.id,line:n,session:r,local:!0,completed:!0,type:"draw"}),n.addTo(l),f.forEach(function(n){n.line.on("click",async function(t){var a,o;p?(n.line.remove(),a=(await _supabase.from("coords").delete().eq("objects_id",n.id))["error"],o=(await _supabase.from("objects").delete().eq("id",n.id))["error"],f=$.grep(f,function(e){return e.id!=n.id}),$(".annotation-item[data-id='"+n.id+"']").remove()):u&&(e.target.pm.enable({}),e.target.on("pm:edit",e=>{console.log(e.target._latlngs),console.log(e.target.getLatLngs()),console.log(n.id)}))}),n.line.on("mouseover",function(e){p&&n.line.setStyle({opacity:.3})}),n.line.on("mouseout",function(e){n.line.setStyle({opacity:1})})})}async function Y(){var{user:e}=(await _supabase.auth.getUser())["data"];return null!=(T=e)&&T}function B(e){var t;0==$(".annotation-item[data-id='"+e.id+"']").length?"line"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M14.5 8.5L8.5 14.5" stroke="white" stroke-width="1.5" stroke-linecap="square"/><path d="M15.8108 8.53378C16.7176 8.53378 17.4527 7.79868 17.4527 6.89189C17.4527 5.9851 16.7176 5.25 15.8108 5.25C14.904 5.25 14.1689 5.9851 14.1689 6.89189C14.1689 7.79868 14.904 8.53378 15.8108 8.53378Z" stroke="white" stroke-width="1.5"/><circle cx="6.89189" cy="15.8108" r="1.64189" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<span>"+e.name+'</span><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><div class="annotation-description">'+e.desc+'</div><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/distance-icon.svg">'+e.distance+" km</div></div></div></div>")):"area"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M15.3652 8.5V13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M8.5 15.3649H13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M14.5303 9.03033C14.8232 8.73744 14.8232 8.26256 14.5303 7.96967C14.2374 7.67678 13.7626 7.67678 13.4697 7.96967L14.5303 9.03033ZM7.96967 13.4697C7.67678 13.7626 7.67678 14.2374 7.96967 14.5303C8.26256 14.8232 8.73744 14.8232 9.03033 14.5303L7.96967 13.4697ZM13.4697 7.96967L7.96967 13.4697L9.03033 14.5303L14.5303 9.03033L13.4697 7.96967Z" fill="white"/><circle cx="15.365" cy="6.85135" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="15.365" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="6.85135" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<span>"+e.name+'</span><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><div class="annotation-description">'+e.desc+'</div><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div></div></div></div>")):"marker"==e.type&&(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M16.0252 11.2709C16.0252 14.8438 11.3002 17.9063 11.3002 17.9063C11.3002 17.9063 6.5752 14.8438 6.5752 11.2709C6.5752 10.0525 7.07301 8.8841 7.95912 8.0226C8.84522 7.16111 10.047 6.67712 11.3002 6.67712C12.5533 6.67712 13.7552 7.16111 14.6413 8.0226C15.5274 8.8841 16.0252 10.0525 16.0252 11.2709Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.2996 12.8021C12.1695 12.8021 12.8746 12.1166 12.8746 11.2709C12.8746 10.4252 12.1695 9.73962 11.2996 9.73962C10.4298 9.73962 9.72461 10.4252 9.72461 11.2709C9.72461 12.1166 10.4298 12.8021 11.2996 12.8021Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<span>"+e.name+'</span><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><div class="annotation-description">'+e.desc+'</div><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div></div></div></div>")):(t=$(".annotation-item[data-id='"+e.id+"']"),"line"==e.type?(t.find(".annotation-name span").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/distance-icon.svg">'+e.distance+" km</div>")):"area"==e.type?(t.find(".annotation-name span").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div>")):"marker"==e.type&&(t.find(".annotation-name span").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div>")))}async function ee(){a=!1,$("#map-name").prop("disabled",!0),$("#map-name").removeClass("map-editing");var e,t=P($("#map-name").val());0==t.length?$("#map-name").val(A):e=(await _supabase.from("rooms").update({name:t}).eq("id",x))["error"]}async function te(){n=!1,$("#map-description").prop("disabled",!0),$("#map-description").removeClass("map-editing");var e,t=P($("#map-description").val());0==t.length?$("#map-description").val(z):e=(await _supabase.from("rooms").update({description:t}).eq("id",x))["error"]}function F(){$(".leaflet-overlay-pane").css({visibility:"visible","pointer-events":"all"}),$(".leaflet-tooltip-pane").css({visibility:"visible","pointer-events":"all"}),$("#hide-annotations").removeClass("hidden-annotations"),$("#hide-annotations").html("Hide all")}function ae(){$("#overlay").hasClass("share-show")&&$(".share-show").removeClass("share-show")}async function oe(e,t){var a;t!=T.id&&(e.active?w.find(e=>e.id===t)?(w.find(e=>e.id===t).cursor.setLatLng([e.lat,e.lng]),1==v.status&&t==v.id&&(l.setZoom(e.zoom),l.panTo(new L.LatLng(e.view[0],e.view[1])))):(a=L.divIcon({html:'<svg width="18" height="18" style="z-index:9999!important" viewBox="0 0 18 18" fill="none" style="background:none;" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.51169 15.8783L1.08855 3.64956C0.511984 2.05552 2.05554 0.511969 3.64957 1.08853L15.8783 5.51168C17.5843 6.12877 17.6534 8.51606 15.9858 9.23072L11.2573 11.2573L9.23074 15.9858C8.51607 17.6534 6.12878 17.5843 5.51169 15.8783Z" fill="'+e.color+'"/></svg>',iconSize:[22,22],iconAnchor:[0,0],shadowAnchor:[4,62],popupAnchor:[-3,-76],className:"cursoricon"}),(a=L.marker([e.lat,e.lng],{icon:a,pane:"markerPane"})).bindTooltip(e.name,{permanent:!0,offset:[14,32],className:"cursor-label color"+e.color.replace("#",""),direction:"right"}),a.addTo(l),w.push({id:t,cursor:a,color:e.color,name:e.name}),null==(a=e.imgsrc)?(a=e.name,$("#right-nav").prepend('<div id="profile" style="background:'+e.color+'!important" class="avatars" data-id="'+t+'">'+a+"</div>")):$("#right-nav").prepend('<div id="profile" style="background:'+e.color+'!important" class="avatars" data-id="'+t+'"><img src="'+a+'"></div>')):!e.active&&w.find(e=>e.id===t)&&(1==v.status&&t==v.id&&N(),$(".avatars[data-id="+t+"]").remove(),w.find(e=>e.id===t).cursor.remove(),w=$.grep(w,function(e){return e.id!=t})))}async function ne(o,n){var i,t,e,a,s;"draw"==o.type||"line"==o.type||"area"==o.type?0==f.filter(function(e){return e.id===n&&e.user===o.user}).length?(i=L.polyline([[o.initlat,o.initlng]],{color:o.color}),(i=!o.completed||"line"!=o.type&&"area"!=o.type?i:L.polyline(o.path,{color:o.color})).addTo(l),"area"==o.type?f.push({id:n,local:!1,user:o.user,color:o.color,line:i,name:o.name,desc:o.desc,distance:o.distance,area:o.area,path:o.path,completed:o.completed,type:o.type,trigger:"",session:o.session}):f.push({id:n,local:!1,user:o.user,color:o.color,line:i,name:o.name,desc:o.desc,distance:o.distance,path:o.path,completed:o.completed,type:o.type,trigger:"",session:o.session}),i.on("click",async function(e){var t,a;o.completed&&"draw"==o.type&&p?(i.remove(),t=(await _supabase.from("coords").delete().eq("objects_id",s.id))["error"],a=(await _supabase.from("objects").delete().eq("id",n))["error"],f=$.grep(f,function(e){return e.id!=n})):u?(e.target.pm.enable({}),e.target.on("pm:edit",e=>{console.log(e.target._latlngs),console.log(e.target.getLatLngs()),console.log(s.id)})):m&&e.target.on("pm:dragend",e=>{console.log(e)})}),i.on("mouseover",function(e){p&&"draw"==o.type&&i.setStyle({opacity:.3})}),i.on("mouseout",function(e){"draw"==o.type&&i.setStyle({opacity:1})})):(t=[],Object.values(o.coords).forEach(function(e){t.push([e.lat,e.lng])}),f.filter(function(e){return e.id===n&&e.user===o.user})[0].line.setLatLngs(t)):"marker"==o.type&&(0==f.filter(function(e){return e.id===n&&e.user===o.user}).length?(e="none"==o.m_type?L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+o.color+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}):L.icon({iconUrl:"/static/supa-mapus/assets/"+o.m_type+"-marker.svg",iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),(a=L.marker([o.lat,o.lng],{icon:e,interactive:!0,direction:"top",pane:"overlayPane"})).bindTooltip("<h1>"+o.name+"</h1><h2>"+o.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+o.lat.toFixed(5)+", "+o.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",className:"create-shape-flow tooltip-off",interactive:!1,bubblingMouseEvents:!1,offset:L.point({x:0,y:-35})}),a.addTo(l),a.openTooltip(),f.push({id:n,user:o.user,marker:a,color:o.color,name:o.name,desc:o.desc,session:o.session,local:!1,lat:o.lat,lng:o.lng,completed:!0,type:"marker"}),a.on("click",async function(e){var t;p||m?m?e.target.on("pm:dragend",async e=>{console.log(e.target._latlng.lat);var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",s.id).select()}):(a.remove(),t=(await _supabase.from("objects").delete().eq("id",n))["error"],f=$.grep(f,function(e){return e.id!=n}),$(".annotation-item[data-id='"+n+"']").remove()):($(a.getTooltip()._container).removeClass("tooltip-off"),a.openTooltip())}),a.on("tooltipclose",function(){$(".annotation-item[data-id="+n+"]").find(".annotation-name span").removeClass("annotation-focus")}),a.closeTooltip(),B(f.find(e=>e.id==n))):B(f.filter(function(e){return e.id===n&&e.user===o.user}))),o.completed&&0<f.filter(function(e){return e.id===n&&e.user===o.user}).length&&((s=f.filter(function(e){return e.id===n&&e.user===o.user})[0]).name=o.name,s.desc=o.desc,"area"==o.type?(s.area=o.area,s.distance=o.distance,s.path=o.path):s.distance=o.distance,async function(t,a){var n,e,o;"draw"!=t.type&&"marker"!=t.type&&(await Y(),0!=await Y())&&((n=f.filter(function(e){return e.id===a&&e.user===t.user})[0]).completed=!0,e=L.marker(n.line.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"}),""!=n.trigger&&(e=n.trigger).unbindTooltip(),"line"==n.type?e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,closeOnClick:!1,autoclose:!1,bubblingMouseEvents:!0,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}):"area"==n.type&&(e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+n.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}),n.line.remove(),o=L.polygon(n.path,{color:n.color}).addTo(l),n.line=o),e.setOpacity(0),e.addTo(l),(n.trigger=e).getTooltip().update(),n.line.on("click",async function(e){var t,a;p||u||m?u?(e.target.pm.enable({}),e.target.on("pm:edit",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:t}).eq("id",n.id).select()})):m?e.target.on("pm:dragend",async e=>{console.log(e),console.log(Object.values(e.target.getLatLngs()[0]));var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));console.log(t);var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:t}).eq("id",n.id).select()}):(n.trigger.remove(),n.line.remove(),t=(await _supabase.from("coords").delete().eq("objects_id",n.id))["error"],a=(await _supabase.from("objects").delete().eq("id",n.id))["error"],f=$.grep(f,function(e){return e.id!=n.id}),$(".annotation-item[data-id='"+n.id+"']").remove()):(n.trigger.setLatLng(d),n.trigger.openTooltip(),$(n.trigger.getTooltip()._container).removeClass("tooltip-off"))}),n.line.on("tooltipclose",function(){$(".annotation-item[data-id="+n.id+"]").find(".annotation-name span").removeClass("annotation-focus")}),B(n))}(o,n))}async function ie(){var e=(await _supabase.from("rooms").select().eq("id",x))["data"],e=(t=e[0].name,o=e[0].description,$("#map-name").val(t),$("#map-description").val(o),$("#share-nav span").html("Share "+t),await _supabase.from("users").select().eq("room",x))["data"];0!=e.length&&e.forEach(function(e,t){oe(w,e.id)});const a=(await _supabase.from("objects").select(`
            *,
            coords (
              lat,lng
            )
          `).eq("room",x))["data"];0!=a.length&&Object.values(a).forEach(function(e,t){ne(e,a[t].id)}),_supabase.channel("public:rooms").on("postgres_changes",{event:"*",schema:"public",table:"rooms"},e=>{e.new.id==x&&(t=e.new.name,o=e.new.description,$("#map-name").val(t),$("#map-description").val(o))}).subscribe(),_supabase.channel("public:users").on("postgres_changes",{event:"INSERT",schema:"public",table:"users"},e=>{console.log("insert users Change received!",e),e.new.room==x&&oe(e.new,e.new.id)}).subscribe(),_supabase.channel("public:users").on("postgres_changes",{event:"UPDATE",schema:"public",table:"users"},e=>{console.log("update users Change received!",e),e.new.room==x&&oe(e.new,e.new.id)}).subscribe(),_supabase.channel("public:objects").on("postgres_changes",{event:"*",schema:"public",table:"objects"},async e=>{if(null!=e.new){const o=(await _supabase.from("objects").select(`
                *,
                coords (
                  lat,lng
                )
              `).eq("room",x))["data"];f.forEach(async function(t){var a;t.completed&&(a=[],o.forEach(function(e,t){a.push(e.id)}),-1==$.inArray(t.id,a))&&(("draw"==t.type?t.line:(("marker"==t.type?t.marker:(t.trigger.remove(),t.local?t.layer:t.line)).remove(),$(".annotation-item[data-id='"+t.id+"']"))).remove(),f=$.grep(f,function(e){return e.id!=t.id}))}),0!=Object.keys(o).length&&o.forEach(function(e,t){e.user!=T.id&&(ne(e,o[t].id),async function(t,a){var o;"draw"!=t.type&&"line"!=t.type&&"area"!=t.type||0<f.filter(function(e){return e.id===a&&e.user===t.user}).length&&(o=[],Object.values(t.coords).forEach(function(e){o.push([e.lat,e.lng])}),f.filter(function(e){return e.id===a&&e.user===t.user})[0].line.setLatLngs(o))}(e,o[t].id))})}}).subscribe()}function se(){$("#overlay").hasClass("sign-show")&&$(".sign-show").removeClass("sign-show")}q.closeTooltip(),l.on("pm:drawstart",async({workingLayer:e})=>{q.openTooltip(),q.setTooltipContent("Click to place first vertex"),e.on("pm:vertexadded",async a=>{var e,t,o;"Polygon"==a.shape?(q.setTooltipContent("Click on first vertex to finish"),g=a.layer._latlngs[a.layer._latlngs.length-1],1==a.layer._latlngs.length?({data:t,error:e}=await _supabase.from("objects").insert({room:x,color:b,initlat:a.layer._latlngs[0].lat,initlng:a.layer._latlngs[0].lng,user:T.id,type:"area",session:r,name:"Area",desc:"",distance:0,area:0,completed:!1,path:[]}).select("id"),(y=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:g.lat,lng:g.lng}))["error"],f.push({id:y,local:!0,color:b,user:T.id,name:"Area",desc:"",trigger:"",distance:0,area:0,layer:"",type:"area",session:r,completed:!1})):(await _supabase.from("coords").insert({objects_id:y,lat:g.lat,lng:g.lng}))["error"]):"Line"==a.shape&&(s=!0,h=0,g=a.layer._latlngs[a.layer._latlngs.length-1],1==a.layer._latlngs.length?({data:t,error:o}=await _supabase.from("objects").insert({room:x,color:b,initlat:a.layer._latlngs[0].lat,initlng:a.layer._latlngs[0].lng,user:T.id,type:"line",session:r,name:"Line",desc:"",distance:0,completed:!1,path:[]}).select("id"),(y=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:g.lat,lng:g.lng}))["error"],f.push({id:y,local:!0,color:b,user:T.id,name:"Line",desc:"",trigger:"",distance:0,layer:"",type:"line",session:r,completed:!1})):(a.layer._latlngs.forEach(function(e,t){0!=t&&(h+=a.layer._latlngs[t-1].distanceTo(e))}),q.setTooltipContent(h/1e3+"km | Double click to finish"),(await _supabase.from("coords").insert({objects_id:y,lat:g.lat,lng:g.lng}))["error"]))})}),l.on("pm:drawend",e=>{s=!1,q.closeTooltip(),D()}),l.on("pm:create",async e=>{c=!0;var t,a,o,n,i,s=f.filter(function(e){return e.id===y&&e.user===T.id})[0],r=(s.distance=parseFloat(turf.length(e.layer.toGeoJSON()).toFixed(2)),s.layer=e.layer,"area"==s.type?(s.area=parseFloat((1e-6*turf.area(e.layer.toGeoJSON())).toFixed(2)),o=[],{data:t,error:a}=(Object.values(e.layer.getLatLngs()[0]).forEach(function(e){o.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:o,area:s.area}).eq("id",y).select())):"line"==s.type&&(o=[],{data:n,error:i}=(Object.values(e.layer.getLatLngs()).forEach(function(e){o.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:o}).eq("id",y).select())),L.marker(e.layer.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"}));r.bindTooltip('<label for="shape-name">Name</label><input value="'+s.name+'" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),r.setOpacity(0),r.addTo(l),r.openTooltip(),$("#shape-name").focus(),$("#shape-name").select(),s.trigger=r,e.layer.on("click",async function(e){var t,a;p||u||m?u?(e.target.pm.enable({}),e.target.on("pm:edit",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:s.area,distance:s.distance,path:t}).eq("id",s.id).select()})):m?e.target.on("pm:dragend",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:s.area,distance:s.distance,path:t}).eq("id",s.id).select()}):(s.trigger.remove(),e.layer.remove(),t=(await _supabase.from("coords").delete().eq("objects_id",s.id))["error"],a=(await _supabase.from("objects").delete().eq("id",s.id))["error"],f=$.grep(f,function(e){return e.id!=s.id}),$(".annotation-item[data-id='"+s.id+"']").remove()):(r.setLatLng(d),r.openTooltip())}),r.on("tooltipclose",function(e){c&&S(),$(".annotation-item[data-id="+s.id+"]").find(".annotation-name span").removeClass("annotation-focus")})}),l.addEventListener("mousedown",async e=>{U=!0;var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;d=[t,e],i&&X(t,e,T)}),l.addEventListener("click",async e=>{var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;d=[t,e],async function(e,t,a){var o,n,i,s;Z&&(D(),n=L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+b+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),{data:n,error:i}=((o=L.marker([e,t],{icon:n,direction:"top",interactive:!0,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Marker" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:0,y:-35})}),o.addTo(l),o.openTooltip(),await _supabase.from("objects").insert({room:x,color:b,lat:e,lng:t,user:a.id,type:"marker",m_type:"none",session:r,name:"Marker",desc:""}).select("id")),s=y=n[0].id,f.push({id:y,user:a.id,color:b,name:"Marker",m_type:"none",desc:"",lat:e,lng:t,marker:o,trigger:o,session:r,completed:!0,type:"marker"}),o.on("tooltipclose",function(e){c?S():$(".annotation-item[data-id="+s+"]").find(".annotation-name span").removeClass("annotation-focus")}),o.on("click",async function(e){var t;p||m?m?e.target.on("pm:dragend",async e=>{console.log(e.target._latlng.lat);var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",inst.id).select()}):(o.remove(),t=(await _supabase.from("objects").delete().eq("id",inst.id))["error"],f=$.grep(f,function(e){return e.id!=s})):o.openTooltip()}))}(t,e,T),i&&X(t,e,T)}),l.addEventListener("mouseup",e=>{U=!1}),l.addEventListener("mousemove",async e=>{var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;d=[t,e],q.setLatLng([t,e]),U&&i&&(f.filter(function(e){return e.id===y&&e.user===T.id})[0].line.addLatLng([t,e]),(await _supabase.from("coords").insert({objects_id:y,lat:t,lng:e}))["error"]),s&&q.setTooltipContent(((h+g.distanceTo([t,e]))/1e3).toFixed(2)+"km | Double click to finish")}),l.addEventListener("zoom",async e=>{var{}=await _supabase.from("users").update({view:[l.getBounds().getCenter().lat,l.getBounds().getCenter().lng],zoom:l.getZoom()}).eq("uid",T.id).select();N()}),l.addEventListener("movestart",e=>{0}),l.addEventListener("moveend",e=>{0}),$(document).keyup(function(e){$(e.target).is("input")||$(e.target).is("textarea")||("Escape"===e.key?normalMode():"Enter"===e.key?a?ee():n&&te():86==e.which?D():80==e.which?I():69==e.which?J():77==e.which?W():76==e.which?H():65==e.which&&V())}),$(document).on("click",function(e){$("#more-menu").hasClass("menu-show")&&"more-vertical"!=$(e.target).attr("id")&&"more-vertical"!=$(e.target).parent().attr("id")&&$("#more-menu").removeClass("menu-show")}),$(document).on("click","#pen-tool",I),$(document).on("click","#cursor-tool",D),$(document).on("click","#eraser-tool",J),$(document).on("click","#marker-tool",W),$(document).on("click","#area-tool",V),$(document).on("click","#path-tool",H),$(document).on("click",".color",function(e){e.stopPropagation(),b=$(this).attr("data-color"),$("#inner-color").css({background:b}),K()}),$(document).on("click","#inner-color",K),$(document).on("mouseover",".tool",function(){"cursor-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Move (V)</div>'):"pen-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Pencil (P)</div>'):"eraser-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Eraser (E)</div>'):"marker-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Marker (M)</div>'):"area-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Area (A)</div>'):"path-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Line (L)</div>'):"edit-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Edit (ED)</div>'):"drag-tool"==$(this).attr("id")&&$(this).append('<div id="tooltip">Drag (D)</div>')}),$(document).on("mouseout",".tool",function(){$(this).find("#tooltip").remove()}),$(document).on("click",".save-button",async function(e){c=!1;var t,a,o,n,i,s,r=f.filter(function(e){return e.id===y&&e.user===T.id})[0];r.name=P($("#shape-name").val()),r.desc=P($("#shape-desc").val()),r.completed=!0,r.trigger.unbindTooltip(),"area"==r.type?(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+r.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+r.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:t,error:a}=await _supabase.from("objects").update({area:r.area,distance:r.distance,name:r.name,desc:r.desc,completed:!0}).eq("id",y).select()):"line"==r.type?(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+r.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:o,error:n}=await _supabase.from("objects").update({distance:r.distance,name:r.name,desc:r.desc,completed:!0}).eq("id",y).select()):"marker"==r.type&&(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+r.lat.toFixed(5)+", "+r.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),{data:i,error:s}=await _supabase.from("objects").update({name:r.name,desc:r.desc,completed:!0}).eq("id",y).select()),B(r),$(".annotation-item[data-id='"+r.id+"']").find(".annotation-name span").addClass("annotation-focus"),window.setTimeout(function(){r.trigger.openTooltip()},200)}),$(document).on("click",".cancel-button",S),$(document).on("click",".avatars",async function(){var t=$(this).attr("data-id");t!=T.id&&(v.id==t?N():(v.status=!0,v.id=t,$("#outline").css({border:"6px solid "+w.find(e=>e.id===t).color}),$("#observing-name").html("Observing "+w.find(e=>e.id===t).name),$("#observing-name").css({background:w.find(e=>e.id===t).color}),$("#outline").addClass("observing")))}),$(document).on("click",".annotation-arrow",function(e){e.preventDefault(),e.stopPropagation(),$(this).hasClass("arrow-open")?($(this).removeClass("arrow-open"),$(this).parent().parent().find(".annotation-details").addClass("annotation-closed")):($(this).addClass("arrow-open"),$(this).parent().parent().find(".annotation-details").removeClass("annotation-closed"))}),$(document).on("click",".annotation-item",function(){if(F(),!$(this).find(".annotation-name span").hasClass("annotation-focus")){const t=$(this).attr("data-id");var e=$.grep(f,function(e){return e.id==t})[0];$(".annotation-focus").removeClass("annotation-focus"),l.eachLayer(function(e){"markerPane"!=e.options.pane&&e.closeTooltip()}),$(this).find(".annotation-name span").addClass("annotation-focus"),"line"==e.type||"area"==e.type?(l.panTo(e.trigger.getLatLng()),$(e.trigger.getTooltip()._container).removeClass("tooltip-off"),e.trigger.openTooltip()):"marker"==e.type&&(l.panTo(e.marker.getLatLng()),$(e.marker.getTooltip()._container).removeClass("tooltip-off"),e.marker.openTooltip())}}),$(document).on("click",".delete-layer",async function(e){e.preventDefault(),e.stopPropagation();const t=$(this).parent().parent().attr("data-id"),a=$.grep(f,function(e){return e.id==t})[0];$(".annotation-item[data-id='"+t+"']").remove(),f="marker"!=a.type?(a.trigger.remove(),a.line.remove(),(await _supabase.from("coords").delete().eq("objects_id",a.id))["error"],(await _supabase.from("objects").delete().eq("id",a.id))["error"],$.grep(f,function(e){return e.id!=a.id})):(a.marker.remove(),(await _supabase.from("objects").delete().eq("id",a.id))["error"],$.grep(f,function(e){return e.id!=a.id}))}),$(document).on("mousedown","#map-name",async function(e){3!=e.which||a||(A=t,a=!0,$("#map-name").prop("disabled",!1),$("#map-name").addClass("map-editing"))}),$(document).on("mouseup","#map-name",function(){$("#map-name").select(),$("#map-name").addClass("map-editing"),$("#map-name").prop("disabled",!1)}),$(document).on("focusout","#map-name",ee),$(document).on("mousedown","#map-description",async function(){n||(z=o,n=!0,$("#map-description").prop("disabled",!1),$("#map-description").addClass("map-editing"))}),$(document).on("mouseup","#map-description",function(){$("#map-description").select(),$("#map-description").addClass("map-editing")}),$(document).on("focusout","#map-description",te),$(document).on("click","#hide-annotations",function(){$("#hide-annotations").hasClass("hidden-annotations")?F():($(".leaflet-overlay-pane").css({visibility:"hidden","pointer-events":"none"}),$(".leaflet-tooltip-pane").css({visibility:"hidden","pointer-events":"none"}),$("#hide-annotations").addClass("hidden-annotations"),$("#hide-annotations").html("Show all"))}),$(document).on("click","#location-control",function e(){N(),navigator.geolocation&&(""!=k?navigator.geolocation.getCurrentPosition(function(e){k.setLatLng([e.coords.latitude,e.coords.longitude]),l.flyTo(k.getLatLng(),18)}):(G(),e()))}),$(document).on("click",".find-nearby",async function(){var o=$(this).attr("data-type"),n=$(this).attr("data-color"),e=l.getBounds().getNorthWest().lng+","+l.getBounds().getNorthWest().lat+","+l.getBounds().getSouthEast().lng+","+l.getBounds().getSouthEast().lat;$.get("https://nominatim.openstreetmap.org/search?viewbox="+e+"&format=geocodejson&limit=20&bounded=1&amenity="+o+"&exclude_place_ids="+JSON.stringify(C),function(e){var a=L.icon({iconUrl:"/static/supa-mapus/assets/"+o+"-marker.svg",iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]});e.features.forEach(function(e){var t=L.marker([e.geometry.coordinates[1],e.geometry.coordinates[0]],{icon:a,pane:"overlayPane",interactive:!0}).addTo(l);t.bindTooltip("<h1>"+e.properties.geocoding.name+'</h1><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.geometry.coordinates[1].toFixed(5)+", "+e.geometry.coordinates[0].toFixed(5)+'</h3></div><br><div id="buttons2"><button class="cancel-button-place" data-id='+e.properties.geocoding.place_id+'>Remove</button><button class="save-button-place" data-id='+e.properties.geocoding.place_id+'>Save</button></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),_.push({id:"",place_id:e.properties.geocoding.place_id,user:T.id,name:e.properties.geocoding.name,desc:"",lat:e.geometry.coordinates[1],lng:e.geometry.coordinates[0],trigger:t,completed:!0,marker:t,m_type:o,type:"marker",session:r,color:n}),C.push(e.properties.geocoding.place_id)})})}),$(document).on("click",".save-button-place",async function(){var e=_.find(e=>e.place_id==$(this).attr("data-id")),t=(await _supabase.from("objects").insert({color:e.color,place_id:e.place_id,lat:e.lat,lng:e.lng,user:T.id,type:"marker",m_type:e.m_type,session:r,name:e.name,desc:""}).select("id"))["data"];y=t[0].id,e.id=y,f.push(e),e.marker.bindTooltip("<h1>"+e.name+'</h1><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+'</h3></div><br><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})})}),$(document).on("click",".cancel-button-place",function(){var t=_.find(e=>e.place_id==$(this).attr("data-id"));t.marker.remove(),_=$.grep(_,function(e){return e.place_id!=t.id}),C=$.grep(C,function(e){return e!=t.id})}),$(document).on("click","#more-vertical",function(){$("#more-menu").hasClass("menu-show")?$("#more-menu").removeClass("menu-show"):$("#more-menu").addClass("menu-show")}),$(document).on("click","#geojson",function(){var t=new L.FeatureGroup,e=(l.addLayer(t),l.eachLayer(function(e){(e instanceof L.Marker||e instanceof L.Polyline||e instanceof L.Polygon)&&e.addTo(t)}),document.createElement("a")),a=new Blob([JSON.stringify(t.toGeoJSON())],{type:"application/json"});e.href=URL.createObjectURL(a),e.download="geojson",e.click()}),$(document).on("click","#search-box img",Q),$(document).on("click","#google-signin",async function(){var e,t,a,o=P($("#email").val()),n=P($("#password").val()),n=(null==(o=(await _supabase.auth.signInWithPassword({email:o,password:n}))["error"])&&se(),await _supabase.auth.getUser())["data"]["user"];T=n,j.has("file")?($(".signin").removeClass("signin"),o=R[Math.floor(Math.random()*R.length)],{data:n,error:e}=await _supabase.from("users").select().eq("uid",T.id),0==n.length?{data:t,error:a}=await _supabase.from("users").insert({room:x,uid:T.id,lat:0,lng:0,active:!0,color:o,name:T.email,view:[l.getBounds().getCenter().lat,l.getBounds().getCenter().lng],zoom:l.getZoom()}).select("id"):(await _supabase.from("users").update({lat:0,lng:0,active:!0,color:o,name:T.email,view:[l.getBounds().getCenter().lat,l.getBounds().getCenter().lng],zoom:l.getZoom()}).eq("uid",T.id))["error"],window.setTimeout(async function(){var e=(await _supabase.from("users").select().eq("uid",T.id))["data"];r=e.session},100),ie()):($("#popup").find(".header-text").html("Create a map"),$("#popup").find(".subheader-text").html("Maps can be shared with friends to collaborate in real-time."),$("#google-signin").attr("id","create-map"),$("#create-map").html("Create a map"))}),$(document).on("click","#create-map",async function(){var e=(e=(await _supabase.from("rooms").insert({name:"New map",description:"Map description"}).select("id"))["data"])[0].id;window.location.replace(window.location.href+"?file="+e)}),$(document).on("click","#logout",async function(){var{}=await _supabase.auth.signOut().then(function(){$("#popup").addClass("signin"),$("#overlay").addClass("signin")})}),$(document).on("click","#share-button",function(){$("#share").addClass("share-show"),$("#overlay").addClass("share-show")}),$(document).on("click","#overlay",ae),$(document).on("click","#close-share",ae),$(document).on("click","#share-copy",function(){$("#share-url").focus(),$("#share-url").select(),document.execCommand("copy")}),$(document).on("click","#zoom-in",function(){l.zoomIn()}),$(document).on("click","#zoom-out",function(){l.zoomOut()}),$(document).on("click","#sign-button",function(){$("#sign").addClass("sign-show"),$("#overlay").addClass("sign-show")}),$(document).on("click","#close-sign",se),$(document).on("click","#importgeojson",function(){$('<input type="file" value="选择文件"></input>').click().on("change",e=>{e=e.target.files[0];let t=new FileReader;t.onload=()=>{var e=t.result;!async function(e){console.log(e);var a={radius:8,fillColor:"#ff7800",color:"#000",weight:1,opacity:1,fillOpacity:.8};L.geoJSON(e.features,{pointToLayer:function(e,t){return L.circleMarker(t,a)}}).addTo(l),e.features.forEach(async function(o,e){var n,t,a,i;"LineString"==o.geometry.type&&(n=[],i=o.geometry.coordinates.length,{data:a,error:t}=(o.geometry.coordinates.forEach(function(e,t){var a;0!=t&&(t=L.latLng(o.geometry.coordinates[t-1][1],o.geometry.coordinates[t-1][0]),a=L.latLng(e[1],e[0]),h+=t.distanceTo(a)),n.push([e[1],e[0]])}),await _supabase.from("objects").insert({room:x,color:b,initlat:o.geometry.coordinates[0][1],initlng:o.geometry.coordinates[0][0],user:T.id,type:"line",session:r,name:"Line",desc:"",distance:h,completed:!0,path:n}).select("id")),(y=a[0].id,await _supabase.from("coords").insert({objects_id:a[0].id,lat:o.geometry.coordinates[i-1][1],lng:o.geometry.coordinates[i-1][0]}))["error"],f.push({id:y,local:!0,color:b,user:T.id,name:"Line",desc:"",trigger:"",distance:h,layer:"",type:"line",session:r,completed:!0}),c=!0,a=f.filter(function(e){return e.id===y&&e.user===T.id})[0],(i=L.marker(l.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Line" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),i.setOpacity(0),i.addTo(l),i.openTooltip(),$("#shape-name").focus(),$("#shape-name").select(),a.trigger=i,p||u||m||(i.setLatLng(d),i.openTooltip()),i.on("tooltipclose",function(e){c&&S(),$(".annotation-item[data-id="+y+"]").find(".annotation-name span").removeClass("annotation-focus")}))})}(JSON.parse(e))},t.readAsText(e,"UTF-8")})}),$(document).on("click","#xmltogeojson",function(){$('<input type="file" value="选择文件"></input>').click().on("change",e=>{e=e.target.files[0];let c=new FileReader;c.onload=()=>{var e=c.result.split(/\r\n|\n/);let t="";e.map(e=>{e.length&&!e.startsWith(";")&&(-1!==e.indexOf("<Placemark")&&(t+="{"),t+=e,-1!==e.indexOf("</Placemark"))&&(t+="}")});var a,o=t.split("}"),n={type:"FeatureCollection",features:[]},i={type:"FeatureCollection",features:[]};for(let e=0;e<o.length-2;e++)if(o[e].split("<Placemark")[1]){var s=o[e].split("<coordinates>")[1].split("</coordinates>")[0].split(/ |,/),r=[];for(let e=0;e<s.length;e+=1)""!=s[e]&&""!=s[e+1]&&""!=s[e+2]&&r.push([Number(s[e]),Number(s[e+1]),Number(s[e+2])]);n.features.push({type:"Feature",geometry:{type:"LineString",coordinates:r},properties:{measure:o[e].split("<Placemark")[1].split('">')[0]}})}for(let e=0;e<o.length;e++)o[e].split("<Placemark")[1]&&(a=o[e].split("<coordinates>")[1].split("</coordinates>")[0].split(","),i.features.push({type:"Feature",geometry:{type:"Point",coordinates:[Number(a[0]),Number(a[1])]},properties:{measure:o[e].split("<Placemark")[1].split('">')[0]}}));var e=document.createElement("a"),l=new Blob([JSON.stringify(n)],{type:"application/json"});e.href=URL.createObjectURL(l),e.download="geojson",e.click()},c.readAsText(e,"UTF-8")})}),$(document).on("click","#edit-tool",function(){O(),u=!0,$(".tool-active").removeClass("tool-active"),$("#edit-tool").addClass("tool-active"),F()}),$(document).on("click","#drag-tool",function(){O(),m=!0,$(".tool-active").removeClass("tool-active"),$("#drag-tool").addClass("tool-active"),l.pm._globalDragModeEnabled||l.pm.toggleGlobalDragMode(),F()}),$(document).on("keydown","#search-input",function(e){"Enter"===e.key&&Q()}),L.Projection.BaiduMercator=L.Util.extend({},L.Projection.Mercator,{R:6378206,R_MINOR:6356584.314245179,bounds:new L.Bounds([-20037725.11268234,-19994619.55417086],[20037725.11268234,19994619.55417086])}),L.CRS.Baidu=L.Util.extend({},L.CRS.Earth,{code:"EPSG:Baidu",projection:L.Projection.BaiduMercator,transformation:new L.transformation(1,.5,-1,.5),scale:function(e){return 1/Math.pow(2,18-e)},zoom:function(e){return 18-Math.log(1/e)/Math.LN2},wrapLng:void 0}),L.TileLayer.BaiDuTileLayer=L.TileLayer.extend({initialize:function(e,t){var a="img"===e?"https://maponline{s}.bdimg.com/starpic/u=x={x};y={y};z={z};v=009;type=sate&qt=satepc&fm=46&app=webearth2&v=009":"https://maponline{s}.bdimg.com/tile/?x={x}&y={y}&z={z}&{p}";t=L.extend({getUrlArgs:e=>({x:e.x,y:-1-e.y,z:e.z}),p:e,subdomains:"0123",minZoom:0,maxZoom:23,minNativeZoom:1,maxNativeZoom:18},t),L.TileLayer.prototype.initialize.call(this,a,t)},getTileUrl:function(e){return this.options.getUrlArgs?L.Util.template(this._url,L.extend({s:this._getSubdomain(e),r:L.Browser.retina?"@2x":""},this.options.getUrlArgs(e),this.options)):L.TileLayer.prototype.getTileUrl.call(this,e)},_setZoomTransform:function(e,t,a){t=L.latLng(gcoord.transform([t.lng,t.lat],gcoord.WGS84,gcoord.BD09).reverse()),L.TileLayer.prototype._setZoomTransform.call(this,e,t,a)},_getTiledPixelBounds:function(e){return e=L.latLng(gcoord.transform([e.lng,e.lat],gcoord.WGS84,gcoord.BD09).reverse()),L.TileLayer.prototype._getTiledPixelBounds.call(this,e)}}),L.tileLayer.baiDuTileLayer=function(e,t){return new L.TileLayer.BaiDuTileLayer(e,t)},E=L.tileLayer.baiDuTileLayer("img"),M=L.tileLayer.baiDuTileLayer("qt=vtile&styles=sl&showtext=0&scaler=1&v=083"),vsl11_Layer=L.tileLayer.baiDuTileLayer("qt=vtile&styles=sl&showtext=1&scaler=1&v=083"),vsl12_Layer=L.tileLayer.baiDuTileLayer("qt=vtile&styles=sl&showtext=1&scaler=2&v=083"),vpl01_Layer=L.tileLayer.baiDuTileLayer("qt=vtile&styles=pl&showtext=0&scaler=1&v=083"),vpl11_Layer=L.tileLayer.baiDuTileLayer("qt=vtile&styles=pl&showtext=1&scaler=1&v=083"),vpl12_Layer=L.tileLayer.baiDuTileLayer("qt=vtile&styles=pl&showtext=1&scaler=2&v=083"),vph01_Layer=L.tileLayer.baiDuTileLayer("qt=vtile&styles=ph&showtext=0&scaler=1&v=083"),vph11_Layer=L.tileLayer.baiDuTileLayer("qt=vtile&styles=ph&showtext=1&scaler=1&v=083"),_sl11_Layer=L.tileLayer.baiDuTileLayer("qt=tile&styles=sl&showtext=1&scaler=1&v=083"),_sl12_Layer=L.tileLayer.baiDuTileLayer("qt=tile&styles=sl&showtext=1&scaler=2&v=083"),_pl11_Layer=L.tileLayer.baiDuTileLayer("qt=tile&styles=pl&showtext=1&scaler=1&v=083"),_pl12_Layer=L.tileLayer.baiDuTileLayer("qt=tile&styles=pl&showtext=1&scaler=2&v=083"),_ph11_Layer=L.tileLayer.baiDuTileLayer("qt=tile&styles=ph&showtext=1&scaler=1&v=083"),E={"影像底图":E,"影像标注，路网":M,"影像标注，路网 + 注记":vsl11_Layer,"影像标注，路网 + 高清注记":vsl12_Layer,"电子地图，图形":vpl01_Layer,"电子地图，图形 + 注记":vpl11_Layer,"电子地图，图形 + 高清注记":vpl12_Layer,"大字体电子地图，图形":vph01_Layer,"大字体电子地图，图形 + 注记":vph11_Layer,"旧影像标注，路网 + 注记":_sl11_Layer,"旧影像标注，路网 + 高清注记":_sl12_Layer,"旧电子地图，图形 + 注记":_pl11_Layer,"旧电子地图，图形 + 高清注记":_pl12_Layer,"旧大字体电子地图，图形 + 注记":_ph11_Layer},L.control.layers([],E,{autoZIndex:!1}).addTo(l),M=null,document.getElementById("url-input").value="img",E="img",window.event&&13!==window.event.keyCode||(null!==M&&(l.removeLayer(M),M=null),E&&(M=L.tileLayer.baiDuTileLayer(E),l.addLayer(M))),$("img[src='https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png']").remove(),G()});