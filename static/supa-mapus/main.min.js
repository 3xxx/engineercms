$(document).ready(function(){var D="AhJFIXaWTfryahNRyQFR6gKLDqmxB34-FGH6VB5VYas4YJWgO1_bQT6WLWYWQD0g",u=L.map("mapDiv").setView([23.125178,113.280637],12),B=L.tileLayer.bing(D).addTo(u),Z=(L.Measure={linearMeasurement:"Distance measurement",areaMeasurement:"Area measurement",start:"开始",meter:"m",kilometer:"km",squareMeter:"m²",squareKilometers:"km²"},L.control.measure({}).addTo(u),L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",{id:"mapbox/streets-v11",tileSize:512,zoomOffset:-1,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:23,maxNativeZoom:19})),z=(L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),L.tileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"&copy; Esri &mdash; Sources: Esri, DigitalGlobe, Earthstar Geographics, CNES/Airbus DS, GeoEye, USDA FSA, USGS, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community"})),U=L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19}),t=(L.control.layers({Bing:B,ArcGIS:z},{"CartoDB Positron":U,Streets:Z},{position:"topleft"}).addTo(u),L.PM.setOptIn(!0),""),G="",o="",R="",a=!1,n=!1,i="",Y="",g=!1,v=[0,0],c=0,s=!1,h=!1,f=!1,b=!1,J=!1,r=!1,l=[0,0],d={status:!1,id:0},p=0,X=!1,y=[],w=0,m="#634FF1",k=[],C="",_=[],x=[],T="",W=!1,V=new Array,j={},E=new Object,H=["#EC1D43","#EC811D","#ECBE1D","#B6EC1D","#1DA2EC","#781DEC","#CF1DEC","#222222"],M=new URLSearchParams(window.location.search);M.has("file")&&(T=M.get("file"),$("#share-url").val(window.location.href)),window.setTimeout(async function(){var e,t;await re()&&M.has("file")?ue():((await re()&&!M.has("file")?($("#popup").find(".header-text").html("Create a map"),$("#popup").find(".subheader-text").html("Maps can be shared with friends to collaborate in real-time."),$("#google-signin").attr("id","create-map"),$(".create-map").html("Create a map"),{data:e,error:t}=await _supabase.from("rooms").select(),console.log("data",e),e.forEach(function(e,t){$("#room-list").prepend('<div class="room-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg"> <input value='+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.description+' disabled class="annotation-description"></div></div>')}),$("#popup")):($("#popup").removeClass("signin"),$("#sign"))).addClass("signin"),$("#overlay").addClass("signin"))},500);L.control.scale();L.control.scale({metric:!0,imperial:!1}).addTo(u);(new(L.Control.extend({onAdd(){const t=L.DomUtil.create("div");return t.style.width="100px",t.style.background="rgba(255,255,255,0.5)",t.style.textAlign="left",u.on("zoomstart zoom zoomend",e=>{t.innerHTML="Zoom level: "+u.getZoom()}),t}}))).addTo(u);u.pm.addControls();var S=L.marker([0,0],{pane:"overlayPane",interactive:!1}).addTo(u);S.setOpacity(0),S.bindTooltip("",{permanent:!0,offset:[5,25],sticky:!0,className:"hints",direction:"right"}).addTo(u);function K(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t=L.icon({iconUrl:"/static/supa-mapus/assets/liveLocation.svg",iconSize:[24,24],iconAnchor:[12,12]});(C=L.marker([e.coords.latitude,e.coords.longitude],{icon:t,pane:"overlayPane"})).addTo(u)})}function O(){r=J=b=f=h=s=!1,u.pm.disableDraw(),u.pm.disableGlobalRemovalMode(),u.pm._globalDragModeEnabled&&u.pm.toggleGlobalDragMode(),u.pm.disableGlobalEditMode(),u.eachLayer(function(e){"markerPane"!=e.options.pane&&e.closeTooltip()})}function P(){O(),u.dragging.enable(),$(".tool-active").removeClass("tool-active"),$("#cursor-tool").addClass("tool-active")}function Q(){O(),s=!0,u.dragging.disable(),$(".tool-active").removeClass("tool-active"),$("#pen-tool").addClass("tool-active"),I()}function ee(){O(),h=!0,$(".tool-active").removeClass("tool-active"),$("#eraser-tool").addClass("tool-active"),u.pm.enableGlobalRemovalMode(),I()}function te(){O(),J=!0,$(".tool-active").removeClass("tool-active"),$("#marker-tool").addClass("tool-active"),I()}function ae(){O(),$(".tool-active").removeClass("tool-active"),$("#area-tool").addClass("tool-active"),u.pm.setGlobalOptions({pinning:!0,snappable:!0}),u.pm.setPathOptions({color:m,fillColor:m,fillOpacity:.4}),u.pm.enableDraw("Polygon",{tooltips:!1,snappable:!0,templineStyle:{color:m},hintlineStyle:{color:m,dashArray:[5,5]},pmIgnore:!1}),I()}function oe(){O(),$(".tool-active").removeClass("tool-active"),$("#path-tool").addClass("tool-active"),u.pm.setGlobalOptions({pinning:!0,snappable:!0}),u.pm.setPathOptions({color:m,fillColor:m,fillOpacity:.4}),u.pm.enableDraw("Line",{tooltips:!1,snappable:!0,templineStyle:{color:m},hintlineStyle:{color:m,dashArray:[5,5]},pmIgnore:!1,finishOn:"dblclick"}),I()}function ne(){$("#color-list").toggleClass("color-enabled")}function N(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return e.replace(/[&<>"'/]/gi,e=>t[e])}function ie(){$.ajax({type:"GET",async:!1,url:"/v1/wx/tianditusearch",data:{keyword:N($("#search-box input").val())},success:function(e){u.panTo(new L.LatLng(e.lat,e.lon))}})}function q(){d.status=!1,$("#outline").css({border:"none"}),$("#outline").removeClass("observing")}async function A(){g=!1;var e,t,a,o,n,i,s=y.filter(function(e){return e.id===w&&e.user===E.id})[0];s.trigger.unbindTooltip(),s.completed=!0,"area"==s.type?(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+s.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+s.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:e,error:t}=await _supabase.from("objects").update({area:s.area,distance:s.distance,name:s.name,desc:s.desc,completed:!0}).eq("id",w).select()):"line"==s.type?(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+s.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:a,error:o}=await _supabase.from("objects").update({distance:s.distance,name:s.name,desc:s.desc,completed:!0}).eq("id",w).select()):"marker"==s.type&&(s.trigger.bindTooltip("<h1>"+s.name+"</h1><h2>"+s.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+s.lat.toFixed(5)+", "+s.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),{data:n,error:i}=await _supabase.from("objects").update({name:s.name,desc:s.desc,completed:!0}).eq("id",w).select()),F(s),$(".annotation-item[data-id='"+s.id+"']").find(".annotation-name input").addClass("annotation-focus"),window.setTimeout(function(){s.trigger.openTooltip()},200)}async function se(t,a,o){var n=L.polyline([[t,a]],{color:m,pmIgnore:!1}),i=(await _supabase.from("objects").insert({room:T,color:m,initlat:t,initlng:a,user:o.id,type:"draw",session:c,completed:!0}).select("id"))["data"],{}=(w=i[0].id,await _supabase.from("coords").insert({objects_id:i[0].id,lat:t,lng:a}));y.push({id:w,user:o.id,line:n,session:c,local:!0,completed:!0,type:"draw"}),n.addTo(u),y.forEach(function(n){n.line.on("click",async function(t){var a,o;h?(n.line.remove(),a=(await _supabase.from("coords").delete().eq("objects_id",n.id))["error"],o=(await _supabase.from("objects").delete().eq("id",n.id))["error"],y=$.grep(y,function(e){return e.id!=n.id}),$(".annotation-item[data-id='"+n.id+"']").remove()):f&&(e.target.pm.enable({}),e.target.on("pm:edit",e=>{console.log(e.target._latlngs),console.log(e.target.getLatLngs()),console.log(n.id)}))}),n.line.on("mouseover",function(e){h&&n.line.setStyle({opacity:.3})}),n.line.on("mouseout",function(e){n.line.setStyle({opacity:1})})})}async function re(){var{user:e}=(await _supabase.auth.getUser())["data"];return null!=(E=e)&&E}function F(e){var t;0==$(".annotation-item[data-id='"+e.id+"']").length?"line"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M14.5 8.5L8.5 14.5" stroke="white" stroke-width="1.5" stroke-linecap="square"/><path d="M15.8108 8.53378C16.7176 8.53378 17.4527 7.79868 17.4527 6.89189C17.4527 5.9851 16.7176 5.25 15.8108 5.25C14.904 5.25 14.1689 5.9851 14.1689 6.89189C14.1689 7.79868 14.904 8.53378 15.8108 8.53378Z" stroke="white" stroke-width="1.5"/><circle cx="6.89189" cy="15.8108" r="1.64189" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/distance-icon.svg">'+e.distance+" km</div></div></div></div>")):"area"==e.type?(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M15.3652 8.5V13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M8.5 15.3649H13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M14.5303 9.03033C14.8232 8.73744 14.8232 8.26256 14.5303 7.96967C14.2374 7.67678 13.7626 7.67678 13.4697 7.96967L14.5303 9.03033ZM7.96967 13.4697C7.67678 13.7626 7.67678 14.2374 7.96967 14.5303C8.26256 14.8232 8.73744 14.8232 9.03033 14.5303L7.96967 13.4697ZM13.4697 7.96967L7.96967 13.4697L9.03033 14.5303L14.5303 9.03033L13.4697 7.96967Z" fill="white"/><circle cx="15.365" cy="6.85135" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="15.365" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/><circle cx="6.85135" cy="15.3649" r="1.60135" stroke="white" stroke-width="1.5"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div></div></div></div>")):"marker"==e.type&&(t='<svg class="annotation-icon" width="23" height="23" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="23" height="23" rx="5" fill="'+e.color+'"/><path d="M16.0252 11.2709C16.0252 14.8438 11.3002 17.9063 11.3002 17.9063C11.3002 17.9063 6.5752 14.8438 6.5752 11.2709C6.5752 10.0525 7.07301 8.8841 7.95912 8.0226C8.84522 7.16111 10.047 6.67712 11.3002 6.67712C12.5533 6.67712 13.7552 7.16111 14.6413 8.0226C15.5274 8.8841 16.0252 10.0525 16.0252 11.2709Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.2996 12.8021C12.1695 12.8021 12.8746 12.1166 12.8746 11.2709C12.8746 10.4252 12.1695 9.73962 11.2996 9.73962C10.4298 9.73962 9.72461 10.4252 9.72461 11.2709C9.72461 12.1166 10.4298 12.8021 11.2996 12.8021Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',$("#annotations-list").prepend('<div class="annotation-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg">'+t+"<input value="+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.desc+' disabled class="annotation-description"><div class="annotation-data"><div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div></div></div></div>")):(t=$(".annotation-item[data-id='"+e.id+"']"),"line"==e.type?(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/distance-icon.svg">'+e.distance+" km</div>")):"area"==e.type?(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/area-icon.svg">'+e.area+' km&sup2;</div><div class="annotation-data-field"><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+e.distance+" km</div>")):"marker"==e.type&&(t.find(".annotation-name input").html(e.name),t.find(".annotation-description").html(e.desc),t.find(".annotation-data").html('<div class="annotation-data-field"><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+"</div>")))}async function le(){a=!1,$("#map-name").prop("disabled",!0),$("#map-name").removeClass("map-editing");var e,t=N($("#map-name").val());0==t.length?$("#map-name").val(G):e=(await _supabase.from("rooms").update({name:t}).eq("id",T))["error"]}async function ce(){n=!1,$("#map-description").prop("disabled",!0),$("#map-description").removeClass("map-editing");var e,t=N($("#map-description").val());0==t.length?$("#map-description").val(R):e=(await _supabase.from("rooms").update({description:t}).eq("id",T))["error"]}function I(){$(".leaflet-overlay-pane").css({visibility:"visible","pointer-events":"all"}),$(".leaflet-tooltip-pane").css({visibility:"visible","pointer-events":"all"}),$("#hide-annotations").removeClass("hidden-annotations"),$("#hide-annotations").html("Hide all")}function de(){$("#overlay").hasClass("share-show")&&$(".share-show").removeClass("share-show")}async function pe(e,t){var a;t!=E.id&&(e.active?k.find(e=>e.id===t)?(k.find(e=>e.id===t).cursor.setLatLng([e.lat,e.lng]),1==d.status&&t==d.id&&(u.setZoom(e.zoom),u.panTo(new L.LatLng(e.view[0],e.view[1])))):(a=L.divIcon({html:'<svg width="18" height="18" style="z-index:9999!important" viewBox="0 0 18 18" fill="none" style="background:none;" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.51169 15.8783L1.08855 3.64956C0.511984 2.05552 2.05554 0.511969 3.64957 1.08853L15.8783 5.51168C17.5843 6.12877 17.6534 8.51606 15.9858 9.23072L11.2573 11.2573L9.23074 15.9858C8.51607 17.6534 6.12878 17.5843 5.51169 15.8783Z" fill="'+e.color+'"/></svg>',iconSize:[22,22],iconAnchor:[0,0],shadowAnchor:[4,62],popupAnchor:[-3,-76],className:"cursoricon"}),(a=L.marker([e.lat,e.lng],{icon:a,pane:"markerPane"})).bindTooltip(e.name,{permanent:!0,offset:[14,32],className:"cursor-label color"+e.color.replace("#",""),direction:"right"}),a.addTo(u),k.push({id:t,cursor:a,color:e.color,name:e.name}),null==(a=e.imgsrc)?(a=e.name,$("#right-nav").prepend('<div id="profile" style="background:'+e.color+'!important" class="avatars" data-id="'+t+'">'+a+"</div>")):$("#right-nav").prepend('<div id="profile" style="background:'+e.color+'!important" class="avatars" data-id="'+t+'"><img src="'+a+'"></div>')):!e.active&&k.find(e=>e.id===t)&&(1==d.status&&t==d.id&&q(),$(".avatars[data-id="+t+"]").remove(),k.find(e=>e.id===t).cursor.remove(),k=$.grep(k,function(e){return e.id!=t})))}async function me(o,n){var i,t,e,a,s;"draw"==o.type||"line"==o.type||"area"==o.type?0==y.filter(function(e){return e.id===n&&e.user===o.user}).length?(i=L.polyline([[o.initlat,o.initlng]],{color:o.color,pmIgnore:!1}),(i=!o.completed||"line"!=o.type&&"area"!=o.type?i:L.polyline(o.path,{color:o.color,pmIgnore:!1})).addTo(u),"area"==o.type?y.push({id:n,local:!1,user:o.user,color:o.color,line:i,name:o.name,desc:o.desc,distance:o.distance,area:o.area,path:o.path,completed:o.completed,type:o.type,trigger:"",session:o.session}):y.push({id:n,local:!1,user:o.user,color:o.color,line:i,name:o.name,desc:o.desc,distance:o.distance,path:o.path,completed:o.completed,type:o.type,trigger:"",session:o.session}),i.on("click",async function(e){var t,a;o.completed&&"draw"==o.type&&h?(i.remove(),t=(await _supabase.from("coords").delete().eq("objects_id",s.id))["error"],a=(await _supabase.from("objects").delete().eq("id",n))["error"],y=$.grep(y,function(e){return e.id!=n})):f?(e.target.pm.enable({}),e.target.on("pm:edit",e=>{console.log(e.target._latlngs),console.log(e.target.getLatLngs()),console.log(s.id)})):b&&e.target.on("pm:dragend",e=>{console.log(e)})}),i.on("mouseover",function(e){h&&"draw"==o.type&&i.setStyle({opacity:.3})}),i.on("mouseout",function(e){"draw"==o.type&&i.setStyle({opacity:1})})):(t=[],Object.values(o.coords).forEach(function(e){t.push([e.lat,e.lng])}),y.filter(function(e){return e.id===n&&e.user===o.user})[0].line.setLatLngs(t)):"marker"==o.type&&(0==y.filter(function(e){return e.id===n&&e.user===o.user}).length?(e="none"==o.m_type?L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+o.color+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}):L.icon({iconUrl:"/static/supa-mapus/assets/"+o.m_type+"-marker.svg",iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),(a=L.marker([o.lat,o.lng],{icon:e,interactive:!0,direction:"top",pane:"overlayPane",pmIgnore:!1})).bindTooltip("<h1>"+o.name+"</h1><h2>"+o.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+o.lat.toFixed(5)+", "+o.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",className:"create-shape-flow tooltip-off",interactive:!1,bubblingMouseEvents:!1,offset:L.point({x:0,y:-35})}),a.addTo(u),a.openTooltip(),y.push({id:n,user:o.user,marker:a,color:o.color,name:o.name,desc:o.desc,session:o.session,local:!1,lat:o.lat,lng:o.lng,completed:!0,type:"marker"}),a.on("click",async function(e){var t;h||b?b?e.target.on("pm:dragend",async e=>{console.log(e.target._latlng.lat);var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",s.id).select()}):(a.remove(),t=(await _supabase.from("objects").delete().eq("id",n))["error"],y=$.grep(y,function(e){return e.id!=n}),$(".annotation-item[data-id='"+n+"']").remove()):($(a.getTooltip()._container).removeClass("tooltip-off"),a.openTooltip())}),a.on("tooltipclose",function(){$(".annotation-item[data-id="+n+"]").find(".annotation-name input").removeClass("annotation-focus")}),a.closeTooltip(),F(y.find(e=>e.id==n))):F(y.filter(function(e){return e.id===n&&e.user===o.user}))),o.completed&&0<y.filter(function(e){return e.id===n&&e.user===o.user}).length&&((s=y.filter(function(e){return e.id===n&&e.user===o.user})[0]).name=o.name,s.desc=o.desc,"area"==o.type?(s.area=o.area,s.distance=o.distance,s.path=o.path):s.distance=o.distance,async function(t,a){var n,e,o;"draw"!=t.type&&"marker"!=t.type&&((n=y.filter(function(e){return e.id===a&&e.user===t.user})[0]).completed=!0,e=L.marker(n.line.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"}),""!=n.trigger&&(e=n.trigger).unbindTooltip(),"line"==n.type?e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,closeOnClick:!1,autoclose:!1,bubblingMouseEvents:!0,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}):"area"==n.type&&(e.bindTooltip("<h1>"+n.name+"</h1><h2>"+n.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+n.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+n.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow tooltip-off",offset:L.point({x:-15,y:18})}),n.line.remove(),o=L.polygon(n.path,{color:n.color,pmIgnore:!1}).addTo(u),n.line=o),e.setOpacity(0),e.addTo(u),(n.trigger=e).getTooltip().update(),n.line.on("click",async function(e){var t,a;console.log(e),h||f||b?f?(e.target.pm.enable({}),e.target.on("pm:edit",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:t}).eq("id",n.id).select()})):b?e.target.on("pm:dragend",async e=>{console.log(e),console.log(Object.values(e.target.getLatLngs()[0]));var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));console.log(t);var{}=await _supabase.from("objects").update({area:n.area,distance:n.distance,path:t}).eq("id",n.id).select()}):(n.trigger.remove(),n.line.remove(),t=(await _supabase.from("coords").delete().eq("objects_id",n.id))["error"],a=(await _supabase.from("objects").delete().eq("id",n.id))["error"],y=$.grep(y,function(e){return e.id!=n.id}),$(".annotation-item[data-id='"+n.id+"']").remove()):(n.trigger.setLatLng(v),n.trigger.openTooltip(),$(n.trigger.getTooltip()._container).removeClass("tooltip-off"))}),n.line.on("tooltipclose",function(){$(".annotation-item[data-id="+n.id+"]").find(".annotation-name input").removeClass("annotation-focus")}),F(n))}(o,n))}async function ue(){var e=(await _supabase.from("rooms").select().eq("id",T))["data"],e=(t=e[0].name,o=e[0].description,$("#map-name").val(t),$("#map-description").val(o),$("#share-nav span").html("Share "+t),await _supabase.from("users").select().eq("room",T))["data"];0!=e.length&&e.forEach(function(e,t){pe(k,e.id)});const a=(await _supabase.from("objects").select(`
            *,
            coords (
              lat,lng
            )
          `).eq("room",T))["data"];0!=a.length&&Object.values(a).forEach(function(e,t){me(e,a[t].id)}),_supabase.channel("public:rooms").on("postgres_changes",{event:"*",schema:"public",table:"rooms"},e=>{e.new.id==T&&(t=e.new.name,o=e.new.description,$("#map-name").val(t),$("#map-description").val(o))}).subscribe(),_supabase.channel("public:users").on("postgres_changes",{event:"INSERT",schema:"public",table:"users"},e=>{console.log("insert users Change received!",e),e.new.room==T&&pe(e.new,e.new.id)}).subscribe(),_supabase.channel("public:users").on("postgres_changes",{event:"UPDATE",schema:"public",table:"users"},e=>{e.new.room==T&&pe(e.new,e.new.id)}).subscribe(),_supabase.channel("public:objects").on("postgres_changes",{event:"*",schema:"public",table:"objects"},async e=>{if(null!=e.new){const o=(await _supabase.from("objects").select(`
                *,
                coords (
                  lat,lng
                )
              `).eq("room",T))["data"];y.forEach(async function(t){var a;t.completed&&(a=[],o.forEach(function(e,t){a.push(e.id)}),-1==$.inArray(t.id,a))&&(("draw"==t.type?t.line:(("marker"==t.type?t.marker:(t.trigger.remove(),t.local?t.layer:t.line)).remove(),$(".annotation-item[data-id='"+t.id+"']"))).remove(),y=$.grep(y,function(e){return e.id!=t.id}))}),0!=Object.keys(o).length&&o.forEach(function(e,t){e.user!=E.id&&(me(e,o[t].id),async function(t,a){var o;"draw"!=t.type&&"line"!=t.type&&"area"!=t.type||0<y.filter(function(e){return e.id===a&&e.user===t.user}).length&&(o=[],Object.values(t.coords).forEach(function(e){o.push([e.lat,e.lng])}),y.filter(function(e){return e.id===a&&e.user===t.user})[0].line.setLatLngs(o))}(e,o[t].id))})}}).subscribe()}function ge(){$("#overlay").hasClass("sign-show")&&$(".sign-show").removeClass("sign-show")}S.closeTooltip(),u.on("pm:drawstart",async({workingLayer:e})=>{S.openTooltip(),S.setTooltipContent("Click to place first vertex"),e.on("pm:vertexadded",async a=>{var e,t,o;"Polygon"==a.shape?(S.setTooltipContent("Click on first vertex to finish"),l=a.layer._latlngs[a.layer._latlngs.length-1],1==a.layer._latlngs.length?({data:t,error:e}=await _supabase.from("objects").insert({room:T,color:m,initlat:a.layer._latlngs[0].lat,initlng:a.layer._latlngs[0].lng,user:E.id,type:"area",session:c,name:"Area",desc:"",distance:0,area:0,completed:!1,path:[]}).select("id"),(w=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:l.lat,lng:l.lng}))["error"],y.push({id:w,local:!0,color:m,user:E.id,name:"Area",desc:"",trigger:"",distance:0,area:0,layer:"",type:"area",session:c,completed:!1})):(await _supabase.from("coords").insert({objects_id:w,lat:l.lat,lng:l.lng}))["error"]):"Line"==a.shape&&(r=!0,p=0,l=a.layer._latlngs[a.layer._latlngs.length-1],1==a.layer._latlngs.length?({data:t,error:o}=await _supabase.from("objects").insert({room:T,color:m,initlat:a.layer._latlngs[0].lat,initlng:a.layer._latlngs[0].lng,user:E.id,type:"line",session:c,name:"Line",desc:"",distance:0,completed:!1,path:[]}).select("id"),(w=t[0].id,await _supabase.from("coords").insert({objects_id:t[0].id,lat:l.lat,lng:l.lng}))["error"],y.push({id:w,local:!0,color:m,user:E.id,name:"Line",desc:"",trigger:"",distance:0,layer:"",type:"line",session:c,completed:!1})):(a.layer._latlngs.forEach(function(e,t){0!=t&&(p+=a.layer._latlngs[t-1].distanceTo(e))}),S.setTooltipContent(p/1e3+"km | Double click to finish"),(await _supabase.from("coords").insert({objects_id:w,lat:l.lat,lng:l.lng}))["error"]))})}),u.on("pm:drawend",e=>{r=!1,S.closeTooltip(),P()}),u.on("pm:create",async e=>{var a,t,o,n,i,s,r,l,c,d,p,m;"Rectangle"===e.shape&&1==W?(a=N($("#tilezoom").val()),dowladmap=!1,(geojsonLayer=e.layer).addTo(u),t=e.layer.getBounds()._northEast,o=e.layer.getBounds()._southWest,n=_$().LatLongToPixelXY(t.lat,t.lng,a),i=_$().LatLongToPixelXY(o.lat,o.lng,a),new Promise(function(e,t){e(async function(e,t,a){if(console.log("图片数量约："+(Math.round((t.X-e.X)/256)+1)*(Math.round((e.Y-t.Y)/256)+1)+"张。"),30<(Math.round((t.X-e.X)/256)+1)*(Math.round((e.Y-t.Y)/256)+1))console.log("图片数量超过30张，请重新选择范围或降低级别！");else for(var o=0,n=e.X;n<=t.X;n+=256){V[o]=new Array;for(var i=0,s=t.Y;s<=e.Y;s+=256){tilexy=_$().PixelXYToTileXY(n,s),quadkey=_$().toQuadKey(tilexy.X,tilexy.Y,a);var r=j._url.replace("{subdomain}",j.subdomains[parseInt(4*Math.random())]);await async function(a,o){var n=3*Math.random();return new Promise(function(e,t){setTimeout(function(){console.log("请求中..."),console.log(a,o,new Date),fetch(a).then(e=>e.blob()).then(e=>{var t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=o,t.click()}),e("resolve return")},1e3*n)})}(r=r.replace("{quadkey}",quadkey),n+"-"+s+".jpeg"),V[o][i]=n+"-"+s+".jpeg",i++}o++}}(i,n,a))}).finally(function(){var e=document.createElement("a"),t=new Blob([JSON.stringify(V)],{type:"application/json"});e.href=URL.createObjectURL(t),e.download="urlList",e.click()})):"Text"==e.shape?console.log(e):(g=!0,(s=y.filter(function(e){return e.id===w&&e.user===E.id})[0]).distance=parseFloat(turf.length(e.layer.toGeoJSON()).toFixed(2)),s.layer=e.layer,"area"==s.type?(s.area=parseFloat((1e-6*turf.area(e.layer.toGeoJSON())).toFixed(2)),c=[],{data:r,error:l}=(Object.values(e.layer.getLatLngs()[0]).forEach(function(e){c.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:c,area:s.area}).eq("id",w).select())):"line"==s.type&&(c=[],{data:d,error:p}=(Object.values(e.layer.getLatLngs()).forEach(function(e){c.push([Object.values(e)[0],Object.values(e)[1]])}),await _supabase.from("objects").update({path:c}).eq("id",w).select())),(m=L.marker(e.layer.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="'+s.name+'" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),m.setOpacity(0),m.addTo(u),m.openTooltip(),$("#shape-name").focus(),$("#shape-name").select(),s.trigger=m,e.layer.on("click",async function(e){var t,a;h||f||b?f?(e.target.pm.enable({allowSelfIntsersection:!1}),e.target.on("pm:edit",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:s.area,distance:s.distance,path:t}).eq("id",s.id).select()})):b?e.target.on("pm:dragend",async e=>{var t=[];if("Line"==e.shape)for(var a in e.target.getLatLngs())t.push(Object.values(e.target.getLatLngs()[a]));else if("Polygon"==e.shape)for(var o in e.target.getLatLngs()[0])t.push(Object.values(e.target.getLatLngs()[0][o]));var{}=await _supabase.from("objects").update({area:s.area,distance:s.distance,path:t}).eq("id",s.id).select()}):(s.trigger.remove(),e.layer.remove(),t=(await _supabase.from("coords").delete().eq("objects_id",s.id))["error"],a=(await _supabase.from("objects").delete().eq("id",s.id))["error"],y=$.grep(y,function(e){return e.id!=s.id}),$(".annotation-item[data-id='"+s.id+"']").remove()):(m.setLatLng(v),m.openTooltip())}),m.on("tooltipclose",function(e){g&&A(),$(".annotation-item[data-id="+s.id+"]").find(".annotation-name input").removeClass("annotation-focus")}))}),u.addEventListener("mousedown",async e=>{X=!0;var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;v=[t,e],s&&se(t,e,E)}),u.addEventListener("click",async e=>{var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;v=[t,e],async function(e,t,a){var o,n,i,s;J&&(P(),n=L.divIcon({html:'<svg width="30" height="30" viewBox="0 0 46 46" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M23 44.0833C23 44.0833 40.25 32.5833 40.25 19.1666C40.25 14.5916 38.4326 10.204 35.1976 6.96903C31.9626 3.73403 27.575 1.91663 23 1.91663C18.425 1.91663 14.0374 3.73403 10.8024 6.96903C7.56741 10.204 5.75 14.5916 5.75 19.1666C5.75 32.5833 23 44.0833 23 44.0833ZM28.75 19.1666C28.75 22.3423 26.1756 24.9166 23 24.9166C19.8244 24.9166 17.25 22.3423 17.25 19.1666C17.25 15.991 19.8244 13.4166 23 13.4166C26.1756 13.4166 28.75 15.991 28.75 19.1666Z" fill="'+m+'"/>/svg>',iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]}),{data:n,error:i}=((o=L.marker([e,t],{icon:n,direction:"top",interactive:!0,pane:"overlayPane",pmIgnore:!1})).bindTooltip('<label for="shape-name">Name</label><input value="Marker" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:0,y:-35})}),o.addTo(u),o.openTooltip(),await _supabase.from("objects").insert({room:T,color:m,lat:e,lng:t,user:a.id,type:"marker",m_type:"none",session:c,name:"Marker",desc:""}).select("id")),s=w=n[0].id,y.push({id:w,user:a.id,color:m,name:"Marker",m_type:"none",desc:"",lat:e,lng:t,marker:o,trigger:o,session:c,completed:!0,type:"marker"}),o.on("tooltipclose",function(e){g?A():$(".annotation-item[data-id="+s+"]").find(".annotation-name input").removeClass("annotation-focus")}),o.on("click",async function(e){var t;h||b?b?e.target.on("pm:dragend",async e=>{console.log(e.target._latlng.lat);var{}=await _supabase.from("objects").update({lat:e.target._latlng.lat,lng:e.target._latlng.lng}).eq("id",inst.id).select()}):(o.remove(),t=(await _supabase.from("objects").delete().eq("id",inst.id))["error"],y=$.grep(y,function(e){return e.id!=s})):o.openTooltip()}))}(t,e,E),s&&se(t,e,E)}),u.addEventListener("mouseup",e=>{X=!1}),u.addEventListener("mousemove",async e=>{var t=Math.round(1e5*e.latlng.lat)/1e5,e=Math.round(1e5*e.latlng.lng)/1e5;v=[t,e],S.setLatLng([t,e]),X&&s&&(y.filter(function(e){return e.id===w&&e.user===E.id})[0].line.addLatLng([t,e]),(await _supabase.from("coords").insert({objects_id:w,lat:t,lng:e}))["error"]),r&&S.setTooltipContent(((p+l.distanceTo([t,e]))/1e3).toFixed(2)+"km | Double click to finish")}),u.addEventListener("zoom",async e=>{var{}=await _supabase.from("users").update({view:[u.getBounds().getCenter().lat,u.getBounds().getCenter().lng],zoom:u.getZoom()}).eq("uid",E.id).select();q()}),u.addEventListener("movestart",e=>{0}),u.addEventListener("moveend",e=>{0}),$(document).keyup(function(e){$(e.target).is("input")||$(e.target).is("textarea")||("Escape"===e.key?O():"Enter"===e.key?a?le():n&&ce():86==e.which?P():80==e.which?Q():69==e.which?ee():77==e.which?te():76==e.which?oe():65==e.which&&ae())});var B=L.Util.template("https://dev.virtualearth.net/REST/v1/Imagery/Metadata/{imagerySet}?key={bingMapsKey}&include=ImageryProviders&uriScheme=https&c={culture}",{bingMapsKey:D,imagerySet:"Aerial",culture:"en-US"}),ve=5e3,he="callback";function fe(t){try{delete window[t]}catch(e){window[t]=void 0}}function be(e){e=document.getElementById(e);document.getElementsByTagName("head")[0].removeChild(e)}_fetch=function(n){var i=void 0===arguments[1]?{}:arguments[1],s=null!=i.timeout?i.timeout:ve,r=null!=i.jsonpCallback?i.jsonpCallback:he,l=void 0;return new Promise(function(t,e){var a=i.jsonpCallbackFunction||"jsonp_"+Date.now()+"_"+Math.ceil(1e5*Math.random()),o=(window[a]=function(e){t({ok:!0,json:function(){return Promise.resolve(e)}}),l&&clearTimeout(l),be(r+"_"+a),fe(a)},n+=-1===n.indexOf("?")?"?":"&",document.createElement("script"));o.setAttribute("src",n+r+"="+a),o.id=r+"_"+a,document.getElementsByTagName("head")[0].appendChild(o),l=setTimeout(function(){e(new Error("JSONP request to "+n+" timed out")),fe(a),be(r+"_"+a)},s)})}(B,{jsonpCallback:"jsonp"}).then(function(e){return e.json()}).then(function(e){if(200!==e.statusCode)throw new Error("Bing Imagery Metadata error: \n"+JSON.stringify(e,null,"  "));e=e.resourceSets[0].resources[0];return j._url=e.imageUrl,j._imageryProviders=e.imageryProviders||[],j.subdomains=e.imageUrlSubdomains,j}).catch(console.error),$(document).on("click",function(e){$("#more-menu").hasClass("menu-show")&&"more-vertical"!=$(e.target).attr("id")&&"more-vertical"!=$(e.target).parent().attr("id")&&$("#more-menu").removeClass("menu-show")}),$(document).on("click","#pen-tool",Q),$(document).on("click","#cursor-tool",P),$(document).on("click","#eraser-tool",ee),$(document).on("click","#marker-tool",te),$(document).on("click","#area-tool",ae),$(document).on("click","#path-tool",oe),$(document).on("click",".color",function(e){e.stopPropagation(),m=$(this).attr("data-color"),$("#inner-color").css({background:m}),ne()}),$(document).on("click","#inner-color",ne),$(document).on("mouseover",".tool",function(){"cursor-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Move (V)</div>'):"pen-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Pencil (P)</div>'):"eraser-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Eraser (E)</div>'):"marker-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Marker (M)</div>'):"area-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Area (A)</div>'):"path-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Line (L)</div>'):"edit-tool"==$(this).attr("id")?$(this).append('<div id="tooltip">Edit (ED)</div>'):"drag-tool"==$(this).attr("id")&&$(this).append('<div id="tooltip">Drag (D)</div>')}),$(document).on("mouseout",".tool",function(){$(this).find("#tooltip").remove()}),$(document).on("click",".save-button",async function(e){g=!1;var t,a,o,n,i,s,r=y.filter(function(e){return e.id===w&&e.user===E.id})[0];r.name=N($("#shape-name").val()),r.desc=N($("#shape-desc").val()),r.completed=!0,r.trigger.unbindTooltip(),"area"==r.type?(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/area-icon.svg">'+r.area+' km&sup2;</h3></div><div class="shape-data"><h3><img src="/static/supa-mapus/assets/perimeter-icon.svg">'+r.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:t,error:a}=await _supabase.from("objects").update({area:r.area,distance:r.distance,name:r.name,desc:r.desc,completed:!0}).eq("id",w).select()):"line"==r.type?(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/distance-icon.svg">'+r.distance+' km</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:-15,y:18})}),{data:o,error:n}=await _supabase.from("objects").update({distance:r.distance,name:r.name,desc:r.desc,completed:!0}).eq("id",w).select()):"marker"==r.type&&(r.trigger.bindTooltip("<h1>"+r.name+"</h1><h2>"+r.desc+'</h2><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+r.lat.toFixed(5)+", "+r.lng.toFixed(5)+'</h3></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),{data:i,error:s}=await _supabase.from("objects").update({name:r.name,desc:r.desc,completed:!0}).eq("id",w).select()),F(r),$(".annotation-item[data-id='"+r.id+"']").find(".annotation-name input").addClass("annotation-focus"),window.setTimeout(function(){r.trigger.openTooltip()},200)}),$(document).on("click",".cancel-button",A),$(document).on("click",".avatars",async function(){var t=$(this).attr("data-id");t!=E.id&&(d.id==t?q():(d.status=!0,d.id=t,$("#outline").css({border:"6px solid "+k.find(e=>e.id===t).color}),$("#observing-name").html("Observing "+k.find(e=>e.id===t).name),$("#observing-name").css({background:k.find(e=>e.id===t).color}),$("#outline").addClass("observing")))}),$(document).on("click",".annotation-arrow",function(e){e.preventDefault(),e.stopPropagation(),$(this).hasClass("arrow-open")?($(this).removeClass("arrow-open"),$(this).parent().parent().find(".annotation-details").addClass("annotation-closed")):($(this).addClass("arrow-open"),$(this).parent().parent().find(".annotation-details").removeClass("annotation-closed"))}),$(document).on("click",".annotation-item",function(){if(I(),!$(this).find(".annotation-name input").hasClass("annotation-focus")){const t=$(this).attr("data-id");i=t;var e=$.grep(y,function(e){return e.id==t})[0];$(".annotation-focus").removeClass("annotation-focus"),$(".annotation-description-focus").removeClass("annotation-description-focus"),u.eachLayer(function(e){"markerPane"!=e.options.pane&&e.closeTooltip()}),$(this).find(".annotation-name input").addClass("annotation-focus"),$(this).find(".annotation-details input").addClass("annotation-description-focus"),"line"==e.type||"area"==e.type?(u.panTo(e.trigger.getLatLng()),$(e.trigger.getTooltip()._container).removeClass("tooltip-off"),e.trigger.openTooltip()):"marker"==e.type&&(u.panTo(e.marker.getLatLng()),$(e.marker.getTooltip()._container).removeClass("tooltip-off"),e.marker.openTooltip())}}),$(document).on("click",".room-item",function(){var e=$(this).attr("data-id");window.location="/mapus?file="+e}),$(document).on("mouseup",".annotation-focus",function(){console.log("开始编辑"),$(".annotation-focus").select(),$(".annotation-focus").addClass("map-editing"),$(".annotation-focus").prop("disabled",!1)}),$(document).on("focusout",".annotation-focus",async function(){$(".annotation-focus").prop("disabled",!0),$(".annotation-focus").removeClass("map-editing");var e=N($(".annotation-focus").val());console.log(e),0==e.length?$(".annotation-focus").val(Y):(await _supabase.from("objects").update({name:e}).eq("id",parseInt(i)))["error"]}),$(document).on("mouseup",".annotation-description-focus",function(){console.log("开始编辑"),$(".annotation-description-focus").select(),$(".annotation-description-focus").addClass("map-editing"),$(".annotation-description-focus").prop("disabled",!1)}),$(document).on("focusout",".annotation-description-focus",async function(){$(".annotation-description-focus").prop("disabled",!0),$(".annotation-description-focus").removeClass("map-editing");var e=N($(".annotation-description-focus").val());console.log(e),0==e.length?$(".annotation-description-focus").val(Y):(await _supabase.from("objects").update({desc:e}).eq("id",parseInt(i)))["error"]}),$(document).on("click",".delete-layer",async function(e){e.preventDefault(),e.stopPropagation();const t=$(this).parent().parent().attr("data-id"),a=$.grep(y,function(e){return e.id==t})[0];$(".annotation-item[data-id='"+t+"']").remove(),y="marker"!=a.type?(a.trigger.remove(),a.line.remove(),(await _supabase.from("coords").delete().eq("objects_id",a.id))["error"],(await _supabase.from("objects").delete().eq("id",a.id))["error"],$.grep(y,function(e){return e.id!=a.id})):(a.marker.remove(),(await _supabase.from("objects").delete().eq("id",a.id))["error"],$.grep(y,function(e){return e.id!=a.id}))}),$(document).on("mousedown","#map-name",async function(e){3!=e.which||a||(G=t,a=!0,$("#map-name").prop("disabled",!1),$("#map-name").addClass("map-editing"))}),$(document).on("mouseup","#map-name",function(){$("#map-name").select(),$("#map-name").addClass("map-editing"),$("#map-name").prop("disabled",!1)}),$(document).on("focusout","#map-name",le),$(document).on("mousedown","#map-description",async function(){n||(R=o,n=!0,$("#map-description").prop("disabled",!1),$("#map-description").addClass("map-editing"))}),$(document).on("mouseup","#map-description",function(){$("#map-description").select(),$("#map-description").addClass("map-editing")}),$(document).on("focusout","#map-description",ce),$(document).on("click","#hide-annotations",function(){$("#hide-annotations").hasClass("hidden-annotations")?I():($(".leaflet-overlay-pane").css({visibility:"hidden","pointer-events":"none"}),$(".leaflet-tooltip-pane").css({visibility:"hidden","pointer-events":"none"}),$("#hide-annotations").addClass("hidden-annotations"),$("#hide-annotations").html("Show all"))}),$(document).on("click","#location-control",function e(){q(),navigator.geolocation&&(""!=C?navigator.geolocation.getCurrentPosition(function(e){C.setLatLng([e.coords.latitude,e.coords.longitude]),u.flyTo(C.getLatLng(),18)}):(K(),e()))}),$(document).on("click",".find-nearby",async function(){var o=$(this).attr("data-type"),n=$(this).attr("data-color"),e=u.getBounds().getNorthWest().lng+","+u.getBounds().getNorthWest().lat+","+u.getBounds().getSouthEast().lng+","+u.getBounds().getSouthEast().lat;$.get("https://nominatim.openstreetmap.org/search?viewbox="+e+"&format=geocodejson&limit=20&bounded=1&amenity="+o+"&exclude_place_ids="+JSON.stringify(x),function(e){var a=L.icon({iconUrl:"/static/supa-mapus/assets/"+o+"-marker.svg",iconSize:[30,30],iconAnchor:[15,30],shadowAnchor:[4,62],popupAnchor:[-3,-76]});e.features.forEach(function(e){var t=L.marker([e.geometry.coordinates[1],e.geometry.coordinates[0]],{icon:a,pane:"overlayPane",interactive:!0,pmIgnore:!1}).addTo(u);t.bindTooltip("<h1>"+e.properties.geocoding.name+'</h1><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.geometry.coordinates[1].toFixed(5)+", "+e.geometry.coordinates[0].toFixed(5)+'</h3></div><br><div id="buttons2"><button class="cancel-button-place" data-id='+e.properties.geocoding.place_id+'>Remove</button><button class="save-button-place" data-id='+e.properties.geocoding.place_id+'>Save</button></div><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})}),_.push({id:"",place_id:e.properties.geocoding.place_id,user:E.id,name:e.properties.geocoding.name,desc:"",lat:e.geometry.coordinates[1],lng:e.geometry.coordinates[0],trigger:t,completed:!0,marker:t,m_type:o,type:"marker",session:c,color:n}),x.push(e.properties.geocoding.place_id)})})}),$(document).on("click",".save-button-place",async function(){var e=_.find(e=>e.place_id==$(this).attr("data-id")),t=(await _supabase.from("objects").insert({color:e.color,place_id:e.place_id,lat:e.lat,lng:e.lng,user:E.id,type:"marker",m_type:e.m_type,session:c,name:e.name,desc:""}).select("id"))["data"];w=t[0].id,e.id=w,y.push(e),e.marker.bindTooltip("<h1>"+e.name+'</h1><div class="shape-data"><h3><img src="/static/supa-mapus/assets/marker-small-icon.svg">'+e.lat.toFixed(5)+", "+e.lng.toFixed(5)+'</h3></div><br><div class="arrow-down"></div>',{permanent:!1,direction:"top",interactive:!1,bubblingMouseEvents:!1,className:"create-shape-flow",offset:L.point({x:0,y:-35})})}),$(document).on("click",".cancel-button-place",function(){var t=_.find(e=>e.place_id==$(this).attr("data-id"));t.marker.remove(),_=$.grep(_,function(e){return e.place_id!=t.id}),x=$.grep(x,function(e){return e!=t.id})}),$(document).on("click","#more-vertical",function(){$("#more-menu").hasClass("menu-show")?$("#more-menu").removeClass("menu-show"):$("#more-menu").addClass("menu-show")}),$(document).on("click","#geojson",function(){var t=new L.FeatureGroup,e=(u.addLayer(t),u.eachLayer(function(e){(e instanceof L.Marker||e instanceof L.Polyline||e instanceof L.Polygon)&&e.addTo(t)}),document.createElement("a")),a=new Blob([JSON.stringify(t.toGeoJSON())],{type:"application/json"});e.href=URL.createObjectURL(a),e.download="geojson",e.click()}),$(document).on("click","#search-box img",ie),$(document).on("click","#google-signin-2",async function(){var e=N($("#email").val()),t=N($("#password").val());const a=(await _supabase.auth.signInWithPassword({email:e,password:t}))["error"];null==a&&ge();e=(await _supabase.auth.getUser()).data.user;if(E=e,M.has("file")){$(".signin").removeClass("signin");var o,n,t=H[Math.floor(Math.random()*H.length)],e=(await _supabase.from("users").select().eq("uid",E.id))["data"];0==e.length?{data:o,error:n}=await _supabase.from("users").insert({room:T,uid:E.id,lat:0,lng:0,active:!0,color:t,name:E.email,view:[u.getBounds().getCenter().lat,u.getBounds().getCenter().lng],zoom:u.getZoom()}).select("id"):(await _supabase.from("users").update({lat:0,lng:0,active:!0,color:t,name:E.email,view:[u.getBounds().getCenter().lat,u.getBounds().getCenter().lng],zoom:u.getZoom()}).eq("uid",E.id))["error"],window.setTimeout(async function(){var e=(await _supabase.from("users").select().eq("uid",E.id))["data"];c=e.session},100),ue()}else{const{data:i,error:a}=await _supabase.from("rooms").select();console.log("data",i),i.forEach(function(e,t){$("#room-list").prepend('<div class="room-item" data-id="'+e.id+'"><div class="annotation-name"><img class="annotation-arrow" src="/static/supa-mapus/assets/arrow.svg"> <input value='+e.name+' disabled><img class="delete-layer" src="/static/supa-mapus/assets/delete.svg"></div><div class="annotation-details annotation-closed"><input value='+e.description+' disabled class="annotation-description"></div></div>')}),$("#sign").removeClass("signin"),$("#popup").find(".header-text").html("Create a map"),$("#popup").find(".subheader-text").html("Maps can be shared with friends to collaborate in real-time."),$("#google-signin").attr("id","create-map"),$(".create-map").html("Create a map"),$("#popup").addClass("signin")}}),$(document).on("click","#create-map",async function(){var e=(e=(await _supabase.from("rooms").insert({name:"New map",description:"Map description"}).select("id"))["data"])[0].id;window.location.replace(window.location.href+"?file="+e)}),$(document).on("click","#logout",async function(){var{}=await _supabase.auth.signOut().then(function(){$("#popup").addClass("signin"),$("#overlay").addClass("signin")})}),$(document).on("click","#share-button",function(){$("#share").addClass("share-show"),$("#overlay").addClass("share-show")}),$(document).on("click","#overlay",de),$(document).on("click","#close-share",de),$(document).on("click","#share-copy",function(){$("#share-url").focus(),$("#share-url").select(),document.execCommand("copy")}),$(document).on("click","#zoom-in",function(){u.zoomIn()}),$(document).on("click","#zoom-out",function(){u.zoomOut()}),$(document).on("click","#sign-button",function(){$("#sign").addClass("sign-show"),$("#overlay").addClass("sign-show")}),$(document).on("click","#close-sign",ge),$(document).on("click","#importgeojson",function(){$('<input type="file" value="选择文件"></input>').click().on("change",e=>{e=e.target.files[0];let t=new FileReader;t.onload=()=>{var e=t.result;!async function(l){var a={radius:8,fillColor:"#ff7800",color:m,weight:1,opacity:1,fillOpacity:.8};L.geoJSON(l.features,{pointToLayer:function(e,t){return L.circleMarker(t,a)},pmIgnore:!1}).addTo(u),l.features.forEach(async function(o,e){var n,t,a,i,s,r;"LineString"==o.geometry.type&&(n=[],t="",a="line",r=o.geometry.coordinates.length,{data:s,error:i}=(o.geometry.coordinates.forEach(function(e,t){var a;0!=t&&(t=L.latLng(o.geometry.coordinates[t-1][1],o.geometry.coordinates[t-1][0]),a=L.latLng(e[1],e[0]),p+=t.distanceTo(a)),n.push([e[1],e[0]])}),o.properties.description&&(t=o.properties.description),l.name&&(a=l.name),l.name&&o.properties.Layer&&(a=l.name+"-"+o.properties.Layer),await _supabase.from("objects").insert({room:T,color:m,initlat:o.geometry.coordinates[0][1],initlng:o.geometry.coordinates[0][0],user:E.id,type:"line",session:c,name:a,desc:t,distance:parseFloat((p/1e3).toFixed(3)),completed:!0,path:n}).select("id")),(w=s[0].id,await _supabase.from("coords").insert({objects_id:s[0].id,lat:o.geometry.coordinates[r-1][1],lng:o.geometry.coordinates[r-1][0]}))["error"],y.push({id:w,local:!0,color:m,user:E.id,name:a,desc:t,trigger:"",distance:parseFloat((p/1e3).toFixed(3)),layer:"",type:"line",session:c,completed:!0}),g=!0,s=y.filter(function(e){return e.id===w&&e.user===E.id})[0],(r=L.marker(u.getBounds().getCenter(),{zIndexOffset:9999,interactive:!1,pane:"overlayPane"})).bindTooltip('<label for="shape-name">Name</label><input value="Line" id="shape-name" name="shape-name" /><label for="shape-desc">Description</label><textarea id="shape-desc" name="description"></textarea><br><div id="buttons"><button class="cancel-button">Cancel</button><button class="save-button">Save</button></div><div class="arrow-down"></div>',{permanent:!0,direction:"top",interactive:!0,bubblingMouseEvents:!1,className:"create-shape-flow create-form",offset:L.point({x:-15,y:18})}),$("#shape-name").focus(),$("#shape-name").select(),s.trigger=r,h||f||b||(r.setLatLng(v),r.openTooltip()),r.on("tooltipclose",function(e){g&&A(),$(".annotation-item[data-id="+w+"]").find(".annotation-name input").removeClass("annotation-focus")}))})}(JSON.parse(e))},t.readAsText(e,"UTF-8")})}),$(document).on("click","#xmltogeojson",function(){$('<input type="file" value="选择文件"></input>').click().on("change",e=>{e=e.target.files[0];let c=new FileReader;c.onload=()=>{var e=c.result.split(/\r\n|\n/);let t="";e.map(e=>{e.length&&!e.startsWith(";")&&(-1!==e.indexOf("<Placemark")&&(t+="{"),t+=e,-1!==e.indexOf("</Placemark"))&&(t+="}")});var a,o=t.split("}"),n={type:"FeatureCollection",features:[]},i={type:"FeatureCollection",features:[]};for(let e=0;e<o.length-2;e++)if(o[e].split("<Placemark")[1]){var s=o[e].split("<coordinates>")[1].split("</coordinates>")[0].split(/ |,/),r=[];for(let e=0;e<s.length;e+=1)""!=s[e]&&""!=s[e+1]&&""!=s[e+2]&&r.push([Number(s[e]),Number(s[e+1]),Number(s[e+2])]);n.features.push({type:"Feature",geometry:{type:"LineString",coordinates:r},properties:{measure:o[e].split("<Placemark")[1].split('">')[0]}})}for(let e=0;e<o.length;e++)o[e].split("<Placemark")[1]&&(a=o[e].split("<coordinates>")[1].split("</coordinates>")[0].split(","),i.features.push({type:"Feature",geometry:{type:"Point",coordinates:[Number(a[0]),Number(a[1])]},properties:{measure:o[e].split("<Placemark")[1].split('">')[0]}}));var e=document.createElement("a"),l=new Blob([JSON.stringify(n)],{type:"application/json"});e.href=URL.createObjectURL(l),e.download="geojson",e.click()},c.readAsText(e,"UTF-8")})}),$(document).on("click","#downloadmap",function(){W=!0,$("#chooseTileZoom").addClass("chooseTileZoom-show"),$("#overlay").addClass("chooseTileZoom-show")}),$(document).on("click","#close-choosetilezoom",function(){$("#overlay").hasClass("chooseTileZoom-show")&&$(".chooseTileZoom-show").removeClass("chooseTileZoom-show"),u.pm.disableDraw()}),$(document).on("click","#draw-rectangle",function(){$("#chooseTileZoom").removeClass("chooseTileZoom-show"),$("#overlay").removeClass("chooseTileZoom-show"),u.pm.enableDraw("Rectangle",{finishOn:"dblclick",allowSelfIntersection:!1,tooltips:!1})}),$(document).on("click","#edit-tool",function(){O(),f=!0,$(".tool-active").removeClass("tool-active"),$("#edit-tool").addClass("tool-active"),I()}),$(document).on("click","#drag-tool",function(){O(),b=!0,$(".tool-active").removeClass("tool-active"),$("#drag-tool").addClass("tool-active"),u.pm._globalDragModeEnabled||u.pm.toggleGlobalDragMode(),I()}),$(document).on("keydown","#search-input",function(e){"Enter"===e.key&&ie()}),$("img[src='https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png']").remove(),K()});